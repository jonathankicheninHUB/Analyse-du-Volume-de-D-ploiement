<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur √âconomique Dawn of Victory (R√©el - Live Alcor)</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuration de la police Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fond sombre pour un th√®me financier/gaming */
        }
        .card {
            background-color: #161b22;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.5);
            border: 1px solid #30363d;
        }
        .input-style {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #ffffff;
        }
        .input-readonly {
            background-color: #24292f; /* Darker background for calculated field */
            color: #90ee90; /* Light green for calculated values */
        }
        .result-label {
            color: #9e9e9e;
        }
        .result-value {
            font-weight: 700;
            color: #c9d1d9;
        }
        /* Style du Toggler de prix (OBSOL√àTE, MAIS LAISS√â POUR LE LOOK SI R√âUTILIS√â) */
        #labelModeUsd.active, #labelModeWax.active {
            background-color: #3f6212; /* lime-900/50 */
            color: #d9f99d; /* lime-200 */
        }
        #labelModeUsd:not(.active), #labelModeWax:not(.active) {
            background-color: transparent;
            color: #9ca3af;
        }

        /* Animation pour le chargement AI et Arbitrage */
        @keyframes pulse-purple {
            0%, 100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); }
        }
        .ai-loading {
            animation: pulse-purple 2s infinite;
        }
        /* Styles pour le tableau des b√¢timents */
        .rarity-commun { color: #9ca3af; }
        .rarity-rare { color: #3b82f6; }
        .rarity-epic { color: #a855f7; }
        .rarity-legendary { color: #eab308; }
        .rarity-supreme { color: #ef4444; text-shadow: 0 0 5px rgba(239, 68, 68, 0.5); }
        
        /* Animation pour le sniper */
        @keyframes scan-line {
            0% { top: 0; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        .scan-overlay {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: #eab308;
            box-shadow: 0 0 10px #eab308;
            animation: scan-line 2s linear infinite;
            display: none;
        }
        .scanning .scan-overlay {
            display: block;
        }
        /* Style des r√©glettes */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px; 
            height: 16px;
            border-radius: 50%;
            background: #eab308; /* Yellow/Amber color */
            cursor: pointer;
            box-shadow: 0 0 5px rgba(234, 179, 8, 0.7);
            margin-top: -7px; /* Correction d'alignement pour Chrome */
        }

        /* Styles sp√©cifiques au widget MoonPay */
        #moonpayWidgetContainer {
            min-height: 500px;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -4px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="text-white p-4 sm:p-8 min-h-screen flex justify-center items-start">

    <div id="app" class="w-full max-w-5xl space-y-8 mt-10 relative">

        <h1 class="text-3xl font-bold text-center text-teal-400 mb-2">
            Analyse du Volume de D√©ploiement Multi-Comptes <span class="text-yellow-400">(Simulateur Manuel)</span>
        </h1>

        <!-- NOUVELLE SECTION PROFESSIONNELLE - BANDEAU HAUT -->
        <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700 text-center shadow-md mb-8">
            <p class="text-sm text-gray-400 font-semibold uppercase tracking-wider">
                Outil d'Analyse Strat√©gique et de Simulation √âconomique Interne
            </p>
            <p class="text-xs text-red-400 mt-1 italic">
                Ceci est une projection th√©orique. Les donn√©es en temps r√©el (AtomicHub, Alcor) sont utilis√©es sans garantie.
            </p>
        </div>
        <!-- FIN BANDEAU HAUT -->

        <!-- CONTENU DU SIMULATEUR (maintenant directement visible) -->
        
        <!-- Section des Param√®tres d'Entr√©e -->
        <div class="card p-6 rounded-xl space-y-6">
            <h2 class="text-xl font-semibold border-b border-gray-700 pb-3 text-blue-300">
                1. Param√®tres d'Entr√©e (Prix & Configuration)
            </h2>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                
                <!-- Nombre de Comptes -->
                <div>
                    <label for="numberOfAccounts" class="block text-sm font-medium result-label">Nombre de Comptes</label>
                    <input type="number" id="numberOfAccounts" value="1" min="1" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" inputmode="numeric">
                </div>

                <!-- Divisions par Compte (D√©ploy√©es) -->
                <div>
                    <label for="divisionsPerAccount" class="block text-sm font-medium result-label">Divisions par Compte (D√©ploy√©es)</label>
                    <input type="number" id="divisionsPerAccount" value="3" min="1" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" inputmode="numeric">
                </div>
                
                <!-- S√©lecteur de Zone (pour le Volume) -->
                <div>
                    <label for="zoneSelector" class="block text-sm font-medium result-label">S√©lectionner la Zone de D√©ploiement (Volume)</label>
                    <select id="zoneSelector" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-teal-500 focus:border-teal-500 appearance-none">
                        <!-- Options seront remplies par JS -->
                    </select>
                </div>
                
                <!-- Prix WAX/USD (AVEC BOUTON LIVE COINGECKO) -->
                <div>
                    <label for="priceWaxUsd" class="block text-sm font-medium result-label mb-1">Prix d'un WAX en USD ($)</label>
                    <div class="flex space-x-2">
                        <input type="text" id="priceWaxUsd" value="0,05" class="input-style block w-full p-2.5 rounded-lg focus:ring-pink-500 focus:border-pink-500" inputmode="decimal">
                        <button id="btnFetchPrice" class="bg-pink-900/40 hover:bg-pink-700 text-pink-300 border border-pink-700 font-bold px-3 rounded-lg transition-colors text-xs flex items-center justify-center whitespace-nowrap" title="R√©cup√©rer prix actuel">
                            üîÑ Live
                        </button>
                    </div>
                </div>
            </div>

            <!-- Investment Packs and Price (VOLUME) -->
            <div class="border-t border-gray-800 pt-4">
                <h3 class="text-sm font-medium result-label mb-3 text-lime-300 flex items-center justify-between">
                    <span>Volume de Packs Achet√©s (Base pour Sections 2-7)</span>
                    <!-- Indicateur du prix principal (WAX) -->
                    <span class="text-xs text-gray-400">Prix Principal en WAX (USD calcul√©)</span>
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Nombre de Packs -->
                    <div>
                        <label for="numberOfPacks" class="block text-sm font-medium result-label">Nombre de Packs Achet√©s (Volume)</label>
                        <input type="number" id="numberOfPacks" value="1" min="0" max="100" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-lime-500 focus:border-lime-500" inputmode="numeric">
                    </div>

                    <!-- Divisions par Pack (Utilis√© pour le volume et le design du Pack) -->
                    <div>
                        <label for="divisionsPerPack" class="block text-sm font-medium result-label">Divisions par Pack Design√©/Achet√©</label>
                        <input type="number" id="divisionsPerPack" value="10" min="0" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-lime-500 focus:border-lime-500" inputmode="numeric">
                    </div>
                    
                    <!-- Prix par Pack (WAX) - CHAMP WAX -->
                    <div>
                        <label for="pricePerPackWax" class="block text-sm font-medium result-label">Prix par Pack (en WAX)</label>
                        <input type="text" id="pricePerPackWax" value="1000,00" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-lime-500 focus:border-lime-500" inputmode="decimal">
                    </div>
                    
                    <!-- Le champ USD a √©t√© retir√©. -->
                </div>
                
                <!-- Total Divisions Achet√©es (NOUVEL AFFICHAGE) -->
                <div class="mt-4 p-3 bg-indigo-900/30 rounded-lg border border-indigo-700">
                    <p class="text-sm result-label">Total Divisions Achet√©es (Capacit√©)</p>
                    <p id="resultTotalDivisionsPurchased" class="text-xl mt-1 text-indigo-300 font-bold">--</p>
                </div>
            </div>
            
            <!-- NOUVEAU: Entr√©e Manuelle des Prix des Jetons (R√âGLETTE UNIQUE DOVX) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 border-t border-gray-800 pt-4">
                
                <!-- PRIX DOVX/WAX (Contr√¥le Primaire) -->
                <div class="lg:col-span-2 p-3 bg-gray-900/50 rounded-lg">
                    <label for="priceDovXManual" class="block text-sm font-medium text-green-400 mb-2">1. Prix d'un DOVX en WAX (R√©compense)</label>
                    <!-- VALEUR INITIALE BAS√âE SUR LA R√âF√âRENCE UTILISATEUR: 0.00528552 WAX -->
                    <input type="text" id="priceDovXManual" value="0,00528552" class="input-style block w-full p-2.5 rounded-lg text-green-400 font-bold text-lg" inputmode="decimal" step="0.00000001">
                    <!-- MAX MONT√â √Ä 1.00 WAX -->
                    <input type="range" id="dovxPriceSlider" min="0.00000000" max="1.00000000" step="0.00000001" value="0.00528552" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg mt-3">
                    <p class="text-xs text-gray-400 mt-1">Plage: 0 WAX √† 1.00 WAX (8 d√©cimales) - Ajuster la r√©glette</p>
                </div>
                
                <!-- PRIX TU/WAX (Calcul√© par Ratio) -->
                <div class="p-3 bg-gray-900/50 rounded-lg border-l-4 border-red-500/50">
                    <label for="priceCostTokenCalculated" class="block text-sm font-medium text-red-400 mb-2">2. Prix d'un TU en WAX (Ratio Calcul√©)</label>
                    <!-- VALEUR INITIALE BAS√âE SUR LA R√âF√âRENCE UTILISATEUR: 0.00045262 WAX -->
                    <input type="text" id="priceCostTokenCalculated" value="0,00045262" readonly class="input-style block w-full p-2.5 rounded-lg text-red-400 font-bold text-lg bg-red-900/20" title="Calcul√©: DOVX / Ratio" inputmode="decimal">
                    <p id="ratioDisplay" class="text-xs text-gray-400 mt-1">Ratio appliqu√©: DOVX / 11.6783100 (bas√© sur 0.00528552 / 0.00045262)</p>
                </div>
            </div>

        </div>

        <!-- Section des R√©sultats en WAX -->
        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-semibold border-b border-gray-700 pb-3 text-purple-300 mb-6">
                2. Volume de 24h en WAX (Total pour toutes les divisions)
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

                <!-- Co√ªt Total WAX (Demande) - MISE √Ä JOUR POUR LE CO√õT UNITAIRE WAX TU -->
                <div class="p-3 bg-red-900/30 rounded-lg">
                    <p class="text-sm result-label">Co√ªt Total (Demande)</p>
                    <p id="resultCost" class="text-2xl mt-1 text-red-400 result-value flex flex-col items-start">
                        <span id="totalWaxCostValue">--</span>
                        <span id="unitCostWaxValue" class="text-sm font-normal text-gray-400 mt-1">"Unitaire TU: --"</span>
                    </p>
                </div>

                <!-- R√©compense Totale WAX (Offre) -->
                <div class="p-3 bg-green-900/30 rounded-lg">
                    <p class="text-sm result-label">R√©compense Totale (Offre DOVX)</p>
                    <p id="resultReward" class="text-2xl mt-1 text-green-400 result-value">--</p>
                </div>

                <!-- Marge Nette WAX -->
                <div class="p-3 bg-gray-800 rounded-lg">
                    <p class="text-sm result-label">Marge/D√©ficit Nette (WAX)</p>
                    <p id="resultNet" class="text-2xl mt-1 result-value">--</p>
                </div>

                <!-- Volume Transactionnel Total WAX -->
                <div class="p-3 bg-blue-900/30 rounded-lg">
                    <p class="text-sm result-label">Volume Transactionnel Total (24h)</p>
                    <p id="resultVolume" class="text-2xl mt-1 text-blue-400 result-value">--</p>
                </div>
            </div>
        </div>

        <!-- Section des R√©sultats en USD (Journalier) -->
        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-semibold border-b border-gray-700 pb-3 text-pink-300 mb-6">
                3. Volume de 24h en USD (Total pour toutes les divisions)
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <!-- Co√ªt Total USD -->
                <div class="p-3 bg-red-900/30 rounded-lg">
                    <p class="text-sm result-label">Co√ªt Total (Demande)</p>
                    <p id="resultUsdCost" class="text-2xl mt-1 text-red-400 result-value">--</p>
                </div>

                <!-- R√©compense Totale USD -->
                <div class="p-3 bg-green-900/30 rounded-lg">
                    <p class="text-sm result-label">R√©compense Totale (Offre DOVX)</p>
                    <p id="resultUsdReward" class="text-2xl mt-1 text-green-400 result-value">--</p>
                </div>

                <!-- Volume Transactionnel Total USD (24h) -->
                <div class="p-3 bg-blue-900/30 rounded-lg">
                    <p class="text-sm result-label">Volume Transactionnel Total</p>
                    <p id="resultUsdVolume" class="text-2xl mt-1 text-blue-400 result-value">--</p>
                </div>
            </div>
            
            <!-- Marge Nette USD (Affiche seule pour bien la mettre en √©vidence) -->
            <div class="mt-6 pt-4 border-t border-gray-700">
                <p class="text-sm result-label">Marge/D√©ficit Nette (USD $)</p>
                <p id="resultNetUsd" class="text-3xl mt-1 result-value">--</p>
            </div>
        </div>

        <!-- Section des Projections (Mensuel & Annuel) -->
        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-semibold border-b border-gray-700 pb-3 text-fuchsia-300 mb-6">
                4. Projections en USD (Mois & Ann√©e)
            </h2 >

            <!-- LIGNE 1: Marge Nette -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Marge Nette Mensuelle USD -->
                <div class="p-4 bg-gray-900 rounded-lg border border-teal-700">
                    <p class="text-sm result-label">Marge Nette Mensuelle (USD $)</p>
                    <p id="resultNetUsdMonthly" class="text-3xl mt-1 result-value text-teal-400">--</p>
                </div>
                <!-- Marge Nette Annuelle USD -->
                <div class="p-4 bg-gray-900 rounded-lg border border-teal-700">
                    <p class="text-sm result-label">Marge Nette Annuelle (USD $)</p>
                    <p id="resultNetUsdAnnual" class="text-3xl mt-1 result-value text-teal-400">--</p>
                </div>
            </div>

            <!-- LIGNE 2: Volume Total -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-gray-800 pt-6">
                <!-- Volume Mensuel USD -->
                <div class="p-4 bg-gray-900 rounded-lg border border-fuchsia-700">
                    <p class="text-sm result-label">Volume Transactionnel Mensuel (USD $)</p>
                    <p id="resultUsdVolumeMonthly" class="text-3xl mt-1 text-fuchsia-400 result-value">--</p>
                </div>

                <!-- Volume Annuel USD -->
                <div class="p-4 bg-gray-900 rounded-lg border border-fuchsia-700">
                    <p class="text-sm result-label">Volume Transactionnel Annuel (USD $)</p>
                    <p id="resultUsdVolumeAnnual" class="text-3xl mt-1 text-fuchsia-400 result-value">--</p>
                </div>
            </div>
        </div>
        
        <!-- Section ROI et Break-Even (Volume) -->
        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-semibold border-b border-gray-700 pb-3 text-lime-300 mb-6">
                5. Analyse de l'Investissement & ROI du Volume
            </h2>

            <!-- ROI EN POURCENTAGE -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- ROI Journalier (%) -->
                <div class="p-4 bg-gray-900 rounded-lg border border-yellow-700">
                    <p class="text-sm result-label">Rendement Journalier (ROI %) sur Investissement Total</p>
                    <p id="resultRoiDailyPercent" class="text-3xl mt-1 result-value text-yellow-400">--</p>
                </div>
                <!-- ROI Mensuel (%) -->
                <div class="p-4 bg-gray-900 rounded-lg border border-yellow-700">
                    <p class="text-sm result-label">Rendement Mensuel (ROI %) sur Investissement Total</p>
                    <p id="resultRoiMonthlyPercent" class="text-3xl mt-1 result-value text-yellow-400">--</p>
                </div>
            </div>

            <!-- Jours pour Break-Even & Statut -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-t border-gray-800 pt-6">

                <!-- Investissement Initial Total WAX -->
                <div class="p-3 bg-gray-900/50 rounded-lg border border-gray-600">
                    <p class="text-sm result-label">Investissement Initial Total (WAX)</p>
                    <p id="resultTotalInvestment" class="text-2xl mt-1 text-lime-400 result-value">--</p>
                </div>

                <!-- Jours pour atteindre le ROI (Break-Even) -->
                <div class="p-3 bg-gray-900/50 rounded-lg border border-gray-600">
                    <p class="text-sm result-label">Jours pour atteindre le ROI (Break-Even)</p>
                    <p id="resultRoiDays" class="text-2xl mt-1 text-lime-400 result-value">--</p>
                </div>

                <!-- Statut du ROI -->
                <div class="p-3 bg-gray-900/50 rounded-lg border border-gray-600">
                    <p class="text-sm result-label">Statut du ROI</p>
                    <p id="resultRoiStatus" class="text-2xl mt-1 result-value">--</p>
                </div>

            </div>
        </div>


        <!-- SECTION Consommation Nominale des Jetons de Co√ªt -->
        <div class="card p-6 rounded-xl">
            <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-indigo-300">
                6. Consommation D√©taill√©e des Jetons de Co√ªt (TU)
            </h3>
            
            <p class="text-sm text-gray-400 mt-2 mb-4">
                D√©tail de la consommation unitaire (par division) et projection totale journali√®re (pour **toutes** les divisions).
            </p>

            <div class="overflow-x-auto mb-6">
                <table class="min-w-full divide-y divide-gray-700 text-sm">
                    <thead>
                        <tr class="text-left text-gray-400 bg-gray-800/50">
                            <th class="p-3 font-medium">Jeton de Co√ªt</th>
                            <th class="p-3 font-medium text-right">Unit√©s TU (par 1 Division)</th>
                            <th class="p-3 font-medium text-right text-red-300">Total TU (Journalier)</th>
                            <th class="p-3 font-medium text-right">Co√ªt WAX (par 1 Division)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800" id="consumptionTableBody">
                        <!-- Les lignes de donn√©es seront ins√©r√©es ici par JS -->
                    </tbody>
                    <tfoot>
                        <tr class="border-t border-yellow-500/50 bg-gray-800 font-bold">
                            <td class="p-3 text-yellow-300" colspan="3">TOTAL (Toutes Divisions/24h)</td>
                            <td class="p-3 text-right text-yellow-300" id="totalUnitsConsumedBase">--</td>
                            <td class="p-3 text-right text-yellow-300" id="totalUnitsConsumedDailySum">--</td>
                            <td class="p-3 text-right text-yellow-300" id="totalWaxCostBase">--</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Totaux Consommation Journali√®re -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-700 pt-4">
                
                <div class="p-4 bg-red-900/40 rounded-lg">
                    <p class="text-sm font-bold text-gray-300">Consommation Totale TU (Journali√®re)</p>
                    <p id="totalUnitsConsumedDaily" class="text-2xl mt-1 text-red-300 font-extrabold">--</p>
                    <p class="text-xs text-gray-400 mt-1">Total TU requis pour tous les d√©ploiements.</p>
                </div>

                <div class="p-4 bg-red-900/40 rounded-lg">
                    <p class="text-sm font-bold text-gray-300">Co√ªt Total WAX (Journalier)</p>
                    <p id="totalWaxCostDaily" class="text-2xl mt-1 text-red-300 font-extrabold">--</p>
                    <p class="text-xs text-gray-400 mt-1">Co√ªt WAX √©quivalent du besoin en TU.</p>
                </div>
            </div>

            <!-- Indicateurs pour une seule division (Non multipli√©s) -->
            <div class="mt-6 pt-4 border-t border-gray-800">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                    <div class="text-sm">
                        <span class="font-bold text-gray-400">Unit√©s DOVX g√©n√©r√©es (par Division):</span>
                        <span id="unitsDovXGenerated" class="text-white ml-2">--</span>
                    </div>
                    <div class="text-sm">
                        <span class="font-bold text-gray-400">Ratio d'Hyper-Amplification ($DOVX$ / Co√ªt Unitaire TU):</span>
                        <span id="ratioAmplification" class="text-lg text-green-500 font-extrabold ml-2">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 7: R√âPARTITION DES REVENUS DES PACKS (Volume) -->
        <div class="card p-6 rounded-xl">
            <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-yellow-300">
                7. R√©partition des Revenus de Vente des Packs (Volume)
            </h3>
            
            <p class="text-sm text-gray-400 mt-2 mb-4">
                Distribution de l'Investissement Total du **Volume** ($30\% Cash Back$, $30\% Team$, $30\% Market Token$, $10\% Pub$).
            </p>

            <!-- LIGNE 1: Totaux de l'Investissement -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 pt-4 border-t border-gray-800">
                <div class="p-3 bg-gray-900/50 rounded-lg border border-gray-600">
                    <p class="text-sm result-label">Investissement Total USD</p>
                    <p id="totalInvestmentUsdDisplay" class="text-2xl mt-1 text-lime-300 font-bold">--</p>
                </div>
                <div class="p-3 bg-gray-900/50 rounded-lg border border-gray-600">
                    <p class="text-sm result-label">Investissement Total WAX</p>
                    <!-- CORRECTION DE L'ID ici : l'ID original √©tait 'totalInvestmentWaxDisplay' dans le JS, mais ce bloc l'a √©cras√©. On le renomme pour unicit√©. -->
                    <p id="totalInvestmentWaxDisplay" class="text-2xl mt-1 text-lime-300 font-bold">--</p>
                </div>
            </div>

            <!-- LIGNE 2: R√©partition D√©taill√©e -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                
                <!-- Cash Back (30%) -->
                <div class="p-3 bg-blue-900/30 rounded-lg">
                    <p class="text-sm font-bold text-blue-300">Cash Back (30%)</p>
                    <p id="cashBackUsd" class="text-xl mt-1 text-white">--</p>
                    <p id="cashBackWax" class="text-xs text-blue-200">--</p>
                </div>

                <!-- Team (30%) -->
                <div class="p-3 bg-purple-900/30 rounded-lg">
                    <p class="text-sm font-bold text-purple-300">Team (30%)</p>
                    <p id="teamUsd" class="text-xl mt-1 text-white">--</p>
                    <p id="teamWax" class="text-xs text-purple-200">--</p>
                </div>

                <!-- Market Token (30%) -->
                <div class="p-3 bg-pink-900/30 rounded-lg">
                    <p class="text-sm font-bold text-pink-300">Market Token (30%)</p>
                    <p id="marketTokenUsd" class="text-xl mt-1 text-white">--</p>
                    <p id="marketTokenWax" class="text-xs text-pink-200">--</p>
                </div>

                <!-- Pub (10%) -->
                <div class="p-3 bg-amber-900/30 rounded-lg">
                    <p class="text-sm font-bold text-amber-300">Pub (10%)</p>
                    <p id="pubUsd" class="text-xl mt-1 text-white">--</p>
                    <p id="pubWax" class="text-xs text-amber-200">--</p>
                </div>
            </div>
        </div>

        <!-- Section 8: OUTIL DE CR√âATION ET ROI DES PACKS -->
        <div class="card p-6 rounded-xl border-4 border-dashed border-teal-500/50">
            <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-teal-400 flex items-center justify-between">
                <span>8. Outil de Cr√©ation et ROI d'un Pack Design√©</span>
                <button id="btnAiLore" class="text-sm bg-teal-600/20 hover:bg-teal-600/40 text-teal-300 py-1 px-3 rounded border border-teal-500/50 transition-colors flex items-center space-x-1">
                    <span>‚ú® IA: G√©n√©rer Lore</span>
                </button>
            </h3>
            
            <p class="text-sm text-gray-400 mt-2 mb-4">
                Calcule le ROI et la r√©partition d'un **seul pack** bas√© sur sa composition (Divisions) et sa zone de Staking.
            </p>
            
            <div id="aiLoreOutput" class="hidden mb-4 p-3 bg-teal-900/20 border-l-2 border-teal-500 text-gray-300 text-sm italic">
                <!-- Lore IA ici -->
            </div>

            <!-- ENTR√âES DU PACK DESIGN√â -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t border-gray-800 pt-4">
                
                <div>
                    <label for="packName" class="block text-sm font-medium text-teal-300">Nom du Pack</label>
                    <input type="text" id="packName" value="Pack Alpha" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                </div>
                
                <div>
                    <label for="packDesignPriceUsd" class="block text-sm font-medium text-teal-300">Prix du Pack (USD $)</label>
                    <input type="text" id="packDesignPriceUsd" value="50,00" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-teal-500 focus:border-teal-500" inputmode="decimal">
                </div>

                <div>
                    <label for="packDesignZoneSelector" class="block text-sm font-medium text-teal-300">Zone de Staking (ROI)</label>
                    <select id="packDesignZoneSelector" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-teal-500 focus:border-teal-500 appearance-none">
                        <!-- Options seront remplies par JS (identiques au s√©lecteur de volume) -->
                    </select>
                </div>
            </div>

            <div class="mt-4">
                <label for="packComposition" class="block text-sm font-medium text-teal-300">Composition (Cartes NFT)</label>
                <textarea id="packComposition" rows="2" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-teal-500 focus:border-teal-500">1x Commander Lvl 1, 10x Division Tokens, 5x Rations</textarea>
            </div>


            <!-- R√âSULTATS ROI ET CASH BACK DU PACK DESIGN√â -->
            <div class="mt-8">
                <h4 class="text-lg font-semibold text-pink-300 border-b border-gray-700 pb-2 mb-4">
                    ROI et Marge d'un Pack (Unitaire)
                </h4>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    
                    <!-- Marge Nette USD Journali√®re -->
                    <div class="p-3 bg-gray-800 rounded-lg border border-pink-700">
                        <p class="text-sm result-label">Marge Nette Journali√®re (USD $)</p>
                        <p id="designPackNetUsd" class="text-xl mt-1 result-value text-pink-400">--</p>
                    </div>

                    <!-- ROI Journalier (%) -->
                    <div class="p-3 bg-gray-800 rounded-lg border border-pink-700">
                        <p class="text-sm result-label">ROI Journalier (%)</p>
                        <p id="designPackRoiDaily" class="text-xl mt-1 result-value text-pink-400">--</p>
                    </div>
                    
                    <!-- Jours pour Break-Even -->
                    <div class="p-3 bg-gray-800 rounded-lg border border-pink-700">
                        <p class="text-sm result-label">Jours pour Break-Even</p>
                        <p id="designPackRoiDays" class="text-xl mt-1 result-value text-pink-400">--</p>
                    </div>

                </div>
            </div>

            <!-- R√âPARTITION DU CASH BACK (30%) -->
            <div class="mt-8">
                <h4 class="text-lg font-semibold text-blue-300 border-b border-gray-700 pb-2 mb-4">
                    R√©partition du Cash Back (30% de la Vente du Pack)
                </h4>
                <div class="grid grid-cols-2 gap-4 lg:grid-cols-4">
                    
                    <!-- Cash Back (USD) -->
                    <div class="p-3 bg-blue-900/30 rounded-lg">
                        <p class="text-sm font-bold text-blue-300">Cash Back (USD $)</p>
                        <p id="designPackCashBackUsd" class="text-xl mt-1 text-white">--</p>
                    </div>

                    <!-- Cash Back (WAX) -->
                    <div class="p-3 bg-blue-900/30 rounded-lg">
                        <p class="text-sm font-bold text-blue-300">Cash Back (WAX)</p>
                        <p id="designPackCashBackWax" class="text-xl mt-1 text-white">--</p>
                    </div>
                    
                    <!-- Prix Pack (WAX) -->
                    <div class="p-3 bg-gray-900/50 rounded-lg">
                        <p class="text-sm font-bold text-gray-400">Prix Pack (WAX)</p>
                        <p id="designPackPriceWax" class="text-xl mt-1 text-lime-400">--</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- SECTION 9: SIMULATEUR PRODUCTION BATIMENTS -->
        <div class="card p-6 rounded-xl border border-orange-500/30">
            <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-orange-400 flex items-center justify-between">
                <div class="flex flex-col sm:flex-row sm:items-center">
                    <span class="flex items-center"><span class="mr-2">üè≠</span> 9. Simulateur de Production des B√¢timents (TU)</span>
                    <!-- RAPPEL DES TAUX UTILIS√âS -->
                    <span id="section9RatesDisplay" class="ml-0 sm:ml-4 mt-1 sm:mt-0 text-xs font-normal text-orange-200/60 bg-orange-900/20 px-2 py-0.5 rounded border border-orange-500/20">
                        (Taux: --)
                    </span>
                </div>
                <!-- FILTRE AJOUT√â -->
                <div class="relative ml-4">
                    <select id="buildingTypeFilter" class="bg-gray-800 border border-gray-600 text-xs rounded p-1 text-orange-200 focus:outline-none focus:border-orange-500">
                        <option value="ALL">Tous les B√¢timents</option>
                        <option value="DOV-F">Fuel Refinery (DOV-F)</option>
                        <option value="DOV-H">Health Factory (DOV-H)</option>
                        <option value="DOV-R">Repair Factory (DOV-R)</option>
                        <option value="DOV-S">Supply Factory (DOV-S)</option>
                    </select>
                </div>
            </h3>
            
            <p class="text-sm text-gray-400 mt-2 mb-4">
                Calculez le rendement (ROI) de vos b√¢timents de production de TU (Fuel, Health, Repair, Supply).
                <br><span class="text-xs text-orange-300/70">Donn√©es bas√©es sur les co√ªts standards (Communs √† Supr√™mes).</span>
            </p>

            <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-700 text-sm">
                    <thead class="sticky top-0 z-10">
                        <tr class="text-left bg-gray-800 text-gray-300 shadow-sm">
                            <th class="p-3">B√¢timent (Raret√©/Niveau)</th>
                            <th class="p-3 text-right">Co√ªt DOVX/h (Fixe)</th>
                            <th class="p-3 text-right text-blue-300">Co√ªt WAX/24h (Dyn)</th>
                            <th class="p-3 text-right">Prod TU/24h</th>
                            <th class="p-3 text-right text-green-300">Revenu WAX/24h</th>
                            <th class="p-3 text-right text-green-400">Marge WAX/24h</th>
                            <th class="p-3 text-right text-green-400">Gain Net $ Mois</th>
                            <th class="p-3 text-center">Qt√©</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800" id="buildingsTableBody">
                        <!-- Rempli par JS -->
                    </tbody>
                    <tfoot class="bg-gray-900/90 font-bold border-t border-orange-500/30 sticky bottom-0 z-10">
                        <tr>
                            <td class="p-3 text-orange-300" colspan="3">TOTAL PROD UTILISATEUR (Qt√© > 0)</td>
                            <td class="p-3 text-right text-orange-300" id="userTotalTuDaily">0</td>
                            <td class="p-3 text-right text-green-400" id="userTotalRevenueWax">0 WAX</td>
                            <td class="p-3 text-right text-green-400" id="userTotalMarginWax">0 WAX</td>
                            <td class="p-3 text-right text-green-400" id="userTotalRevenueUsdMonthly">0 $</td>
                            <td class="p-3"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- SECTION 10: CONNEXION WALLET & AUDIT -->
        <div class="card p-6 rounded-xl border border-cyan-500/30 mt-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-cyan-500/50"></div>
            <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-cyan-400 flex items-center mb-4">
                <span class="mr-2">üíº</span> 10. Connexion Wallet & Audit d'Actifs (Mode R√©el)
            </h3>
            
            <p class="text-sm text-gray-400 mb-6">
                Connectez votre WAX Cloud Wallet pour lister automatiquement vos cartes de b√¢timents (NFTs) et calculer vos gains mensuels r√©els bas√©s sur les prix actuels du march√©.
                <br><span class="text-xs text-cyan-300/60 italic">*Ceci utilise l'API AtomicAssets (connect√©e au r√©seau WAX) pour la collection <strong>dovdivisions</strong>.*</span>
            </p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="md:col-span-2">
                    <label for="walletAddressInput" class="block text-sm font-medium text-cyan-300 mb-1">Adresse Wallet WAX</label>
                    <div class="flex space-x-2">
                        <input type="text" id="walletAddressInput" placeholder="ex: user.wam" class="input-style block w-full p-2.5 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                        <button id="btnScanWallet" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg transition-all duration-200 whitespace-nowrap">
                            Scanner le Portefeuille
                        </button>
                    </div>
                </div>
            </div>

            <!-- RESULTATS DU SCAN -->
            <div id="walletResultsContainer" class="hidden animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- R√©sum√© Actifs -->
                    <div class="p-4 bg-gray-900/80 rounded-lg border border-cyan-700/50">
                        <p class="text-sm text-gray-400">Total B√¢timents D√©tect√©s</p>
                        <p id="walletTotalBuildings" class="text-2xl mt-1 text-cyan-300 font-bold">--</p>
                    </div>
                    <!-- Revenu Mensuel WAX -->
                    <div class="p-4 bg-gray-900/80 rounded-lg border border-cyan-700/50">
                        <p class="text-sm text-gray-400">Revenu Net Mensuel (WAX)</p>
                        <p id="walletMonthlyWax" class="text-2xl mt-1 text-green-400 font-bold">--</p>
                    </div>
                    <!-- Revenu Mensuel USD -->
                    <div class="p-4 bg-gray-900/80 rounded-lg border border-green-700/50 relative overflow-hidden">
                        <div class="absolute -right-6 -top-6 w-16 h-16 bg-green-500/20 rounded-full blur-xl"></div>
                        <p class="text-sm text-gray-400">Revenu Net Mensuel ($ USD)</p>
                        <p id="walletMonthlyUsd" class="text-3xl mt-1 text-green-400 font-extrabold">--</p>
                    </div>
                </div>
                
                <!-- NOUVEAU: R√âSUM√â SC√âNARIO -->
                <div id="walletScenarioSummary" class="mb-6 p-4 bg-blue-900/20 rounded-lg border border-blue-500/30 text-sm text-blue-200 shadow-sm">
                    <!-- Rempli par JS -->
                </div>

                <!-- Liste d√©taill√©e -->
                <h4 class="text-md font-semibold text-gray-300 mb-3 border-b border-gray-800 pb-2">D√©tail des Actifs D√©tenus</h4>
                <div class="overflow-x-auto max-h-[300px] overflow-y-auto bg-gray-900/50 rounded-lg border border-gray-700">
                    <table class="min-w-full divide-y divide-gray-800 text-sm">
                        <thead class="bg-gray-800 text-gray-400 sticky top-0">
                            <tr>
                                <th class="p-3 text-left">Nom du B√¢timent (NFT)</th>
                                <th class="p-3 text-center">Quantit√©</th>
                                <th class="p-3 text-right text-green-300">Gain/Mois ($)</th>
                            </tr>
                        </thead>
                        <tbody id="walletAssetsBody" class="divide-y divide-gray-800/50 text-gray-300">
                            <!-- Rempli par JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NOUVELLE SECTION 11: CR√âATEUR DE PACK B√ÇTIMENTS -->
        <div class="card p-6 rounded-xl border border-emerald-500/30 mt-8 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-1 h-full bg-emerald-500/50"></div>
            <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-emerald-400 flex items-center mb-4">
                <span class="mr-2">üèóÔ∏è</span> 11. Cr√©ateur de Pack B√¢timent & Outil (Simulator)
            </h3>
            
            <p class="text-sm text-gray-400 mb-6">
                Concevez un pack personnalis√© contenant des b√¢timents et un outil d'am√©lioration de la production (Multiplicateur).
                Analysez imm√©diatement la rentabilit√© pour un investisseur potentiel.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Choix du B√¢timent -->
                <div>
                    <label for="packBuildingSelect" class="block text-sm font-medium result-label">Type de B√¢timent</label>
                    <select id="packBuildingSelect" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 appearance-none text-sm">
                        <!-- Rempli par JS -->
                    </select>
                </div>
                <!-- Quantit√© -->
                <div>
                    <label for="packBuildingQty" class="block text-sm font-medium result-label">Quantit√© de B√¢timents</label>
                    <input type="number" id="packBuildingQty" value="1" min="1" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" inputmode="numeric">
                </div>
                <!-- Multiplicateur -->
                <div>
                    <label for="packToolMultiplier" class="block text-sm font-medium result-label">Multiplicateur Outil (ex: 1.1 = +10%)</label>
                    <input type="number" id="packToolMultiplier" value="1.00" step="0.01" min="1.00" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" inputmode="decimal">
                </div>
                <!-- Prix du Pack -->
                <div>
                    <label for="packBuildingPrice" class="block text-sm font-medium result-label">Prix Vente du Pack ($ USD)</label>
                    <input type="number" id="packBuildingPrice" value="50.00" step="0.01" min="0" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" inputmode="decimal">
                </div>
            </div>

            <!-- R√âSULTATS DU PACK -->
            <div class="bg-emerald-900/10 rounded-xl p-4 border border-emerald-500/20">
                <h4 class="text-emerald-300 font-semibold mb-4 border-b border-emerald-500/20 pb-2">Analyse de Rentabilit√© du Pack</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Production Boost√©e -->
                    <div>
                        <p class="text-xs text-gray-400">Production Totale Journali√®re (Boost√©e)</p>
                        <p id="packBuildingProd" class="text-xl font-bold text-white mt-1">--</p>
                        <p class="text-xs text-gray-500" id="packBuildingProdBase">Base: --</p>
                    </div>

                    <!-- Co√ªt Op√©rationnel -->
                    <div>
                        <p class="text-xs text-gray-400">Co√ªt Fonctionnement Journalier</p>
                        <p id="packBuildingOpEx" class="text-xl font-bold text-red-300 mt-1">--</p>
                    </div>

                    <!-- Marge Mensuelle -->
                    <div>
                        <p class="text-xs text-gray-400">Rendement Mensuel Net ($)</p>
                        <p id="packBuildingMonthlyNet" class="text-2xl font-bold text-emerald-400 mt-1">--</p>
                    </div>

                    <!-- ROI -->
                    <div>
                        <p class="text-xs text-gray-400">ROI (Retour sur Investissement)</p>
                        <p id="packBuildingRoi" class="text-xl font-bold text-yellow-400 mt-1">--</p>
                        <p id="packBuildingRoiDays" class="text-xs text-gray-500">-- Jours</p>
                    </div>
                </div>
            </div>

            <!-- R√âPARTITION DU CASH BACK (30%) -->
            <div class="mt-8">
                <h4 class="text-lg font-semibold text-blue-300 border-b border-gray-700 pb-2 mb-4">
                    R√©partition du Cash Back (30% de la Vente du Pack)
                </h4>
                <div class="grid grid-cols-2 gap-4 lg:grid-cols-4">
                    
                    <!-- Cash Back (USD) -->
                    <div class="p-3 bg-blue-900/30 rounded-lg">
                        <p class="text-sm font-bold text-blue-300">Cash Back (USD $)</p>
                        <!-- CORRECTION D'ID : Ancien ID 'designPackCashBackUsd' est maintenant 'buildingPackCashBackUsd' -->
                        <p id="buildingPackCashBackUsd" class="text-xl mt-1 text-white">--</p>
                    </div>

                    <!-- Cash Back (WAX) -->
                    <div class="p-3 bg-blue-900/30 rounded-lg">
                        <p class="text-sm font-bold text-blue-300">Cash Back (WAX)</p>
                        <!-- CORRECTION D'ID : Ancien ID 'designPackCashBackWax' est maintenant 'buildingPackCashBackWax' -->
                        <p id="buildingPackCashBackWax" class="text-xl mt-1 text-white">--</p>
                    </div>
                    
                    <!-- Prix Pack (WAX) -->
                    <div class="p-3 bg-gray-900/50 rounded-lg">
                        <p class="text-sm font-bold text-gray-400">Prix Pack (WAX)</p>
                        <!-- CORRECTION D'ID : Ancien ID 'designPackPriceWax' est maintenant 'buildingPackPriceWax' -->
                        <p id="buildingPackPriceWax" class="text-xl mt-1 text-lime-400">--</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- SECTION 12: SNIPER DE MARCH√â (ATOMIC HUB) -->
        <div id="marketSniperSection" class="card p-6 rounded-xl border border-yellow-500/50 mt-8 relative overflow-hidden">
            <!-- Scan Effect Overlay -->
            <div id="scanOverlay" class="scan-overlay"></div>
            
            <div class="absolute top-0 right-0 w-16 h-16 bg-yellow-500/10 rounded-bl-full"></div>
            
            <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-yellow-400 flex items-center mb-4">
                <span class="mr-2">üéØ</span> 12. Sniper de March√© (AtomicHub Live Deals)
            </h3>
            
            <p class="text-sm text-gray-400 mb-6">
                Scannez le march√© AtomicHub en temps r√©el pour trouver les b√¢timents vendus en dessous de leur valeur de rendement.
                Le ROI est calcul√© avec vos param√®tres actuels (Prix Tokens & Co√ªts).
                <br><span class="text-xs text-yellow-300/60 italic">*Ceci utilise l'API AtomicMarket (connect√©e au r√©seau WAX) pour la collection <strong>dovdivisions</strong>.*</span>
            </p>

            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
                <button id="btnScanMarket" class="bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-3 px-8 rounded-lg transition-all duration-200 shadow-lg shadow-yellow-600/20 flex items-center justify-center">
                    <span class="mr-2">üîç</span> Scanner les Offres (ROI)
                </button>
                
                <div class="flex items-center space-x-2 bg-gray-900 px-4 py-2 rounded-lg border border-gray-700">
                    <span class="text-sm text-gray-400">Seuils Max ROI (Jours):</span>
                    <input type="number" id="marketRoiFilter" value="300" class="bg-transparent border-none text-yellow-400 font-bold w-16 focus:ring-0 text-right">
                </div>
            </div>

            <!-- RESULTATS DU SNIPER -->
            <div id="marketResultsContainer" class="hidden">
                <div class="overflow-x-auto max-h-[500px] overflow-y-auto bg-gray-900/50 rounded-lg border border-gray-700">
                    <table class="min-w-full divide-y divide-gray-800 text-sm">
                        <thead class="bg-gray-800 text-gray-400 sticky top-0 z-10 shadow-md">
                            <tr>
                                <th class="p-3 text-left">B√¢timent (Offre)</th>
                                <th class="p-3 text-right">Prix (WAX)</th>
                                <th class="p-3 text-right text-green-300">Rendement Net/Jour</th>
                                <th class="p-3 text-center text-yellow-300 font-bold">ROI (Jours)</th>
                                <th class="p-3 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="marketDealsBody" class="divide-y divide-gray-800/50 text-gray-300">
                            <!-- Rempli par JS -->
                        </tbody>
                    </table>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-right">*Les frais de march√© ne sont pas inclus. DYOR.</p>
            </div>
        </div>
        
        <!-- NOUVELLE SECTION 13: ARBITRAGE DOVX ET OUTIL LP -->
        <div id="unitSimulatorSection" class="card p-6 rounded-xl border border-purple-500/30 mt-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-purple-500/50"></div>
            <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-purple-400 flex items-center mb-4">
                <span class="mr-2">üìà</span> 13. Outil d'Arbitrage et de Liquidit√© (LP) DOVX
            </h3>
            
            <!-- SOUS-SECTION ARBITRAGE -->
            <h4 class="text-lg font-semibold text-gray-300 mt-4 mb-3">13.1 Analyse d'Arbitrage (Live Alcor)</h4>

            <p class="text-sm text-gray-400 mb-4">
                Comparez l'√©change direct DOVX/WAX (prix du march√©) avec l'√©change indirect DOVX -> [Autre Jeton] -> WAX.
                <br><span id="dovxCurrentWaxPriceDisplay" class="text-xs text-purple-300/60 italic font-semibold">*Prix DOVX/WAX actuel (Section 1): --*</span>
                <span class="text-xs text-red-300 italic block mt-1">**NOTE : Les prix sont r√©cup√©r√©s en temps r√©el via l'API Alcor Exchange.**</span>
            </p>

            <div class="mb-4">
                <button id="btnArbitrageScan" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-6 rounded-lg transition-all duration-200 shadow-lg shadow-purple-600/20 flex items-center justify-center text-sm">
                    <span class="mr-2">üîÑ</span> Analyser les Swaps (Arbitrage)
                </button>
            </div>

            <div class="overflow-x-auto mb-8">
                <table class="min-w-full divide-y divide-gray-700 text-sm">
                    <thead>
                        <tr class="text-left text-gray-400 bg-gray-800/50">
                            <th class="p-3">Paire de Swap</th>
                            <th class="p-3 text-right">Prix du Jeton Cible (en WAX)</th>
                            <th class="p-3 text-right text-purple-300">Valeur Implicite de 1 DOVX (en WAX)</th>
                            <th class="p-3 text-right text-yellow-300">Arbitrage / Gain (%)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800" id="swapAnalysisBody">
                        <!-- Rempli par JS -->
                    </tbody>
                </table>
            </div>

            <!-- SOUS-SECTION CALCULATEUR LP -->
            <h4 class="text-lg font-semibold text-gray-300 mt-4 mb-3 border-t border-gray-700 pt-4">13.2 Calculateur de D√©p√¥t de Liquidit√© (LP)</h4>
            <p class="text-sm text-gray-400 mb-4">
                Calculez les quantit√©s de jetons n√©cessaires pour cr√©er de nouveaux pools bas√©s sur les prix d√©finis en Section 1.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- Pool 1: DOVX / WAX -->
                <div class="p-4 bg-purple-900/30 rounded-lg border border-purple-700">
                    <h5 class="font-bold text-purple-300 mb-2">Pool A: DOVX / WAX</h5>
                    <label for="lpDovxWaxAmount" class="block text-xs text-gray-400">Montant de WAX √† d√©poser</label>
                    <input type="number" id="lpDovxWaxAmount" value="1000" min="0" class="input-style mt-1 block w-full p-2 rounded-lg focus:ring-purple-500" inputmode="numeric">
                    
                    <p class="text-sm mt-3 font-semibold">Quantit√© de DOVX Requise :</p>
                    <p id="lpDovxWaxRequired" class="text-xl text-white font-bold mt-1">--</p>
                    <p class="text-xs text-gray-400 italic">Prix DOVX Cible: 1 WAX = <span id="lpDovxWaxPriceSpan">--</span> DOVX</p>
                </div>

                <!-- Pool 2: TU / WAX -->
                <div class="p-4 bg-red-900/30 rounded-lg border border-red-700">
                    <h5 class="font-bold text-red-300 mb-2">Pool B: TU / WAX</h5>
                    <label for="lpTuWaxAmount" class="block text-xs text-gray-400">Montant de WAX √† d√©poser</label>
                    <input type="number" id="lpTuWaxAmount" value="1000" min="0" class="input-style mt-1 block w-full p-2 rounded-lg focus:ring-red-500" inputmode="numeric">
                    
                    <p class="text-sm mt-3 font-semibold">Quantit√© de TU Requise :</p>
                    <p id="lpTuWaxRequired" class="text-xl text-white font-bold mt-1">--</p>
                    <p class="text-xs text-gray-400 italic">Prix TU Cible: 1 WAX = <span id="lpTuWaxPriceSpan">--</span> TU</p>
                </div>

                <!-- Pool 3: DOVX / TU -->
                <div class="md:col-span-2 p-4 bg-teal-900/30 rounded-lg border border-teal-700">
                    <h5 class="font-bold text-teal-300 mb-2">Pool C: DOVX / TU (Lien √âconomique)</h5>
                    <label for="lpDovxTuAmount" class="block text-xs text-gray-400">Montant de DOVX √† d√©poser</label>
                    <input type="number" id="lpDovxTuAmount" value="100000" min="0" class="input-style mt-1 block w-full p-2 rounded-lg focus:ring-teal-500" inputmode="numeric">
                    
                    <p class="text-sm mt-3 font-semibold">Quantit√© de TU Requise :</p>
                    <p id="lpDovxTuRequired" class="text-xl text-white font-bold mt-1">--</p>
                    <p class="text-xs text-gray-400 italic">Prix TU Cible: 1 DOVX = <span id="lpDovxTuPriceSpan">--</span> TU</p>
                    <p class="text-xs text-gray-400 italic mt-2">Prix DOVX Cible: 1 TU = <span id="lpTuDovxPriceSpan">--</span> DOVX</p>
                </div>

            </div>
            
            <!-- NOUVELLE SOUS-SECTION 13.3: SUIVI DES PAIRES -->
            <h4 class="text-lg font-semibold text-gray-300 mt-8 mb-3 border-t border-gray-700 pt-4">13.3 Suivi des Paires de Trading sur Alcor</h4>
            
            <p class="text-sm text-gray-400 mb-4">
                Liste en temps r√©el de toutes les paires actives sur Alcor Exchange impliquant les jetons DOV.
            </p>
            
            <!-- Token Selection -->
            <div id="alcorTokenSelection" class="mb-4 flex flex-wrap gap-3">
                <!-- Buttons will be injected here -->
            </div>
            
            <!-- Live Data Table -->
            <div id="alcorPairsContainer" class="bg-slate-800/50 backdrop-blur-sm rounded-lg overflow-hidden border border-purple-500/20 min-h-[150px] relative">
                <div id="alcorPairsLoading" class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/70 z-10">
                    <svg class="animate-spin h-5 w-5 text-purple-400 mr-3" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" class="opacity-25"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-purple-200">Chargement des paires...</span>
                </div>
                <div id="alcorPairsTable" class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-purple-500/20 bg-slate-900/50">
                                <th class="px-6 py-3 text-left text-purple-200 font-semibold">Paire</th>
                                <th class="px-6 py-3 text-right text-purple-200 font-semibold">Prix</th>
                                <th class="px-6 py-3 text-right text-purple-200 font-semibold">Liquidit√© (USD)</th>
                                <th class="px-6 py-3 text-right text-purple-200 font-semibold">Vol. 24h (USD)</th>
                                <th class="px-6 py-3 text-center text-purple-200 font-semibold">Action</th>
                            </tr>
                        </thead>
                        <tbody id="alcorPairsBody">
                            <!-- Rempli par JS -->
                        </tbody>
                    </table>
                </div>
                <div id="alcorPairsError" class="hidden p-4 text-center text-red-400"></div>
                <div id="alcorPairsEmpty" class="hidden p-4 text-center text-gray-400">Aucune paire trouv√©e pour le jeton s√©lectionn√©.</div>
            </div>

        </div>

        <!-- NOUVELLE SECTION 14: WIDGET MOONPAY -->
        <div id="moonpaySection" class="card p-6 rounded-xl border border-lime-500/30 mt-8 relative overflow-hidden hidden">
            <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-lime-400 flex items-center mb-4">
                <span class="mr-2">üí≥</span> 14. Acheter du WAX (MoonPay Widget)
            </h3>
            
            <p class="text-sm text-gray-400 mb-6">
                Utilisez l'interface d'achat pour obtenir des jetons WAX directement avec votre carte bancaire, sans quitter le simulateur.
                <br><span class="text-xs text-red-400 italic">*Ceci est une int√©gration de d√©monstration (Sandbox). Remplacez la cl√© API pour le mode Production.*</span>
            </p>

            <div id="moonpayWidgetContainer" class="w-full">
                <!-- L'iframe MoonPay sera inject√© ici par JS -->
            </div>
        </div>


        <div class="text-xs text-gray-500 text-center pt-4 pb-8">
            *Les co√ªts de combat sont bas√©s sur la colonne 'Combat Cost' et sont divis√©s par 4 pour les quatre jetons de co√ªt distincts (DOV-H, R, S, F).
        </div>
        
        <!-- NOUVELLE SECTION PROFESSIONNELLE - FOOTER / DISCLAIMER -->
        <div class="mt-12 pt-8 border-t border-gray-700">
            <footer class="text-center text-gray-500 text-xs space-y-3">
                <div class="font-bold text-gray-400">
                    Avertissement & Mentions L√©gales
                </div>
                <p>
                    Ceci est un outil de simulation analytique et ne constitue en aucun cas un conseil financier, d'investissement ou l√©gal.
                    Les performances pass√©es ne pr√©jugent pas des r√©sultats futurs.
                </p>
                <p>
                    L'utilisateur est seul responsable de ses d√©cisions d'investissement et de trading sur la blockchain WAX. 
                    Les prix des jetons (DOVX, TU) et du WAX/USD sont des variables hautement volatiles.
                </p>
                <p>
                    Droits d'Auteur ¬© 2024. Tous droits r√©serv√©s. Dawn of Victory et les noms de jetons associ√©s sont des marques d√©pos√©es.
                </p>
            </footer>
        </div>
        <!-- FIN FOOTER -->

    </div>

    <script type="module">
        // --- API GEMINI ---
        const apiKey = ""; // API Key inject√©e par l'environnement
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        // --- CONFIGURATION WAX & ALCOR ---
        const TARGET_COLLECTION_NAME = "dovdivisions";
        const TARGET_SCHEMA_NAME = "warbuildings"; 
        
        // Liste des endpoints AtomicAssets (pour redondance)
        const ATOMIC_ENDPOINTS = [
            "https://wax.api.atomicassets.io/atomicassets/v1/assets",
            "https://aa.wax.blacklizard.io/atomicassets/v1/assets",
            "https://atomic.wax.eosrio.io/atomicassets/v1/assets",
            "https://api.wax-aa.bountyblok.io/atomicassets/v1/assets"
        ];
        // Liste des endpoints AtomicMarket
        const ATOMIC_MARKET_ENDPOINTS = [
            "https://wax.api.atomicassets.io/atomicmarket/v1/sales",
             "https://aa.wax.blacklizard.io/atomicmarket/v1/sales",
             "https://atomic.wax.eosrio.io/atomicmarket/v1/sales"
        ];
        
        // Endpoint Alcor principal
        const ALCOR_API_URL = "https://wax.alcor.exchange/api"; // Chang√© pour la V2

        // --- Constantes de prix et de ratio fixes (Bas√© sur les donn√©es utilisateur) ---
        const REFERENCE_DOVX = 0.00528552;
        const REFERENCE_TU = 0.00045262;
        const DOVX_TO_TU_RATIO = REFERENCE_DOVX / REFERENCE_TU; 
        
        // --- Globals for Price Storage ---
        let currentPriceDovX = REFERENCE_DOVX;
        let currentPriceCostToken = REFERENCE_TU;
        let currentPriceWaxUsd = 0.05;

        // Constantes de temps et de distribution
        const DAYS_IN_MONTH = 30;
        const DAYS_IN_YEAR = 365;
        const CASH_BACK_PERCENT = 0.30;
        const TEAM_PERCENT = 0.30;
        const MARKET_TOKEN_PERCENT = 0.30;
        const PUB_PERCENT = 0.10;
        
        const COST_TOKENS = ["DOV-H", "DOV-R", "DOV-S", "DOV-F"];
        const DOV_TOKENS = ["DOVX", ...COST_TOKENS]; // Jetons DOV pour le suivi (Section 13.3)

        // --- DONN√âES SWAP ALCOR (LIVE API) ---
        // Noms des march√©s Alcor pour les paires TARGET/WAX et DOVX/TARGET
        const ARBITRAGE_PAIRS_CONFIG = [
            // Target Token: TLM (alien.worlds)
            { token: "TLM", marketWax: "TLM-alien.worlds_WAX-eosio.token", marketDovx: "DOVX-dov.token_TLM-alien.worlds" }, 
            // Target Token: KOGS (kogs.token)
            { token: "KOGS", marketWax: "KOGS-kogs.token_WAX-eosio.token", marketDovx: "DOVX-dov.token_KOGS-kogs.token" }, 
            // Target Token: DHC (dhctokenmint)
            { token: "DHC", marketWax: "DHC-dhctokenmint_WAX-eosio.token", marketDovx: "DOVX-dov.token_DHC-dhctokenmint" }, 
            // Target Token: SHING (shingtoken)
            { token: "SHING", marketWax: "SHING-shingtoken_WAX-eosio.token", marketDovx: "DOVX-dov.token_SHING-shingtoken" } 
        ];

        let scannedWalletData = []; // Stocke les donn√©es r√©elles/simul√©es du wallet (Section 10)
        let allAlcorPairsCache = []; // Cache pour les donn√©es brutes de toutes les paires Alcor (Section 13.3)
        let selectedAlcorToken = DOV_TOKENS[0]; // Jeton DOVX par d√©faut pour le suivi (Section 13.3)

        // --- Fonctions de Formatage (Utility Functions) ---

        /** Formate en WAX */
        const formatWAX = (value, decimales = 6) => {
            if (isNaN(value) || !isFinite(value)) return '--';
            return value.toLocaleString('fr-FR', {
                minimumFractionDigits: decimales,
                maximumFractionDigits: decimales
            }) + ' WAX';
        };

        /** Formate en USD ($) */
        const formatUSD = (value, decimales = 4) => {
            if (isNaN(value) || !isFinite(value)) return '--';
            return value.toLocaleString('fr-FR', {
                minimumFractionDigits: decimales,
                maximumFractionDigits: decimales,
                style: 'currency',
                currency: 'USD',
            });
        };

        /** Formate en unit√©s (nombre avec s√©parateur) */
        const formatUnits = (value) => {
            if (isNaN(value) || !isFinite(value)) return '--';
            const maxDigits = (value % 1 !== 0) ? 2 : 0;
            return value.toLocaleString('fr-FR', { maximumFractionDigits: maxDigits });
        };
        
        /** Formate en pourcentage */
        const formatPercent = (value, decimales = 2) => {
            if (isNaN(value) || !isFinite(value)) return '--';
            return (value * 100).toLocaleString('fr-FR', {
                minimumFractionDigits: decimales,
                maximumFractionDigits: decimales
            }) + ' %';
        };
        
        /** Convertit une cha√Æne fran√ßaise (virgule) en float */
        const parseFrenchFloat = (str) => {
            if (!str) return NaN;
            const standardStr = str.toString().replace(',', '.');
            return parseFloat(standardStr);
        };
        
        /** Convertit une cha√Æne de pourcentage fran√ßaise (virgule + %) en d√©cimal (ex: 100,0000% -> 1) */
        const parseFrenchPercent = (str) => {
             if (!str) return 0;
             // Supprime le % et remplace la virgule par un point
             const cleanedStr = str.toString().replace('%', '').trim().replace(',', '.');
             const value = parseFloat(cleanedStr);
             if (isNaN(value)) return 0;
             // Divise par 100 pour obtenir le facteur (ex: 100 -> 1.0)
             return value / 100;
        };
        
        
        // --- Fonctions d'API Alcor (Maintenues ici) ---
        
        /**
         * Fonction utilitaire pour interroger l'API Alcor avec backoff exponentiel (Utilis√©e pour 13.1)
         * @param {string} marketName - Nom du march√© Alcor (e.g., TLM-alien.worlds_WAX-eosio.token)
         * @returns {Promise<Object|null>}
         */
        const fetchAlcorMarketPrice = async (marketName) => {
            const url = `${ALCOR_API_URL}/markets/${marketName}`;
            const maxRetries = 3;
            let delay = 500;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, { method: 'GET', mode: 'cors' });
                    if (response.ok) {
                        const data = await response.json();
                        // Retourne le last_price directement
                        if (data && data.last_price) {
                            return parseFloat(data.last_price);
                        }
                        // Si le march√© n'existe pas ou la r√©ponse est vide
                        return null; 
                    }
                } catch (error) {
                    // console.log(`Tentative ${i + 1} √©chou√©e pour ${marketName}.`);
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2; 
            }
            return null;
        };

        // Fonction d'arbitrage DOVX (Section 13.1)
        const fetchAlcorPrices = async () => {
            const results = [];
            const fetchPromises = ARBITRAGE_PAIRS_CONFIG.map(async (pair) => {
                // 1. R√©cup√®re le prix du Target Token en WAX (Ex: TLM/WAX)
                const priceTargetWax = await fetchAlcorMarketPrice(pair.marketWax);
                
                // 2. R√©cup√®re le prix de DOVX en Target Token (Ex: DOVX/TLM)
                const priceDovxTarget = await fetchAlcorMarketPrice(pair.marketDovx);
                
                let impliedWaxValue = null;
                let isMissingData = false;
                
                if (priceTargetWax !== null && priceDovxTarget !== null) {
                    // Calcul de la valeur implicite de 1 DOVX en WAX (P_DOVX/T * P_T/WAX)
                    impliedWaxValue = priceDovxTarget * priceTargetWax;
                } else {
                    isMissingData = true;
                }

                results.push({
                    token: pair.token,
                    priceTargetWax: priceTargetWax,
                    priceDovxTarget: priceDovxTarget,
                    impliedWaxValue: impliedWaxValue,
                    isMissingData: isMissingData
                });
            });

            await Promise.all(fetchPromises);
            return results;
        };


        // --- DONN√âES BATIMENTS (BUILDINGS) ---
        const TIER_STATS = [
            // Commun
            { level: "L1", rarity: "Commun", rarityCode: "C", prod: 5.40, cost: 0.4590, css: "rarity-commun" },
            { level: "L2", rarity: "Commun", rarityCode: "C", prod: 12.15, cost: 1.0328, css: "rarity-commun" },
            { level: "L3", rarity: "Commun", rarityCode: "C", prod: 30.38, cost: 2.58, css: "rarity-commun" },
            { level: "L4", rarity: "Commun", rarityCode: "C", prod: 83.53, cost: 7.10, css: "rarity-commun" },
            // Rare
            { level: "L1", rarity: "Rare", rarityCode: "R", prod: 16.20, cost: 1.38, css: "rarity-rare" },
            { level: "L2", rarity: "Rare", rarityCode: "R", prod: 36.45, cost: 3.10, css: "rarity-rare" },
            { level: "L3", rarity: "Rare", rarityCode: "R", prod: 91.13, cost: 7.75, css: "rarity-rare" },
            { level: "L4", rarity: "Rare", rarityCode: "R", prod: 250.59, cost: 21.30, css: "rarity-rare" },
            // Epic
            { level: "L1", rarity: "Epic", rarityCode: "E", prod: 48.60, cost: 4.13, css: "rarity-epic" },
            { level: "L2", rarity: "Epic", rarityCode: "E", prod: 109.35, cost: 9.29, css: "rarity-epic" },
            { level: "L3", rarity: "Epic", rarityCode: "E", prod: 273.38, cost: 23.24, css: "rarity-epic" },
            { level: "L4", rarity: "Epic", rarityCode: "E", prod: 751.78, cost: 63.90, css: "rarity-epic" },
            // Legendary
            { level: "L1", rarity: "Legendary", rarityCode: "L", prod: 145.80, cost: 12.39, css: "rarity-legendary" },
            { level: "L2", rarity: "Legendary", rarityCode: "L", prod: 328.05, cost: 27.88, css: "rarity-legendary" },
            { level: "L3", rarity: "Legendary", rarityCode: "L", prod: 820.13, cost: 69.71, css: "rarity-legendary" },
            { level: "L4", rarity: "Legendary", rarityCode: "L", prod: 2255.34, cost: 191.70, css: "rarity-legendary" },
            // Supreme (Single top tier)
            { level: "L5", rarity: "Supreme", rarityCode: "S", prod: 6766.02, cost: 575.11, css: "rarity-supreme" } 
        ];

        const BUILDING_TYPES = [
            { name: "Fuel Refinery", type: "DOV-F", suffix: "FUEL" },
            { name: "Health Factory", type: "DOV-H", suffix: "HEALTH" },
            { name: "Repair Factory", type: "DOV-R", suffix: "REPAIR" },
            { name: "Supply Factory", type: "DOV-S", suffix: "SUPPLY" }
        ];

        let BUILDING_DATA = [];
        BUILDING_TYPES.forEach(typeObj => {
            TIER_STATS.forEach(tier => {
                const levelNum = tier.level.replace('L', ''); 
                const technicalName = `${tier.rarityCode}_F${levelNum}_PRODUCER_${typeObj.suffix}`;
                
                BUILDING_DATA.push({
                    name: `F${levelNum} ${typeObj.name} (${tier.rarity})`,
                    technicalName: technicalName,
                    type: typeObj.type,
                    rarity: tier.rarity,
                    prodPerHour: tier.prod,
                    dovxCost: tier.cost,
                    cssClass: tier.css,
                    userQty: 0
                });
            });
        });
        
        // --- DONN√âES ZONES DE D√âPLOIEMENT (ZONE_DATA) ---
        const ZONE_DATA = [
            { name: "beach1", totalTuCost: 4640, dovxReward: 400 }, 
            { name: "beach2", totalTuCost: 27872, dovxReward: 2405 }, 
            { name: "beach3", totalTuCost: 35200, dovxReward: 3037 }, 
            { name: "bunker", totalTuCost: 44480, dovxReward: 3838 }, 
            { name: "forest1", totalTuCost: 56096, dovxReward: 4840 }, 
            { name: "forest2", totalTuCost: 70816, dovxReward: 6110 }, 
            { name: "forest3", totalTuCost: 89408, dovxReward: 7714 }, 
            { name: "camp", totalTuCost: 112880, dovxReward: 9739 }, 
            { name: "hill1", totalTuCost: 148208, dovxReward: 12788 }, 
            { name: "hill2", totalTuCost: 194608, dovxReward: 16791 }, 
            { name: "hill3", totalTuCost: 258064, dovxReward: 22266 }, 
            { name: "radar", totalTuCost: 338848, dovxReward: 29236 }, 
            { name: "plain1", totalTuCost: 397536, dovxReward: 34300 }, 
            { name: "plain2", totalTuCost: 502832, dovxReward: 43385 }, 
            { name: "plain3", totalTuCost: 604656, dovxReward: 52171 }, 
            { name: "HQ", totalTuCost: 752000, dovxReward: 64884 }, 
            { name: "STAKING", totalTuCost: 650000, dovxReward: 50000 },
        ];
        
        // --- DONN√âES DIVISION FOURNIES PAR L'UTILISATEUR (REDACTED FOR BREVITY) ---
        const RAW_DIVISION_DATA = [
            "Common F1-26th-INFANTRY-REGIMENT 1,360,3000 100,0000% 22,0000% 100,0000% 72,0000% 1% combat",
            "Common F2-26th-INFANTRY-REGIMENT 40,9000 100,9000% 23,0000% 100,9000% 73,0000% 1% combat",
            "Common F3-26th-INFANTRY-REGIMENT 122,7000 102,7000% 24,0000% 102,7000% 74,0000% 1% combat",
            "Common F4-26th-INFANTRY-REGIMENT 378,1000 108,1000% 25,0000% 108,1000% 75,0000% 1% combat",
            "Common F1-18th-INFANTRY-REGIMENT 1,360,3000 100,0000% 22,0000% 100,0000% 72,0000% 1% combat",
            "Common F2-18th-INFANTRY-REGIMENT 40,9000 100,9000% 23,0000% 100,9000% 73,0000% 1% combat",
            "Common F3-18th-INFANTRY-REGIMENT 122,7000 102,7000% 24,0000% 102,7000% 74,0000% 1% combat",
            "Common F4-18th-INFANTRY-REGIMENT 378,1000 108,1000% 25,0000% 108,1000% 75,0000% 1% combat",
            "Common F1-507th-PARACHUTE-INFANTRY-REGIMENT 1,360,3000 22,0000% 100,0000% 22,0000% 100,0000% 1% combat",
            "Common F2-507th-PARACHUTE-INFANTRY-REGIMENT 40,9000 23,0000% 100,9000% 23,0000% 100,9000% 1% combat",
            "Common F3-507th-PARACHUTE-INFANTRY-REGIMENT 122,7000 24,0000% 102,7000% 24,0000% 102,7000% 1% combat",
            "Common F4-507th-PARACHUTE-INFANTRY-REGIMENT 378,1000 25,0000% 108,1000% 25,0000% 108,1000% 1% combat",
            "Common F1-32nd-FIELD-ARTILLERY-BATTALION 1,360,3000 100,0000% 100,0000% 72,0000% 100,0000% 1% combat",
            "Common F2-32nd-FIELD-ARTILLERY-BATTALION 40,9000 100,0000% 100,9000% 73,0000% 100,9000% 1% combat",
            "Common F3-32nd-FIELD-ARTILLERY-BATTALION 122,7000 100,0000% 102,7000% 74,0000% 102,7000% 1% combat",
            "Common F4-32nd-FIELD-ARTILLERY-BATTALION 378,1000 100,0000% 108,1000% 75,0000% 108,1000% 1% combat",
            "Common F1-82nd-ARMORED-RECONN-BATTALION 1,360,3000 22,0000% 100,0000% 100,0000% 100,0000% 100% combat",
            "Common F2-82nd-ARMORED-RECONN-BATTALION 40,9000 23,0000% 100,9000% 100,9000% 100,9000% 100% combat",
            "Common F3-82nd-ARMORED-RECONN-BATTALION 122,7000 24,0000% 102,7000% 102,7000% 102,7000% 100% combat",
            "Common F4-82nd-ARMORED-RECONN-BATTALION 378,1000 25,0000% 108,1000% 108,1000% 108,1000% 100% combat",
            "Uncommon F1-505th-PARACHUTE-INFANTRY-REGIMENT 30,9000 22,0000% 100,0000% 22,0000% 100,0000% 1% combat",
            "Uncommon F2-505th-PARACHUTE-INFANTRY-REGIMENT 92,7000 23,0000% 100,9000% 23,0000% 100,9000% 1% combat",
            "Uncommon F3-505th-PARACHUTE-INFANTRY-REGIMENT 278,1000 24,0000% 102,7000% 24,0000% 102,7000% 1% combat",
            "Uncommon F4-505th-PARACHUTE-INFANTRY-REGIMENT 8124,3000 25,0000% 108,1000% 25,0000% 108,1000% 1% combat",
            "Uncommon F1-5th-FIELD-ARTILLERY-BATTALION 30,9000 100,0000% 100,0000% 100,0000% 100,0000% 1% combat",
            "Uncommon F2-5th-FIELD-ARTILLERY-BATTALION 92,7000 100,9000% 100,9000% 100,9000% 100,9000% 1% combat",
            "Uncommon F3-5th-FIELD-ARTILLERY-BATTALION 278,1000 102,7000% 102,7000% 102,7000% 102,7000% 1% combat",
            "Uncommon F4-5th-FIELD-ARTILLERY-BATTALION 8124,3000 108,1000% 108,1000% 108,1000% 108,1000% 1% combat",
            "Uncommon F1-325th-GLIDER-INFANTRY-REGIMENT 30,9000 22,0000% 100,0000% 22,0000% 100,0000% 1% combat",
            "Uncommon F2-325th-GLIDER-INFANTRY-REGIMENT 92,7000 23,0000% 100,9000% 23,0000% 100,9000% 1% combat",
            "Uncommon F3-325th-GLIDER-INFANTRY-REGIMENT 278,1000 24,0000% 102,7000% 24,0000% 102,7000% 1% combat",
            "Uncommon F4-325th-GLIDER-INFANTRY-REGIMENT 8124,3000 25,0000% 108,1000% 25,0000% 108,1000% 1% combat",
            "Uncommon F1-Anti-tank-Battalion-Xmas 30,9000 22,0000% 100,0000% 100,0000% 100,0000% 100% combat",
            "Uncommon F2-Anti-tank-Battalion-Xmas 92,7000 23,0000% 100,9000% 100,9000% 100,9000% 100% combat",
            "Uncommon F3-Anti-tank-Battalion-Xmas 278,1000 24,0000% 102,7000% 102,7000% 102,7000% 100% combat",
            "Uncommon F4-Anti-tank-Battalion-Xmas 8124,3000 25,0000% 108,1000% 108,1000% 108,1000% 100% combat",
            "Rare F1-16th-INFANTRY-REGIMENT 17,923,6000 100,0000% 22,0000% 100,0000% 100,0000% 1% combat",
            "Rare F2-16th-INFANTRY-REGIMENT 5410,8000 100,9000% 23,0000% 100,9000% 100,9000% 1% combat",
            "Rare F3-16th-INFANTRY-REGIMENT 16132,4000 102,7000% 24,0000% 102,7000% 102,7000% 1% combat",
            "Rare F4-16th-INFANTRY-REGIMENT 48497,2000 108,1000% 25,0000% 108,1000% 108,1000% 1% combat",
            "Rare F1-635th-ANTI-TANK-BATTALION 17,923,6000 22,0000% 72,0000% 100,0000% 100,0000% 100% combat",
            "Rare F2-635th-ANTI-TANK-BATTALION 5410,8000 23,0000% 73,0000% 100,9000% 100,9000% 100% combat",
            "Rare F3-635th-ANTI-TANK-BATTALION 16132,4000 24,0000% 74,0000% 102,7000% 102,7000% 100% combat",
            "Rare F4-635th-ANTI-TANK-BATTALION 48497,2000 25,0000% 75,0000% 108,1000% 108,1000% 100% combat",
            "Epic F1-502nd-PARACHUTE_INFANTRY 42,58,4200 22,0000% 100,0000% 22,0000% 100,0000% 100% combat",
            "Epic F2-502nd-PARACHUTE_INFANTRY 127,525,2700 23,0000% 100,9000% 23,0000% 100,9000% 100% combat",
            "Epic F3-502nd-PARACHUTE_INFANTRY 382,575,8100 24,0000% 102,7000% 24,0000% 102,7000% 100% combat",
            "Epic F4-502nd-PARACHUTE_INFANTRY 1147,5227,4400 25,0000% 108,1000% 25,0000% 108,1000% 100% combat",
            "Epic F1-37th-ENGINEER-COMBAT-BATTALION 42,58,4200 100,0000% 22,0000% 100,0000% 100,0000% 1% combat",
            "Epic F2-37th-ENGINEER-COMBAT-BATTALION 127,525,2700 100,9000% 23,0000% 100,9000% 100,9000% 1% combat",
            "Epic F3-37th-ENGINEER-COMBAT-BATTALION 382,575,8100 102,7000% 24,0000% 102,7000% 102,7000% 1% combat",
            "Epic F4-37th-ENGINEER-COMBAT-BATTALION 1147,5227,4400 108,1000% 25,0000% 108,1000% 108,1000% 1% combat",
            "Epic F1-741st-TANK-BATTALION 42,58,4200 22,0000% 100,0000% 22,0000% 72,0000% 1% combat",
            "Epic F2-741st-TANK-BATTALION 127,525,2700 23,0000% 100,9000% 23,0000% 73,0000% 1% combat",
            "Epic F3-741st-TANK-BATTALION 382,575,8100 24,0000% 102,7000% 24,0000% 74,0000% 1% combat",
            "Epic F4-741st-TANK-BATTALION 1147,5227,4400 25,0000% 108,1000% 25,0000% 75,0000% 1% combat",
            "Epic F1-AFTERLAND 42,58,4200 100,0000% 22,0000% 100,0000% 100,0000% 1% combat",
            "Epic F2-AFTERLAND 127,525,2700 100,9000% 23,0000% 100,9000% 100,9000% 1% combat",
            "Epic F3-AFTERLAND 382,575,8100 102,7000% 24,0000% 102,7000% 102,7000% 1% combat",
            "Epic F4-AFTERLAND 1147,5227,4400 108,1000% 25,0000% 108,1000% 108,1000% 1% combat",
            "Legendary F1-741-Tank-Battalion-Xmas 247,557,6000 22,0000% 100,0000% 22,0000% 72,0000% 1% combat",
            "Legendary F2-741-Tank-Battalion-Xmas 742,5172,8000 23,0000% 100,9000% 23,0000% 73,0000% 1% combat",
            "Legendary F3-741-Tank-Battalion-Xmas 2227,5518,4000 24,0000% 102,7000% 24,0000% 74,0000% 1% combat",
            "Legendary F4-741-Tank-Battalion-Xmas 6682,51555,2000 25,0000% 108,1000% 25,0000% 75,0000% 1% combat",
            "Rare F1-346th-GUYENNE-SQUADRON 17,923,6000 100,0000% 100,0000% 22,0000% 100,0000% 100% combat",
            "Rare F2-346th-GUYENNE-SQUADRON 5410,8000 100,0000% 100,9000% 23,0000% 100,0000% 100% combat",
            "Rare F3-346th-GUYENNE-SQUADRON 16132,4000 100,0000% 102,7000% 24,0000% 100,0000% 100% combat",
            "Rare F4-346th-GUYENNE-SQUADRON 48497,2000 100,0000% 108,1000% 25,0000% 100,0000% 100% combat",
            "Epic F1-USS-FRANKFORD 42,58,4200 125,0000% 100,0000% 100,0000% 75,0000% 100% combat",
            "Epic F2-USS-FRANKFORD 127,525,2700 125,0000% 100,0000% 100,0000% 75,0000% 100% combat",
            "Epic F3-USS-FRANKFORD 382,575,8100 125,0000% 100,0000% 100,0000% 75,0000% 100% combat",
            "Epic F4-USS-FRANKFORD 1147,5227,4400 125,0000% 100,0000% 100,0000% 75,0000% 100% combat",
            "Rare F2E-F3-16th-INFANTRY-REGIMENT 16132,4000 102,7000% 24,0000% 102,7000% 102,7000% 1% combat",
            "Common F1-HMS-Glasgow 0,3000 100,0000% 22,0000% 100,0000% 72,0000% 100,0000% combat",
            "Common F2-HMS-Glasgow 0,9000 100,9000% 23,0000% 100,9000% 73,0000% 100,0000% combat",
            "Common F3-HMS-Glasgow 2,7000 102,7000% 24,0000% 102,7000% 74,0000% 100,0000% combat",
            "Common F4-HMS-Glasgow 8,1000 108,1000% 25,0000% 108,1000% 75,0000% 100,0000% combat",
            "Uncommon F1-De-Havilland-Mosquito B.IV 0,9000 100,0000% 22,0000% 100,0000% 72,0000% 100,0000% combat",
            "Uncommon F2-De-Havilland-Mosquito B.IV 2,7000 100,9000% 23,0000% 100,9000% 73,0000% 100,0000% combat",
            "Uncommon F3-De-Havilland-Mosquito B.IV 8,1000 102,7000% 24,0000% 102,7000% 74,0000% 100,0000% combat",
            "Uncommon F4-De-Havilland-Mosquito B.IV 24,3000 108,1000% 25,0000% 108,1000% 75,0000% 100,0000% combat",
            "Uncommon F1-Avro-Lancaster-Mark I 0,9000 100,0000% 22,0000% 100,0000% 72,0000% 100,0000% combat",
            "Uncommon F2-Avro-Lancaster-Mark I 2,7000 100,9000% 23,0000% 100,9000% 73,0000% 100,0000% combat",
            "Uncommon F3-Avro-Lancaster-Mark I 2,7000 102,7000% 24,0000% 102,7000% 74,0000% 100,0000% combat",
            "Uncommon F4-Avro-Lancaster-Mark I 24,3000 108,1000% 25,0000% 108,1000% 75,0000% 100,0000% combat",
            "Rare F1-USS-Texas 3,6000 22,0000% 22,0000% 22,0000% 22,0000% 100,0000% combat",
            "Rare F2-USS-Texas 10,8000 23,0000% 23,0000% 23,0000% 23,0000% 100,0000% combat",
            "Rare F3-USS-Texas 32,4000 24,0000% 24,0000% 24,0000% 24,0000% 100,0000% combat",
            "Rare F4-USS-Texas 97,2000 25,0000% 25,0000% 25,0000% 25,0000% 100,0000% combat",
            "Rare F1-USS-Baldwin 3,6000 22,0000% 22,0000% 22,0000% 22,0000% 100,0000% combat",
            "Rare F2-USS-Baldwin 10,8000 23,0000% 23,0000% 23,0000% 23,0000% 100,0000% combat",
            "Rare F3-USS-Baldwin 32,4000 24,0000% 24,0000% 24,0000% 24,0000% 100,0000% combat",
            "Rare F4-USS-Baldwin 97,2000 25,0000% 25,0000% 25,0000% 25,0000% 100,0000% combat",
            "Epic F1-Glen-Martin-B-26-B-Marauder 8,4200 22,0000% 22,0000% 22,0000% 22,0000% 100,0000% combat",
            "Epic F2-Glen-Martin-B-26-B-Marauder 25,2700 23,0000% 23,0000% 23,0000% 23,0000% 100,0000% combat",
            "Epic F3-Glen-Martin-B-26-B-Marauder 75,8100 24,0000% 24,0000% 24,0000% 24,0000% 100,0000% combat",
            "Epic F4-Glen-Martin-B-26-B-Marauder 227,4400 25,0000% 25,0000% 25,0000% 25,0000% 100,0000% combat",
            "Epic F1-Georges-Leygues 8,4200 22,0000% 22,0000% 22,0000% 22,0000% 100,0000% combat",
            "Epic F2-Georges-Leygues 25,2700 23,0000% 23,0000% 23,0000% 23,0000% 100,0000% combat",
            "Epic F3-Georges-Leygues 75,8100 24,0000% 24,0000% 24,0000% 24,0000% 100,0000% combat",
            "Epic F4-Georges-Leygues 227,4400 25,0000% 25,0000% 25,0000% 25,0000% 100,0000% combat",
            "Legendary F1-USS-Arkansas 57,6000 22,0000% 22,0000% 22,0000% 22,0000% 100,0000% combat",
            "Legendary F2-USS-Arkansas 172,8000 23,0000% 23,0000% 23,0000% 23,0000% 100,0000% combat",
            "Legendary F3-USS-Arkansas 518,4000 24,0000% 24,0000% 24,0000% 24,0000% 100,0000% combat",
            "Legendary F4-USS-Arkansas 1555,2000 25,0000% 25,0000% 25,0000% 25,0000% 100,0000% combat"
        ];
        
        const DIVISION_DATA = RAW_DIVISION_DATA.map(line => {
             const parts = line.split(/\s+/);
             const rarity = parts[0]; 
             const type = parts.pop();
             const beachPct = parseFrenchPercent(parts.pop());
             const plainPct = parseFrenchPercent(parts.pop());
             const forestPct = parseFrenchPercent(parts.pop());
             const hillPct = parseFrenchPercent(parts.pop());
             const cityPct = parseFrenchPercent(parts.pop());
             const remaining = parts.slice(1).join(' ').trim();
             const valueParts = remaining.split(/\s+/);
             let unitId, value, weight;
             
             if (valueParts.length > 2) {
                 weight = parseFrenchFloat(valueParts.pop());
                 value = parseFrenchFloat(valueParts.pop());
                 unitId = valueParts.join(' ').trim();
             } else if (valueParts.length === 2) {
                 unitId = valueParts[0];
                 value = parseFrenchFloat(valueParts[1]);
                 weight = 0; 
             } else {
                 unitId = remaining;
                 value = 0;
                 weight = 0;
             }
             
             return {
                 rarity: rarity, unitId: unitId, value: value, weight: weight,
                 beach: beachPct, plain: plainPct, forest: forestPct, 
                 hill: hillPct, city: cityPct, type: type
             };
        });


        // --- R√©f√©rences DOM (Liste abr√©g√©e pour la clart√©) ---
        const zoneSelector = document.getElementById('zoneSelector');
        const priceWaxUsdInput = document.getElementById('priceWaxUsd');
        const numberOfAccountsInput = document.getElementById('numberOfAccounts');
        const divisionsPerAccountInput = document.getElementById('divisionsPerAccount');
        const numberOfPacksInput = document.getElementById('numberOfPacks');
        const divisionsPerPackInput = document.getElementById('divisionsPerPack');
        const pricePerPackWaxInput = document.getElementById('pricePerPackWax'); 
        const dovxPriceManualInput = document.getElementById('priceDovXManual');
        const dovxPriceSlider = document.getElementById('dovxPriceSlider');
        const priceCostTokenCalculated = document.getElementById('priceCostTokenCalculated');
        const ratioDisplay = document.getElementById('ratioDisplay');
        const btnFetchPrice = document.getElementById('btnFetchPrice'); 
        const packDesignZoneSelector = document.getElementById('packDesignZoneSelector');
        const packDesignPriceUsdInput = document.getElementById('packDesignPriceUsd');
        const designPackNetUsdElement = document.getElementById('designPackNetUsd');
        const designPackRoiDailyElement = document.getElementById('designPackRoiDaily');
        const designPackRoiDaysElement = document.getElementById('designPackRoiDays');
        const designPackCashBackUsdElement = document.getElementById('designPackCashBackUsd');
        const designPackCashBackWaxElement = document.getElementById('designPackCashBackWax');
        const designPackPriceWaxElement = document.getElementById('designPackPriceWax');
        
        const btnAiLore = document.getElementById('btnAiLore');
        const aiLoreOutput = document.getElementById('aiLoreOutput');
        const packNameInput = document.getElementById('packName');
        const packCompositionInput = document.getElementById('packComposition');
        const buildingsTableBody = document.getElementById('buildingsTableBody');
        const buildingTypeFilter = document.getElementById('buildingTypeFilter');
        const section9RatesDisplay = document.getElementById('section9RatesDisplay');
        const userTotalTuDailyEl = document.getElementById('userTotalTuDaily');
        const userTotalRevenueWaxEl = document.getElementById('userTotalRevenueWax');
        const userTotalMarginWaxEl = document.getElementById('userTotalMarginWax'); 
        const userTotalRevenueUsdMonthlyEl = document.getElementById('userTotalRevenueUsdMonthly'); 
        const btnScanWallet = document.getElementById('btnScanWallet');
        const walletAddressInput = document.getElementById('walletAddressInput');
        const walletResultsContainer = document.getElementById('walletResultsContainer');
        const walletAssetsBody = document.getElementById('walletAssetsBody');
        const walletTotalBuildingsEl = document.getElementById('walletTotalBuildings');
        const walletMonthlyWaxEl = document.getElementById('walletMonthlyWax');
        const walletMonthlyUsdEl = document.getElementById('walletMonthlyUsd');
        const walletScenarioSummary = document.getElementById('walletScenarioSummary');
        const packBuildingSelect = document.getElementById('packBuildingSelect');
        const packBuildingQtyInput = document.getElementById('packBuildingQty');
        const packToolMultiplierInput = document.getElementById('packToolMultiplier');
        const packBuildingPriceInput = document.getElementById('packBuildingPrice');
        const packBuildingProdEl = document.getElementById('packBuildingProd');
        const packBuildingProdBaseEl = document.getElementById('packBuildingProdBase');
        const packBuildingOpExEl = document.getElementById('packBuildingOpEx');
        const packBuildingMonthlyNetEl = document.getElementById('packBuildingMonthlyNet');
        const packBuildingRoiEl = document.getElementById('packBuildingRoi');
        const packBuildingRoiDaysEl = document.getElementById('packBuildingRoiDays');
        
        // CORRECTION DE R√âF√âRENCE: Utilisation des ID sp√©cifiques de la section 11
        const buildingPackCashBackUsdElement = document.getElementById('buildingPackCashBackUsd');
        const buildingPackCashBackWaxElement = document.getElementById('buildingPackCashBackWax');
        const buildingPackPriceWaxElement = document.getElementById('buildingPackPriceWax');

        const btnScanMarket = document.getElementById('btnScanMarket');
        const marketResultsContainer = document.getElementById('marketResultsContainer');
        const marketDealsBody = document.getElementById('marketDealsBody');
        const marketSniperSection = document.getElementById('marketSniperSection');
        const marketRoiFilter = document.getElementById('marketRoiFilter');

        const dovxCurrentWaxPriceDisplay = document.getElementById('dovxCurrentWaxPriceDisplay');
        const swapAnalysisBody = document.getElementById('swapAnalysisBody');
        // R√âF√âRENCE DOM AJOUT√âE
        const btnArbitrageScan = document.getElementById('btnArbitrageScan');
        
        // NOUVELLES R√âF√âRENCES DOM POUR CALCULATEUR LP (Section 13.2)
        const lpDovxWaxAmountInput = document.getElementById('lpDovxWaxAmount');
        const lpDovxWaxRequiredEl = document.getElementById('lpDovxWaxRequired');
        const lpDovxWaxPriceSpanEl = document.getElementById('lpDovxWaxPriceSpan');

        const lpTuWaxAmountInput = document.getElementById('lpTuWaxAmount');
        const lpTuWaxRequiredEl = document.getElementById('lpTuWaxRequired');
        const lpTuWaxPriceSpanEl = document.getElementById('lpTuWaxPriceSpan');

        const lpDovxTuAmountInput = document.getElementById('lpDovxTuAmount');
        const lpDovxTuRequiredEl = document.getElementById('lpDovxTuRequired');
        const lpDovxTuPriceSpanEl = document.getElementById('lpDovxTuPriceSpan');
        const lpTuDovxPriceSpanEl = document.getElementById('lpTuDovxPriceSpan');

        // NOUVELLES R√âF√âRENCES DOM POUR SUIVI PAIRES (Section 13.3)
        const alcorTokenSelection = document.getElementById('alcorTokenSelection');
        const alcorPairsBody = document.getElementById('alcorPairsBody');
        const alcorPairsLoading = document.getElementById('alcorPairsLoading');
        const alcorPairsError = document.getElementById('alcorPairsError');
        const alcorPairsEmpty = document.getElementById('alcorPairsEmpty');
        
        
        // --- Fonctions d'Initialisation ---

        const initializeSelectors = () => {
             // Remplissage des s√©lecteurs de zones (Volume et Pack Design)
             if (zoneSelector) zoneSelector.innerHTML = '';
             if (packDesignZoneSelector) packDesignZoneSelector.innerHTML = '';
             
             ZONE_DATA.forEach((zone, index) => {
                 const zoneDisplay = `${zone.name.toUpperCase()} (R√©compense: ${formatUnits(zone.dovxReward)} DOVX - Co√ªt/J: ${formatUnits(zone.totalTuCost)} TU)`;
                 
                 const option = document.createElement('option');
                 option.value = index;
                 option.textContent = zoneDisplay;
                 
                 if (zoneSelector) zoneSelector.appendChild(option.cloneNode(true));
                 if (packDesignZoneSelector) packDesignZoneSelector.appendChild(option.cloneNode(true));
             });

             if (zoneSelector) zoneSelector.value = 0;
             if (packDesignZoneSelector) packDesignZoneSelector.value = 0;
             
             // Initialisation des boutons de s√©lection de jetons (Section 13.3)
             initializeAlcorPairsSelector();
        };
        
        // Initialise la s√©lection de jetons pour le suivi (Section 13.3)
        const initializeAlcorPairsSelector = () => {
            if (!alcorTokenSelection) return;
            alcorTokenSelection.innerHTML = '';

            DOV_TOKENS.forEach(token => {
                const button = document.createElement('button');
                button.textContent = token;
                button.classList.add('px-4', 'py-2', 'rounded-lg', 'font-semibold', 'transition-all', 'text-sm');
                button.setAttribute('data-token', token);
                
                // Mettre √† jour l'√©tat visuel initial
                if (token === selectedAlcorToken) {
                    button.classList.add('bg-purple-500', 'text-white', 'shadow-lg', 'shadow-purple-500/50');
                } else {
                    button.classList.add('bg-slate-700', 'text-purple-200', 'hover:bg-slate-600');
                }

                button.addEventListener('click', () => {
                    handleTokenChange(token);
                });

                alcorTokenSelection.appendChild(button);
            });
        };
        
        // Change le jeton s√©lectionn√© et filtre les paires (Section 13.3)
        const handleTokenChange = (token) => {
            selectedAlcorToken = token;
            
            // Mise √† jour visuelle des boutons
            const buttons = alcorTokenSelection.querySelectorAll('button');
            buttons.forEach(button => {
                const buttonToken = button.getAttribute('data-token');
                button.classList.remove('bg-purple-500', 'text-white', 'shadow-lg', 'shadow-purple-500/50');
                button.classList.add('bg-slate-700', 'text-purple-200', 'hover:bg-slate-600');
                if (buttonToken === selectedAlcorToken) {
                    button.classList.remove('bg-slate-700', 'text-purple-200', 'hover:bg-slate-600');
                    button.classList.add('bg-purple-500', 'text-white', 'shadow-lg', 'shadow-purple-500/50');
                }
            });
            
            // Filtrer le cache des paires
            filterAlcorPairs(allAlcorPairsCache, selectedAlcorToken);
        };


         // Met √† jour la quantit√© d'un b√¢timent et d√©clenche le recalcul des totaux utilisateur.
        window.updateBuildingQuantity = (input) => {
            const index = parseInt(input.getAttribute('data-index'));
            const newQty = parseInt(input.value) || 0;
            
            if (index >= 0 && index < BUILDING_DATA.length) {
                BUILDING_DATA[index].userQty = newQty;
                updateBuildingTotals(); // Recalculer le pied de page
            }
        };

        const initializeBuildingTable = () => {
            if (!buildingsTableBody || !packBuildingSelect) return;
            buildingsTableBody.innerHTML = '';
            packBuildingSelect.innerHTML = ''; // R√©initialisation du s√©lecteur de pack b√¢timent
            
            const filterValue = buildingTypeFilter.value;

            BUILDING_DATA.forEach((building, index) => {
                const isHidden = (filterValue !== 'ALL' && building.type !== filterValue) ? 'hidden' : '';

                const tr = document.createElement('tr');
                tr.className = `hover:bg-gray-800/40 building-row ${isHidden}`;
                tr.setAttribute('data-type', building.type);
                
                tr.innerHTML = `
                    <td class="p-3 font-semibold ${building.cssClass}">
                        ${building.name} 
                        <span class="text-xs opacity-70 block">${building.technicalName}</span>
                    </td>
                    <td class="p-3 text-right">${formatUnits(building.dovxCost * 24)}</td> <!-- Co√ªt DOVX/24h -->
                    <td class="p-3 text-right text-blue-300 building-cost-wax" data-index="${index}">--</td>
                    <td class="p-3 text-right text-gray-300 font-medium">${formatUnits(building.prodPerHour * 24)}</td>
                    <td class="p-3 text-right text-green-400 building-revenue-wax" data-index="${index}">--</td>
                    <td class="p-3 text-right text-green-400 building-margin-wax" data-index="${index}">--</td>
                    <td class="p-3 text-right text-green-400 building-revenue-usd-monthly" data-index="${index}">--</td>
                    <td class="p-3 text-center">
                        <input type="number" min="0" value="${building.userQty}" 
                            class="building-qty input-style w-16 text-center p-1 rounded text-sm focus:ring-orange-500 focus:border-orange-500" 
                            data-index="${index}" onchange="updateBuildingQuantity(this)">
                    </td>
                `;
                buildingsTableBody.appendChild(tr);

                // Populate Pack Building Selector (Section 11)
                const opt = document.createElement('option');
                opt.value = index;
                opt.textContent = `${building.name}`;
                packBuildingSelect.appendChild(opt);
            });

             // Ajout des listeners pour le filtrage
            if(buildingTypeFilter) {
                buildingTypeFilter.addEventListener('change', () => {
                    const filterValue = buildingTypeFilter.value;
                    const rows = document.querySelectorAll('.building-row');
                    rows.forEach(row => {
                        const rowType = row.getAttribute('data-type');
                        if (filterValue === 'ALL' || rowType === filterValue) {
                            row.classList.remove('hidden');
                        } else {
                            row.classList.add('hidden');
                        }
                    });
                    updateBuildingTotals(); // Mettre √† jour les totaux m√™me si des lignes sont cach√©es
                });
            }
        };


        // --- Fonctions de Mise √† Jour des Sections ---

        // Met √† jour les calculs du Pack Design (Section 8)
        const calculatePackDesign = (tokenPrices) => {
            const { newPriceDovX, newPriceCostToken, priceWaxUsd } = tokenPrices;
            
            const selectedDesignIndex = parseInt(packDesignZoneSelector.value);
            const selectedDesignZone = ZONE_DATA[selectedDesignIndex];
            
            const divisionsPerPack = Math.max(0, parseInt(divisionsPerPackInput.value) || 0); 
            // Note: l'ID packDesignPriceUsdInput est correctement d√©fini
            const pricePackUsd = parseFrenchFloat(packDesignPriceUsdInput.value);

            // 1. Validation essentielle
            if (!selectedDesignZone || priceWaxUsd <= 0 || newPriceDovX <= 0 || newPriceCostToken <= 0 || divisionsPerPack === 0 || pricePackUsd <= 0) {
                 if(designPackNetUsdElement) designPackNetUsdElement.textContent = '--';
                 if(designPackRoiDailyElement) designPackRoiDailyElement.textContent = '--';
                 if(designPackRoiDaysElement) designPackRoiDaysElement.textContent = '--';
                 if(designPackCashBackUsdElement) designPackCashBackUsdElement.textContent = '--';
                 if(designPackCashBackWaxElement) designPackCashBackWaxElement.textContent = '--';
                 if(designPackPriceWaxElement) designPackPriceWaxElement.textContent = '--';
                 return;
            }
            
            // 2. Calcul du Prix du Pack en WAX
            const pricePackWax = pricePackUsd / priceWaxUsd;
            
            // 3. Calcul du ROI du Pack
            const unitsDovX = selectedDesignZone.dovxReward;
            const singleDivisionWaxCost = selectedDesignZone.totalTuCost * newPriceCostToken; 
            const singleDivisionWaxReward = unitsDovX * newPriceDovX; 
            
            const packDailyWaxCost = singleDivisionWaxCost * divisionsPerPack;
            const packDailyWaxReward = singleDivisionWaxReward * divisionsPerPack;
            
            const packNetProfitLossWax = packDailyWaxReward - packDailyWaxCost;
            const packNetProfitLossUsd = packNetProfitLossWax * priceWaxUsd;
            
            // 4. Calcul du ROI
            let packRoiDays = Infinity;
            let packRoiDailyPercent = 0;
            
            if (pricePackUsd > 0) {
                packRoiDailyPercent = packNetProfitLossUsd / pricePackUsd;

                if (packNetProfitLossUsd > 0) {
                    packRoiDays = pricePackUsd / packNetProfitLossUsd;
                }
            }
            
            // 5. R√©partition du Cash Back (30% du prix du pack)
            const cbUsd = pricePackUsd * CASH_BACK_PERCENT;
            const cbWax = pricePackWax * CASH_BACK_PERCENT;
            
            // 6. Mise √† jour de l'affichage
            if(designPackNetUsdElement) {
                designPackNetUsdElement.textContent = formatUSD(packNetProfitLossUsd, 4);
                designPackNetUsdElement.classList.toggle('text-red-400', packNetProfitLossUsd < 0);
                designPackNetUsdElement.classList.toggle('text-green-400', packNetProfitLossUsd >= 0);
            }

            if(designPackRoiDailyElement) {
                designPackRoiDailyElement.textContent = formatPercent(packRoiDailyPercent, 4);
                designPackRoiDailyElement.classList.toggle('text-red-400', packRoiDailyPercent < 0);
                designPackRoiDailyElement.classList.toggle('text-green-400', packRoiDailyPercent >= 0);
            }

            if(designPackRoiDaysElement) designPackRoiDaysElement.textContent = (packRoiDays === Infinity) ? '--' : formatUnits(packRoiDays);
            
            if(designPackCashBackUsdElement) designPackCashBackUsdElement.textContent = formatUSD(cbUsd, 2);
            if(designPackCashBackWaxElement) designPackCashBackWaxElement.textContent = formatWAX(cbWax, 0);
            if(designPackPriceWaxElement) designPackPriceWaxElement.textContent = formatWAX(pricePackWax, 0);
        };

        // Met √† jour les calculs du Simulateur de B√¢timents (Section 9)
        const updateBuildingTable = (tokenPrices) => {
            const { newPriceDovX, newPriceCostToken, priceWaxUsd } = tokenPrices;
             
            // MISE √Ä JOUR DU TAUX D'AFFICHAGE DANS LE HEADER DE LA SECTION 9
            if(section9RatesDisplay) {
                section9RatesDisplay.textContent = `(Taux: 1 DOVX = ${formatWAX(newPriceDovX, 6)} | 1 TU = ${formatWAX(newPriceCostToken, 6)})`;
            }

            // Mise √† jour de chaque ligne du tableau
            BUILDING_DATA.forEach((building, index) => {
                const hourlyCostDovx = building.dovxCost;
                const dailyCostDovx = hourlyCostDovx * 24;
                const dailyCostWax = dailyCostDovx * newPriceDovX;

                const dailyProdTu = building.prodPerHour * 24;
                const dailyRevenueWax = dailyProdTu * newPriceCostToken;
                const dailyMarginWax = dailyRevenueWax - dailyCostWax;

                const monthlyMarginUsd = dailyMarginWax * priceWaxUsd * DAYS_IN_MONTH;
                 
                const costEl = document.querySelector(`.building-cost-wax[data-index="${index}"]`);
                const revEl = document.querySelector(`.building-revenue-wax[data-index="${index}"]`);
                const marginWaxEl = document.querySelector(`.building-margin-wax[data-index="${index}"]`);
                const revUsdMonthlyEl = document.querySelector(`.building-revenue-usd-monthly[data-index="${index}"]`);
                 
                if(costEl) costEl.textContent = formatWAX(dailyCostWax, 4);
                if(revEl) revEl.textContent = formatWAX(dailyRevenueWax, 4);
                if(marginWaxEl) {
                    marginWaxEl.textContent = formatWAX(dailyMarginWax, 4);
                    marginWaxEl.classList.toggle('text-green-400', dailyMarginWax >= 0);
                    marginWaxEl.classList.toggle('text-red-400', dailyMarginWax < 0);
                }
                if(revUsdMonthlyEl) {
                    revUsdMonthlyEl.textContent = formatUSD(monthlyMarginUsd, 2);
                    revUsdMonthlyEl.classList.toggle('text-green-400', monthlyMarginUsd >= 0);
                    revUsdMonthlyEl.classList.toggle('text-red-400', monthlyMarginUsd < 0);
                }
            });
             
            updateBuildingTotals();
            calculateBuildingPackResults(tokenPrices);
            
            // Si le scan a d√©j√† √©t√© fait, on met √† jour les gains Wallet
            if(scannedWalletData.length > 0) {
               calculateWalletEarnings(tokenPrices);
            }
        };

        // Calcule les totaux utilisateur (pied de page du tableau Section 9)
        const updateBuildingTotals = () => {
             const newPriceDovX = currentPriceDovX;
             const newPriceCostToken = currentPriceCostToken;
             const priceWaxUsd = currentPriceWaxUsd;
             
             let totalDailyTu = 0;
             let totalDailyRevWax = 0;
             let totalDailyMarginWax = 0;
             let totalMonthlyMarginUsd = 0;
             
             BUILDING_DATA.forEach(building => {
                 const qty = building.userQty;
                 if (qty > 0) {
                     const hourlyCostDovx = building.dovxCost;
                     const dailyCostWax = hourlyCostDovx * 24 * newPriceDovX;
                     
                     const dailyProdTu = building.prodPerHour * 24;
                     const dailyRevenueWax = dailyProdTu * newPriceCostToken;
                     
                     const dailyMarginWax = dailyRevenueWax - dailyCostWax;
                     const monthlyMarginUsd = dailyMarginWax * priceWaxUsd * DAYS_IN_MONTH;
                     
                     totalDailyTu += dailyProdTu * qty;
                     totalDailyRevWax += dailyRevenueWax * qty;
                     totalDailyMarginWax += dailyMarginWax * qty;
                     totalMonthlyMarginUsd += monthlyMarginUsd * qty;
                 }
             });
             
             if(userTotalTuDailyEl) userTotalTuDailyEl.textContent = formatUnits(totalDailyTu);
             if(userTotalRevenueWaxEl) userTotalRevenueWaxEl.textContent = formatWAX(totalDailyRevWax, 4);
             
             if(userTotalMarginWaxEl) {
                 userTotalMarginWaxEl.textContent = formatWAX(totalDailyMarginWax, 4);
                 userTotalMarginWaxEl.classList.toggle('text-green-400', totalDailyMarginWax >= 0);
                 userTotalMarginWaxEl.classList.toggle('text-red-400', totalDailyMarginWax < 0);
             }

             if(userTotalRevenueUsdMonthlyEl) {
                 userTotalRevenueUsdMonthlyEl.textContent = formatUSD(totalMonthlyMarginUsd, 2);
                 userTotalRevenueUsdMonthlyEl.classList.toggle('text-green-400', totalMonthlyMarginUsd >= 0);
                 userTotalRevenueUsdMonthlyEl.classList.toggle('text-red-400', totalMonthlyMarginUsd < 0);
             }
        };

        // Met √† jour les calculs du Cr√©ateur de Pack B√¢timent (Section 11)
        const calculateBuildingPackResults = (tokenPrices) => {
            const { newPriceDovX, newPriceCostToken, priceWaxUsd } = tokenPrices;

            const selectedIndex = parseInt(packBuildingSelect.value);
            const building = BUILDING_DATA[selectedIndex];
            const qty = Math.max(1, parseInt(packBuildingQtyInput.value) || 1);
            const multiplier = Math.max(1.00, parseFloat(packToolMultiplierInput.value) || 1.00);
            const pricePackUsd = parseFloat(packBuildingPriceInput.value) || 0;

            if (!building || priceWaxUsd <= 0 || newPriceDovX <= 0 || newPriceCostToken <= 0) {
                const defaultValue = '--';
                 if(packBuildingProdEl) packBuildingProdEl.textContent = defaultValue;
                 if(packBuildingOpExEl) packBuildingOpExEl.textContent = defaultValue;
                 if(packBuildingMonthlyNetEl) packBuildingMonthlyNetEl.textContent = defaultValue;
                 if(packBuildingRoiEl) packBuildingRoiEl.textContent = defaultValue;
                 if(packBuildingProdBaseEl) packBuildingProdBaseEl.textContent = `Base: ${defaultValue}`;
                 if(packBuildingRoiDaysEl) packBuildingRoiDaysEl.textContent = `${defaultValue} Jours`;
                 if(buildingPackCashBackUsdElement) buildingPackCashBackUsdElement.textContent = defaultValue;
                 if(buildingPackCashBackWaxElement) buildingPackCashBackWaxElement.textContent = defaultValue;
                 if(buildingPackPriceWaxElement) buildingPackPriceWaxElement.textContent = defaultValue;
                 return;
            }

            // 1. Prod
            const baseDailyProd = building.prodPerHour * 24 * qty;
            const totalDailyProd = baseDailyProd * multiplier;

            // 2. Revenue & OpEx
            const dailyRevenueWax = totalDailyProd * newPriceCostToken;
            const dailyCostDovx = building.dovxCost * 24 * qty;
            const dailyOpExWax = dailyCostDovx * newPriceDovX;

            // 3. Marge Nette
            const dailyNetWax = dailyRevenueWax - dailyOpExWax;
            const dailyNetUsd = dailyNetWax * priceWaxUsd;
            const monthlyNetUsd = dailyNetUsd * DAYS_IN_MONTH;
            const pricePackWax = (priceWaxUsd > 0) ? pricePackUsd / priceWaxUsd : 0;

            // 4. ROI
            let roiDays = Infinity;
            if (dailyNetUsd > 0 && pricePackUsd > 0) {
                roiDays = pricePackUsd / dailyNetUsd;
            } else if (pricePackUsd === 0 && dailyNetUsd > 0) {
                roiDays = 0; 
            }

            const roiPercentMonthly = (pricePackUsd > 0) ? (monthlyNetUsd / pricePackUsd) : 0;

            // 5. Cash Back
            const cashBackUsd = pricePackUsd * CASH_BACK_PERCENT;
            const cashBackWax = pricePackWax * CASH_BACK_PERCENT;

            // --- UI Update ---
            if(packBuildingProdEl) packBuildingProdEl.textContent = formatUnits(totalDailyProd) + ' TU';
            if(packBuildingProdBaseEl) packBuildingProdBaseEl.textContent = `Base: ${formatUnits(baseDailyProd)} TU (x${multiplier.toFixed(2)})`;
            if(packBuildingOpExEl) packBuildingOpExEl.textContent = formatWAX(dailyOpExWax, 4);
            
            if(packBuildingMonthlyNetEl) {
                packBuildingMonthlyNetEl.textContent = formatUSD(monthlyNetUsd, 2);
                packBuildingMonthlyNetEl.classList.toggle('text-emerald-400', monthlyNetUsd >= 0);
                packBuildingMonthlyNetEl.classList.toggle('text-red-400', monthlyNetUsd < 0);
            }

            if (packBuildingRoiEl) {
                if (roiDays === Infinity && monthlyNetUsd <= 0) {
                    packBuildingRoiEl.textContent = "Non Rentable";
                    packBuildingRoiEl.classList.add('text-red-400');
                    packBuildingRoiEl.classList.remove('text-yellow-400');
                } else {
                    packBuildingRoiEl.textContent = formatPercent(roiPercentMonthly, 2) + " / mois";
                    packBuildingRoiEl.classList.remove('text-red-400');
                    packBuildingRoiEl.classList.add('text-yellow-400');
                }
            }

            if(packBuildingRoiDaysEl) packBuildingRoiDaysEl.textContent = isFinite(roiDays) ? formatUnits(roiDays) + " Jours pour ROI" : "-- Jours";
            
            // FIX: Utilisation des √©l√©ments de la Section 11 (Maintenant uniques)
            if(buildingPackCashBackUsdElement) buildingPackCashBackUsdElement.textContent = formatUSD(cashBackUsd, 2);
            if(buildingPackCashBackWaxElement) buildingPackCashBackWaxElement.textContent = formatWAX(cashBackWax, 0);
            if(buildingPackPriceWaxElement) buildingPackPriceWaxElement.textContent = formatWAX(pricePackWax, 0);
        };

        // Calcule l'analyse de swap (Section 13.1)
        const calculateSwapAnalysis = async (tokenPrices) => {
            const { newPriceDovX } = tokenPrices;
            
            if (dovxCurrentWaxPriceDisplay) {
                 dovxCurrentWaxPriceDisplay.textContent = `*Prix DOVX/WAX actuel (Section 1): ${formatWAX(newPriceDovX, 8)}*`;
            }
            
            if (newPriceDovX <= 0 || !isFinite(newPriceDovX)) {
                if(swapAnalysisBody) swapAnalysisBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-400">Veuillez d√©finir un prix DOVX/WAX valide (Section 1).</td></tr>`;
                return;
            }

            // --- √âtat de chargement ---
            if(swapAnalysisBody) swapAnalysisBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-purple-400">Analyse des march√©s Alcor en cours (Live API)...</td></tr>`;
            if(btnArbitrageScan) {
                btnArbitrageScan.textContent = "Analyse en cours...";
                btnArbitrageScan.disabled = true;
                // Ajout de la classe de loading pour l'animation
                btnArbitrageScan.classList.add('ai-loading'); 
            }
            
            // --- Appel de la fonction d'API r√©el ---
            const liveSwapData = await fetchAlcorPrices();
            
            let html = '';
            let hasValidData = false;

            liveSwapData.forEach(pair => {
                let arbitrageGainText = '--';
                let colorClass = 'text-gray-500';

                if (pair.isMissingData) {
                    html += `
                        <tr class="hover:bg-gray-800/40">
                            <td class="p-3 font-semibold text-purple-200">DOVX / ${pair.token}</td>
                            <td class="p-3 text-right text-gray-500">${pair.priceTargetWax === null ? 'WAX/T non trouv√©' : formatWAX(pair.priceTargetWax, 6)}</td>
                            <td class="p-3 text-right text-purple-300">--</td>
                            <td class="p-3 text-right text-red-400">
                                --
                                <span class="text-xs text-red-500 block">March√© DOVX/${pair.token} non trouv√©</span>
                            </td>
                        </tr>
                    `;
                    return; // Passe √† la prochaine paire
                }

                hasValidData = true;
                const impliedWaxValue = pair.impliedWaxValue;
                
                // Calcul de l'opportunit√© d'arbitrage
                const diff = impliedWaxValue - newPriceDovX;
                const gainPercent = (diff / newPriceDovX);

                if (diff > 0) {
                    colorClass = 'text-green-400';
                    arbitrageGainText = formatPercent(gainPercent, 4);
                } else if (diff < 0) {
                    colorClass = 'text-red-400';
                    arbitrageGainText = formatPercent(gainPercent, 4); // Le pourcentage sera n√©gatif
                } else {
                    colorClass = 'text-yellow-400';
                    arbitrageGainText = '0,00 %';
                }

                html += `
                    <tr class="hover:bg-gray-800/40">
                        <td class="p-3 font-semibold text-purple-200">DOVX / ${pair.token} / WAX</td>
                        <td class="p-3 text-right text-gray-300">${formatWAX(pair.priceTargetWax, 8)}</td>
                        <td class="p-3 text-right text-purple-300">${formatWAX(impliedWaxValue, 8)}</td>
                        <td class="p-3 text-right font-bold ${colorClass}">
                            ${arbitrageGainText}
                            <span class="text-xs text-gray-500 block">Diff. Abs: ${formatWAX(diff, 8)}</span>
                        </td>
                    </tr>
                `;
            });
            
            // Mise √† jour de l'affichage final
            if(swapAnalysisBody) {
                swapAnalysisBody.innerHTML = html;
                if (!hasValidData) {
                     swapAnalysisBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-400">Aucune donn√©e de march√© valide n'a pu √™tre r√©cup√©r√©e pour l'arbitrage.</td></tr>`;
                }
            }

            // R√©tablir l'√©tat du bouton
            if(btnArbitrageScan) {
                btnArbitrageScan.textContent = "üîÑ Analyser les Swaps (Arbitrage)";
                btnArbitrageScan.disabled = false;
                btnArbitrageScan.classList.remove('ai-loading');
            }
        };
        
        // Calcule les quantit√©s de jetons pour le LP (Section 13.2)
        const calculateLpResults = (tokenPrices) => {
             const { newPriceDovX, newPriceCostToken } = tokenPrices;
             
             // --- Pool A: DOVX / WAX ---
             const waxAmountA = parseFloat(lpDovxWaxAmountInput.value) || 0;
             let dovxRequiredA = 0;
             if (newPriceDovX > 0) {
                 dovxRequiredA = waxAmountA / newPriceDovX;
             }
             const waxToDovxA = (newPriceDovX > 0) ? (1 / newPriceDovX) : Infinity;

             if (lpDovxWaxRequiredEl) lpDovxWaxRequiredEl.textContent = formatUnits(dovxRequiredA) + ' DOVX';
             if (lpDovxWaxPriceSpanEl) lpDovxWaxPriceSpanEl.textContent = formatUnits(waxToDovxA);


             // --- Pool B: TU / WAX ---
             const waxAmountB = parseFloat(lpTuWaxAmountInput.value) || 0;
             let tuRequiredB = 0;
             if (newPriceCostToken > 0) {
                 tuRequiredB = waxAmountB / newPriceCostToken;
             }
             const waxToTuB = (newPriceCostToken > 0) ? (1 / newPriceCostToken) : Infinity;

             if (lpTuWaxRequiredEl) lpTuWaxRequiredEl.textContent = formatUnits(tuRequiredB) + ' TU';
             if (lpTuWaxPriceSpanEl) lpTuWaxPriceSpanEl.textContent = formatUnits(waxToTuB);


             // --- Pool C: DOVX / TU ---
             const dovxAmountC = parseFloat(lpDovxTuAmountInput.value) || 0;
             let tuRequiredC = 0;
             let dovxToTuPrice = 0;
             let tuToDovxPrice = 0;

             if (newPriceDovX > 0 && newPriceCostToken > 0) {
                 dovxToTuPrice = newPriceDovX / newPriceCostToken;
                 tuToDovxPrice = 1 / dovxToTuPrice;
                 tuRequiredC = dovxAmountC * dovxToTuPrice;
             }

             if (lpDovxTuRequiredEl) lpDovxTuRequiredEl.textContent = formatUnits(tuRequiredC) + ' TU';
             if (lpDovxTuPriceSpanEl) lpDovxTuPriceSpanEl.textContent = formatUnits(dovxToTuPrice);
             if (lpTuDovxPriceSpanEl) lpTuDovxPriceSpanEl.textContent = formatUnits(tuToDovxPrice);
        };
        
        // --- NOUVEAU: Fonctions de suivi des Paires Alcor (Section 13.3) ---
        
        // Fonction pour formater M, K, etc. (pris du code React de l'utilisateur)
        const formatNumber = (num, decimals = 2) => {
             if (isNaN(num) || !isFinite(num)) return '0';
             if (num >= 1e6) return (num / 1e6).toFixed(decimals) + 'M';
             if (num >= 1e3) return (num / 1e3).toFixed(decimals) + 'K';
             return num.toFixed(decimals);
         };

        // 1. R√©cup√®re toutes les paires depuis l'API Alcor V2
        const fetchAllAlcorPairs = async () => {
            if (alcorPairsLoading) alcorPairsLoading.classList.remove('hidden');
            if (alcorPairsError) alcorPairsError.classList.add('hidden');
            
            const url = `${ALCOR_API_URL}/v2/markets?limit=1000&swap_enabled=true`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Erreur lors de la r√©cup√©ration des donn√©es Alcor V2.');
                }
                
                const data = await response.json();
                allAlcorPairsCache = data.rows || [];
                
                // Filtrer et afficher le jeton par d√©faut (DOVX)
                filterAlcorPairs(allAlcorPairsCache, selectedAlcorToken);
                
            } catch (error) {
                console.error("Erreur Alcor Pairs Finder:", error);
                if (alcorPairsError) {
                    alcorPairsError.textContent = 'Impossible de r√©cup√©rer les paires Alcor. V√©rifiez l\'API.';
                    alcorPairsError.classList.remove('hidden');
                }
                filterAlcorPairs([], selectedAlcorToken); // Afficher vide en cas d'erreur
            } finally {
                if (alcorPairsLoading) alcorPairsLoading.classList.add('hidden');
            }
        };

        // 2. Filtre et affiche les paires pour un jeton donn√©
        const filterAlcorPairs = (allData, token) => {
            if (alcorPairsBody) alcorPairsBody.innerHTML = '';
            if (alcorPairsEmpty) alcorPairsEmpty.classList.add('hidden');

            const filtered = allData.filter(pair => {
                const base = pair.base?.symbol?.name || '';
                const quote = pair.quote?.symbol?.name || '';
                return base === token || quote === token;
            });
            
            // Trier par liquidit√© (descendant)
            filtered.sort((a, b) => (b.liquidity || 0) - (a.liquidity || 0));
            
            if (filtered.length === 0) {
                 if (alcorPairsEmpty) {
                     alcorPairsEmpty.textContent = `Aucune paire trouv√©e pour ${token}.`;
                     alcorPairsEmpty.classList.remove('hidden');
                 }
                 return;
            }
            
            // Construire le HTML du tableau
            let html = '';
            filtered.forEach(pair => {
                const baseName = pair.base?.symbol?.name || '';
                const quoteName = pair.quote?.symbol?.name || '';
                const baseContract = pair.base?.symbol?.contract || '';
                const pairName = `${baseName}/${quoteName}`;
                const price = pair.last_price ? parseFloat(pair.last_price) : 0;
                
                html += `
                    <tr class="border-b border-slate-700/50 hover:bg-purple-500/10 transition-colors">
                        <td class="px-6 py-4 font-mono text-white">${pairName}</td>
                        <td class="px-6 py-4 text-right text-slate-300">${price ? price.toFixed(8) : '--'}</td>
                        <td class="px-6 py-4 text-right text-slate-300">${formatUSD(pair.liquidity || 0, 0)}</td>
                        <td class="px-6 py-4 text-right text-slate-300">${formatUSD(pair.volume24h_usd || 0, 0)}</td>
                        <td class="px-6 py-4 text-center">
                            <a
                                href="https://alcor.exchange/trade/${pair.market_id}"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="inline-block px-4 py-1 bg-purple-600 hover:bg-purple-500 text-white rounded transition-colors text-xs"
                            >
                                Trader
                            </a>
                        </td>
                    </tr>
                `;
            });
            
            if (alcorPairsBody) alcorPairsBody.innerHTML = html;
        };
        
        // --- Fin: Fonctions de suivi des Paires Alcor ---

        // --- Fonctions de Calcul Global ---

        // Fonction de calcul principale pour le volume (Sections 2-7)
        const calculateVolume = (tokenPrices) => {
            const { newPriceDovX, newPriceCostToken, priceWaxUsd } = tokenPrices;
            
            // 1. Inputs du volume
            const numberOfAccounts = parseInt(numberOfAccountsInput.value) || 0;
            const divisionsPerAccount = parseInt(divisionsPerAccountInput.value) || 0;
            const numberOfPacks = parseInt(numberOfPacksInput.value) || 0;
            const divisionsPerPack = parseInt(divisionsPerPackInput.value) || 0;
            const pricePerPackWax = parseFrenchFloat(pricePerPackWaxInput.value) || 0;
            const selectedZoneIndex = parseInt(zoneSelector.value);
            const selectedZone = ZONE_DATA[selectedZoneIndex];

            // Total Divisions en d√©ploiement
            const totalDivisionsDeployed = numberOfAccounts * divisionsPerAccount;
            const totalDivisionsPurchased = numberOfPacks * divisionsPerPack;

            // Mise √† jour de l'affichage du total des divisions achet√©es (capacit√©)
            if(document.getElementById('resultTotalDivisionsPurchased')) {
                document.getElementById('resultTotalDivisionsPurchased').textContent = formatUnits(totalDivisionsPurchased) + ' Divisions';
            }

            if (!selectedZone || totalDivisionsDeployed === 0 || priceWaxUsd <= 0 || newPriceDovX <= 0 || newPriceCostToken <= 0) {
                // R√©tablir l'affichage √† d√©faut
                const defaultValues = [
                    'resultCost', 'resultReward', 'resultNet', 'resultVolume',
                    'resultUsdCost', 'resultUsdReward', 'resultUsdVolume', 'resultNetUsd',
                    'resultNetUsdMonthly', 'resultNetUsdAnnual', 'resultUsdVolumeMonthly', 'resultUsdVolumeAnnual',
                    'resultTotalInvestment', 'resultRoiDays', 'resultRoiDailyPercent', 'resultRoiMonthlyPercent',
                    'cashBackUsd', 'cashBackWax', 'teamUsd', 'teamWax', 'marketTokenUsd', 'marketTokenWax', 'pubUsd', 'pubWax',
                    'totalInvestmentUsdDisplay', 'totalInvestmentWaxDisplay',
                ];
                defaultValues.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '--';
                });
                if(document.getElementById('resultRoiStatus')) document.getElementById('resultRoiStatus').textContent = '--';
                if(document.getElementById('totalWaxCostValue')) document.getElementById('totalWaxCostValue').textContent = '--';
                if(document.getElementById('unitCostWaxValue')) document.getElementById('unitCostWaxValue').textContent = "Unitaire TU: --";
                if(document.getElementById('unitsDovXGenerated')) document.getElementById('unitsDovXGenerated').textContent = '--';
                if(document.getElementById('ratioAmplification')) document.getElementById('ratioAmplification').textContent = '--';
                return;
            }

            // --- 2. Calculs quotidiens (par division unitaire) ---
            const dailyTuCostPerDivision = selectedZone.totalTuCost;
            const dailyDovxRewardPerDivision = selectedZone.dovxReward;
            
            const waxCostPerTu = newPriceCostToken;

            // Co√ªt unitaire (par division)
            const dailyWaxCostPerDivision = dailyTuCostPerDivision * waxCostPerTu;
            const dailyWaxRewardPerDivision = dailyDovxRewardPerDivision * newPriceDovX;

            // --- 3. Calculs agr√©g√©s (Volume) ---
            const totalDailyWaxCost = dailyWaxCostPerDivision * totalDivisionsDeployed;
            const totalDailyWaxReward = dailyWaxRewardPerDivision * totalDivisionsDeployed;
            const totalDailyNetWax = totalDailyWaxReward - totalDailyWaxCost;
            const totalDailyVolumeWax = totalDailyWaxCost + totalDailyWaxReward;

            // --- 4. Conversions USD ---
            const totalDailyNetUsd = totalDailyNetWax * priceWaxUsd;
            const totalDailyCostUsd = totalDailyWaxCost * priceWaxUsd;
            const totalDailyRewardUsd = totalDailyWaxReward * priceWaxUsd;
            const totalDailyVolumeUsd = totalDailyVolumeWax * priceWaxUsd;
            
            // --- 5. Projections (Mensuel / Annuel) ---
            const monthlyNetUsd = totalDailyNetUsd * DAYS_IN_MONTH;
            const annualNetUsd = totalDailyNetUsd * DAYS_IN_YEAR;
            const monthlyVolumeUsd = totalDailyVolumeUsd * DAYS_IN_MONTH;
            const annualVolumeUsd = totalDailyVolumeUsd * DAYS_IN_YEAR;

            // --- 6. ROI / Investissement ---
            const totalInvestmentWax = numberOfPacks * pricePerPackWax;
            const totalInvestmentUsd = totalInvestmentWax * priceWaxUsd;

            let roiDays = Infinity;
            let roiDailyPercent = 0;
            let roiMonthlyPercent = 0;
            let roiStatus = 'D√©ficitaire ou Investissement nul';

            if (totalInvestmentUsd > 0) {
                roiDailyPercent = totalDailyNetUsd / totalInvestmentUsd;
                roiMonthlyPercent = monthlyNetUsd / totalInvestmentUsd;
                
                if (totalDailyNetUsd > 0) {
                    roiDays = totalInvestmentUsd / totalDailyNetUsd;
                    roiStatus = `Rentable en ${formatUnits(roiDays)} jours`;
                } else if (totalDailyNetUsd < 0) {
                    roiStatus = 'D√©ficitaire';
                    roiDays = Infinity;
                } else {
                    roiStatus = 'Neutre (0$)';
                    roiDays = Infinity;
                }
            } else if (totalDivisionsDeployed > 0) {
                 roiStatus = 'Pas de Packs achet√©s (Production pure)';
                 roiDays = 0; 
                 roiDailyPercent = 1; // Gain imm√©diat
                 roiMonthlyPercent = Infinity;
            }

            // --- 7. R√©partition des Revenus des Packs (Section 7) ---
            const totalPacksInvestmentUsd = numberOfPacks * parseFrenchFloat(packDesignPriceUsdInput.value || 0);
            const totalPacksInvestmentWax = totalPacksInvestmentUsd / priceWaxUsd;

            const cbUsd = totalPacksInvestmentUsd * CASH_BACK_PERCENT;
            const tmUsd = totalPacksInvestmentUsd * TEAM_PERCENT;
            const mtUsd = totalPacksInvestmentUsd * MARKET_TOKEN_PERCENT;
            const pbUsd = totalPacksInvestmentUsd * PUB_PERCENT;

            const cbWax = totalPacksInvestmentWax * CASH_BACK_PERCENT;
            const tmWax = totalPacksInvestmentWax * TEAM_PERCENT;
            const mtWax = totalPacksInvestmentWax * MARKET_TOKEN_PERCENT;
            const pbWax = totalPacksInvestmentWax * PUB_PERCENT;

            // --- 8. Mise √† jour de la Table de Consommation (Section 6) ---
            const consumptionTableBody = document.getElementById('consumptionTableBody');
            if (consumptionTableBody) {
                consumptionTableBody.innerHTML = '';
                
                // Les co√ªts de combat par division sont divis√©s par 4 pour les 4 jetons TU
                const costPerTokenPerDivision = dailyTuCostPerDivision / COST_TOKENS.length;

                let sumTotalUnitsConsumedDaily = 0;
                let sumTotalWaxCostBase = 0;
                
                COST_TOKENS.forEach(token => {
                    const totalDailyUnits = costPerTokenPerDivision * totalDivisionsDeployed;
                    const dailyWaxCost = costPerTokenPerDivision * newPriceCostToken;
                    
                    sumTotalUnitsConsumedDaily += totalDailyUnits;
                    sumTotalWaxCostBase += dailyWaxCost;

                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-800/40';
                    tr.innerHTML = `
                        <td class="p-3 font-semibold text-red-300">${token}</td>
                        <td class="p-3 text-right">${formatUnits(costPerTokenPerDivision)} TU</td>
                        <td class="p-3 text-right font-bold text-red-400">${formatUnits(totalDailyUnits)} TU</td>
                        <td class="p-3 text-right">${formatWAX(dailyWaxCost, 6)}</td>
                    `;
                    consumptionTableBody.appendChild(tr);
                });

                if(document.getElementById('totalUnitsConsumedDaily')) document.getElementById('totalUnitsConsumedDaily').textContent = formatUnits(sumTotalUnitsConsumedDaily) + ' TU';
                if(document.getElementById('totalWaxCostDaily')) document.getElementById('totalWaxCostDaily').textContent = formatWAX(sumTotalWaxCostBase * totalDivisionsDeployed, 4);
                
                // Mise √† jour du pied de page du tableau pour la section 6
                if(document.getElementById('totalUnitsConsumedBase')) document.getElementById('totalUnitsConsumedBase').textContent = formatUnits(dailyTuCostPerDivision) + ' TU';
                if(document.getElementById('totalUnitsConsumedDailySum')) document.getElementById('totalUnitsConsumedDailySum').textContent = formatUnits(sumTotalUnitsConsumedDaily) + ' TU';
                if(document.getElementById('totalWaxCostBase')) document.getElementById('totalWaxCostBase').textContent = formatWAX(dailyWaxCostPerDivision, 4);

                if(document.getElementById('unitsDovXGenerated')) document.getElementById('unitsDovXGenerated').textContent = formatUnits(dailyDovxRewardPerDivision) + ' DOVX';
                
                // Ratio d'amplification (Combien d'unit√©s DOVX vs 1 unit√© TU)
                const amplificationRatio = (newPriceDovX > 0 && newPriceCostToken > 0) ? (newPriceDovX / newPriceCostToken) : 0;
                if(document.getElementById('ratioAmplification')) document.getElementById('ratioAmplification').textContent = formatUnits(amplificationRatio) + ' X';
            }


            // --- 9. Mise √† jour de l'affichage global (Sections 2-7) ---

            // Section 2: WAX
            if(document.getElementById('totalWaxCostValue')) document.getElementById('totalWaxCostValue').textContent = formatWAX(totalDailyWaxCost, 4);
            if(document.getElementById('unitCostWaxValue')) document.getElementById('unitCostWaxValue').textContent = "Unitaire TU: " + formatWAX(waxCostPerTu, 8);
            if(document.getElementById('resultReward')) document.getElementById('resultReward').textContent = formatWAX(totalDailyWaxReward, 4);
            
            if(document.getElementById('resultNet')) {
                document.getElementById('resultNet').textContent = formatWAX(totalDailyNetWax, 4);
                document.getElementById('resultNet').classList.toggle('text-green-400', totalDailyNetWax >= 0);
                document.getElementById('resultNet').classList.toggle('text-red-400', totalDailyNetWax < 0);
            }
            if(document.getElementById('resultVolume')) document.getElementById('resultVolume').textContent = formatWAX(totalDailyVolumeWax, 4);
            
            // Section 3: USD
            if(document.getElementById('resultUsdCost')) document.getElementById('resultUsdCost').textContent = formatUSD(totalDailyCostUsd, 4);
            if(document.getElementById('resultUsdReward')) document.getElementById('resultUsdReward').textContent = formatUSD(totalDailyRewardUsd, 4);
            if(document.getElementById('resultUsdVolume')) document.getElementById('resultUsdVolume').textContent = formatUSD(totalDailyVolumeUsd, 4);
            
            if(document.getElementById('resultNetUsd')) {
                document.getElementById('resultNetUsd').textContent = formatUSD(totalDailyNetUsd, 4);
                document.getElementById('resultNetUsd').classList.toggle('text-green-400', totalDailyNetUsd >= 0);
                document.getElementById('resultNetUsd').classList.toggle('text-red-400', totalDailyNetUsd < 0);
            }

            // Section 4: Projections
            if(document.getElementById('resultNetUsdMonthly')) document.getElementById('resultNetUsdMonthly').textContent = formatUSD(monthlyNetUsd, 2);
            if(document.getElementById('resultNetUsdAnnual')) document.getElementById('resultNetUsdAnnual').textContent = formatUSD(annualNetUsd, 0);
            if(document.getElementById('resultUsdVolumeMonthly')) document.getElementById('resultUsdVolumeMonthly').textContent = formatUSD(monthlyVolumeUsd, 0);
            if(document.getElementById('resultUsdVolumeAnnual')) document.getElementById('resultUsdVolumeAnnual').textContent = formatUSD(annualVolumeUsd, 0);

            // Section 5: ROI
            if(document.getElementById('resultTotalInvestment')) document.getElementById('resultTotalInvestment').textContent = formatWAX(totalInvestmentWax, 0);
            if(document.getElementById('resultRoiDays')) document.getElementById('resultRoiDays').textContent = isFinite(roiDays) ? formatUnits(roiDays) + ' Jours' : '--';
            if(document.getElementById('resultRoiStatus')) {
                 document.getElementById('resultRoiStatus').textContent = roiStatus;
                 document.getElementById('resultRoiStatus').classList.remove('text-green-400', 'text-red-400', 'text-yellow-400');
                 if (totalDailyNetUsd > 0) {
                     document.getElementById('resultRoiStatus').classList.add('text-green-400');
                 } else if (totalDailyNetUsd < 0) {
                     document.getElementById('resultRoiStatus').classList.add('text-red-400');
                 } else {
                     document.getElementById('resultRoiStatus').classList.add('text-yellow-400');
                 }
            }
            if(document.getElementById('resultRoiDailyPercent')) document.getElementById('resultRoiDailyPercent').textContent = formatPercent(roiDailyPercent, 4);
            if(document.getElementById('resultRoiMonthlyPercent')) document.getElementById('resultRoiMonthlyPercent').textContent = formatPercent(roiMonthlyPercent, 2);

            // Section 7: R√©partition des revenus (Packs)
            if(document.getElementById('totalInvestmentUsdDisplay')) document.getElementById('totalInvestmentUsdDisplay').textContent = formatUSD(totalPacksInvestmentUsd, 2);
            if(document.getElementById('totalInvestmentWaxDisplay')) document.getElementById('totalInvestmentWaxDisplay').textContent = formatWAX(totalPacksInvestmentWax, 0);
            
            if(document.getElementById('cashBackUsd')) document.getElementById('cashBackUsd').textContent = formatUSD(cbUsd, 2);
            if(document.getElementById('cashBackWax')) document.getElementById('cashBackWax').textContent = formatWAX(cbWax, 0);

            if(document.getElementById('teamUsd')) document.getElementById('teamUsd').textContent = formatUSD(tmUsd, 2);
            if(document.getElementById('teamWax')) document.getElementById('teamWax').textContent = formatWAX(tmWax, 0);

            if(document.getElementById('marketTokenUsd')) document.getElementById('marketTokenUsd').textContent = formatUSD(mtUsd, 2);
            if(document.getElementById('marketTokenWax')) document.getElementById('marketTokenWax').textContent = formatWAX(mtWax, 0);

            if(document.getElementById('pubUsd')) document.getElementById('pubUsd').textContent = formatUSD(pbUsd, 2);
            if(document.getElementById('pubWax')) document.getElementById('pubWax').textContent = formatWAX(pbWax, 0);
            
        };
        
        // Fonction qui regroupe tous les calculs lors d'un changement d'input
        const calculate = () => {
            // 1. Mise √† jour des prix des jetons et WAX/USD
            let newPriceDovX = parseFrenchFloat(dovxPriceManualInput.value) || 0;
            if (newPriceDovX < 0) newPriceDovX = 0; // S√©curit√©

            // Mise √† jour de la r√©glette si l'input manuel change
            if (dovxPriceSlider) dovxPriceSlider.value = newPriceDovX.toFixed(8);
            
            // Calcul du prix TU (bas√© sur le ratio fixe)
            let newPriceCostToken = newPriceDovX / DOVX_TO_TU_RATIO;
            if (newPriceDovX === 0) newPriceCostToken = 0; // √âviter l'Infinity si le ratio est 0

            // Mise √† jour des variables globales
            currentPriceDovX = newPriceDovX;
            currentPriceCostToken = newPriceCostToken;
            currentPriceWaxUsd = parseFrenchFloat(priceWaxUsdInput.value) || 0;

            // Mise √† jour de l'affichage du prix TU
            if(priceCostTokenCalculated) priceCostTokenCalculated.value = currentPriceCostToken.toLocaleString('fr-FR', { minimumFractionDigits: 8, maximumFractionDigits: 8 });

            const tokenPrices = { 
                newPriceDovX: currentPriceDovX, 
                newPriceCostToken: currentPriceCostToken, 
                priceWaxUsd: currentPriceWaxUsd 
            };
            
            // 2. Ex√©cuter les calculs pour toutes les sections
            calculateVolume(tokenPrices);        // Sections 2-7
            calculatePackDesign(tokenPrices);    // Section 8
            updateBuildingTable(tokenPrices);    // Section 9
            calculateLpResults(tokenPrices);     // Section 13.2
            
            // Note: Sniper (Section 12) et Arbitrage (Section 13.1) sont d√©clench√©s par bouton

        };
        
        // Fonction pour g√©rer l'appel Gemini API pour le Lore
        const handleAiLoreGeneration = async () => {
            if (!packNameInput.value || !packCompositionInput.value) {
                aiLoreOutput.textContent = "Veuillez entrer un nom de pack et une composition valide avant de g√©n√©rer le Lore.";
                aiLoreOutput.classList.remove('hidden', 'text-gray-300');
                aiLoreOutput.classList.add('text-red-400');
                return;
            }
            
            const packName = packNameInput.value;
            const composition = packCompositionInput.value;
            const price = packDesignPriceUsdInput.value;
            
            const userPrompt = `R√©dige un "Lore" ou une histoire courte, de fiction militaire (type Seconde Guerre Mondiale / Futuriste) pour le pack de jeu NFT "Dawn of Victory" suivant. Le Lore doit inclure : le nom du pack, sa composition, le prix, et une mission √©pique.
            - Nom du Pack: ${packName}
            - Composition: ${composition}
            - Prix estim√©: ${price} USD
            - Ton: √âpique, militaire, engageant.
            Limite la r√©ponse √† un seul paragraphe de 5 √† 7 lignes.`;
            
            const systemPrompt = "Vous √™tes un Ma√Ætre de Jeu (Game Master) expert en Lore militaire et science-fiction. Vous √©crivez des descriptions immersives et captivantes.";

            aiLoreOutput.classList.remove('text-red-400');
            aiLoreOutput.classList.add('text-gray-300');
            aiLoreOutput.textContent = "G√©n√©ration du Lore par l'IA en cours... Veuillez patienter.";
            aiLoreOutput.classList.remove('hidden');
            btnAiLore.disabled = true;
            btnAiLore.classList.add('ai-loading');


            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                // Google Search est d√©sactiv√© car nous g√©n√©rons de la fiction (lore).
            };

            try {
                const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Erreur: Contenu non g√©n√©r√© ou structure inattendue.";
                
                aiLoreOutput.textContent = generatedText.trim();
                aiLoreOutput.classList.remove('text-red-400');

            } catch (error) {
                console.error("Erreur lors de l'appel Gemini:", error);
                aiLoreOutput.textContent = `Erreur: √âchec de la communication avec l'IA. (${error.message})`;
                aiLoreOutput.classList.remove('text-gray-300');
                aiLoreOutput.classList.add('text-red-400');
            } finally {
                btnAiLore.disabled = false;
                btnAiLore.classList.remove('ai-loading');
            }
        };

        // --- Fonctions d'API r√©el (CoinGecko) ---
        const fetchLiveWaxPrice = async () => {
             const coinGeckoUrl = "https://api.coingecko.com/api/v3/simple/price?ids=wax&vs_currencies=usd";
             
             if(btnFetchPrice) {
                 btnFetchPrice.disabled = true;
                 btnFetchPrice.textContent = '...';
             }
             
             try {
                 const response = await fetch(coinGeckoUrl);
                 const data = await response.json();
                 
                 if (data && data.wax && data.wax.usd) {
                     const newPrice = data.wax.usd;
                     currentPriceWaxUsd = newPrice;
                     if(priceWaxUsdInput) {
                         priceWaxUsdInput.value = newPrice.toLocaleString('fr-FR', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
                     }
                     calculate(); // Recalculer avec le nouveau prix WAX/USD
                     return true;
                 }
                 throw new Error("Format de r√©ponse CoinGecko invalide.");
             } catch (error) {
                 console.error("Erreur lors de la r√©cup√©ration du prix WAX/USD:", error);
                 // R√©tablit le prix par d√©faut en cas d'√©chec
                 currentPriceWaxUsd = parseFrenchFloat(priceWaxUsdInput.value) || 0.05;
                 calculate(); // Calcule quand m√™me avec le prix manuel
                 return false;
             } finally {
                 if(btnFetchPrice) {
                     btnFetchPrice.disabled = false;
                     btnFetchPrice.textContent = 'üîÑ Live';
                 }
             }
        };
        
        // Fonction de gestion du scan du wallet (Section 10)
        const handleWalletScan = async () => {
            const walletAddress = walletAddressInput.value.trim().toLowerCase();
            if (!walletAddress) {
                // Remplac√© alert() par une boite de message temporaire si n√©cessaire, mais ici on le laisse dans la console
                console.error("Veuillez entrer une adresse WAX valide (ex: user.wam).");
                return;
            }

            if(btnScanWallet) {
                btnScanWallet.disabled = true;
                btnScanWallet.textContent = 'Scanning...';
                walletResultsContainer.classList.add('scanning');
            }
            
            scannedWalletData = [];
            walletAssetsBody.innerHTML = '';
            
            const limit = 1000;
            let page = 1;
            let totalAssets = 0;
            let fetchSuccessful = false;
            
            // Boucle pour essayer diff√©rents endpoints en cas d'√©chec
            for (const endpoint of ATOMIC_ENDPOINTS) {
                const baseAssetUrl = `${endpoint}?collection_name=${TARGET_COLLECTION_NAME}&schema_name=${TARGET_SCHEMA_NAME}&owner=${walletAddress}&limit=${limit}`;
                page = 1; // R√©initialiser la page pour chaque endpoint
                scannedWalletData = []; // Vider les donn√©es partielles
                totalAssets = 0;
                
                while (true) {
                     const url = `${baseAssetUrl}&page=${page}`;
                     try {
                         const response = await fetch(url);
                         const data = await response.json();
                         
                         if (data.success && data.data) {
                             if (data.data.length > 0) {
                                 scannedWalletData.push(...data.data);
                                 totalAssets += data.data.length;
                                 
                                 if (data.data.length < limit) {
                                     fetchSuccessful = true;
                                     break; // Fin de l'asset loading pour cet endpoint
                                 }
                                 page++;
                             } else {
                                 fetchSuccessful = true; // Succ√®s de l'API mais pas d'assets ou fin de la liste
                                 break;
                             }
                         } else {
                             // L'API r√©pond mais signale un √©chec (ex: 404, 500)
                             throw new Error(`API Error: ${data.message || 'Unknown API response error'}`);
                         }
                     } catch (error) {
                         console.error(`Erreur lors de la r√©cup√©ration des assets AtomicAssets (Endpoint ${endpoint}):`, error);
                         // Continuer √† essayer le prochain endpoint
                         break; 
                     }
                }
                
                if (fetchSuccessful) break; // Sortir de la boucle des endpoints si le fetch est r√©ussi
            }

            if(btnScanWallet) {
                btnScanWallet.disabled = false;
                btnScanWallet.textContent = 'Scanner le Portefeuille';
                walletResultsContainer.classList.remove('scanning');
            }
            
            if (!fetchSuccessful && totalAssets === 0) {
                 walletAssetsBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-red-400">√âchec de la connexion √† l'API AtomicAssets apr√®s plusieurs tentatives.</td></tr>`;
                 walletTotalBuildingsEl.textContent = '0';
                 walletMonthlyWaxEl.textContent = '--';
                 walletMonthlyUsdEl.textContent = '--';
                 walletScenarioSummary.textContent = "Erreur de connexion. V√©rifiez l'adresse WAX et r√©essayez.";
                 walletResultsContainer.classList.remove('hidden');
                 return;
            }
            
            // Calculer les gains avec les donn√©es r√©cup√©r√©es
            calculateWalletEarnings({ 
                newPriceDovX: currentPriceDovX, 
                newPriceCostToken: currentPriceCostToken, 
                priceWaxUsd: currentPriceWaxUsd 
            });

            walletTotalBuildingsEl.textContent = totalAssets.toLocaleString();
            walletResultsContainer.classList.remove('hidden');

            if (totalAssets === 0) {
                walletAssetsBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-400">Aucun b√¢timent de production DovDivision trouv√©.</td></tr>`;
                walletScenarioSummary.textContent = "Aucun actif trouv√©. Vos gains mensuels sont de 0 $ pour cette simulation.";
            }

        };
        
        // Calcule les gains du wallet √† partir des donn√©es `scannedWalletData`
        const calculateWalletEarnings = (tokenPrices) => {
             const { newPriceDovX, newPriceCostToken, priceWaxUsd } = tokenPrices;
             
             let totalMonthlyNetWax = 0;
             let bodyHtml = '';
             let maxProfitBuilding = null;
             let maxProfit = -Infinity;

             // Regrouper les assets par template pour ne pas avoir 1000 lignes
             const groupedAssets = {};
             scannedWalletData.forEach(asset => {
                 const templateId = asset.template_id;
                 const buildingTemplate = BUILDING_DATA.find(b => templateId.toString().includes(b.rarityCode + '_F')); 
                 
                 if (!buildingTemplate) return; 

                 if (!groupedAssets[templateId]) {
                     groupedAssets[templateId] = {
                         name: buildingTemplate.name,
                         cssClass: buildingTemplate.cssClass,
                         qty: 0,
                         monthlyNetUsd: 0,
                         dailyNetWax: 0
                     };
                 }
                 groupedAssets[templateId].qty += 1;
                 
                 // Calcul de la marge journali√®re (bas√© sur la Section 9)
                 const dailyCostDovx = buildingTemplate.dovxCost * 24;
                 const dailyCostWax = dailyCostDovx * newPriceDovX;
                 
                 const dailyProdTu = buildingTemplate.prodPerHour * 24;
                 const dailyRevenueWax = dailyProdTu * newPriceCostToken;
                 
                 const dailyNetWax = dailyRevenueWax - dailyCostWax;
                 const monthlyNetWax = dailyNetWax * DAYS_IN_MONTH;
                 const monthlyNetUsd = monthlyNetWax * priceWaxUsd;
                 
                 groupedAssets[templateId].monthlyNetUsd += monthlyNetUsd;
                 groupedAssets[templateId].dailyNetWax = dailyNetWax;
                 
                 totalMonthlyNetWax += monthlyNetWax;

                 // Suivi du meilleur b√¢timent (pour le r√©sum√© du sc√©nario)
                 if (monthlyNetUsd > maxProfit) {
                    maxProfit = monthlyNetUsd;
                    maxProfitBuilding = buildingTemplate.name;
                 }
             });
             
             // Affichage dans le tableau
             for (const templateId in groupedAssets) {
                 const assetGroup = groupedAssets[templateId];
                 bodyHtml += `
                     <tr>
                         <td class="p-3 text-left ${assetGroup.cssClass} font-semibold">${assetGroup.name}</td>
                         <td class="p-3 text-center">${assetGroup.qty}</td>
                         <td class="p-3 text-right font-bold ${assetGroup.monthlyNetUsd >= 0 ? 'text-green-400' : 'text-red-400'}">${formatUSD(assetGroup.monthlyNetUsd, 2)}</td>
                     </tr>
                 `;
             }
             
             const totalMonthlyNetUsd = totalMonthlyNetWax * priceWaxUsd;

             walletAssetsBody.innerHTML = bodyHtml;
             
             if (walletMonthlyWaxEl) walletMonthlyWaxEl.textContent = formatWAX(totalMonthlyNetWax, 0);
             if (walletMonthlyUsdEl) {
                 walletMonthlyUsdEl.textContent = formatUSD(totalMonthlyNetUsd, 2);
                 walletMonthlyUsdEl.classList.toggle('text-green-400', totalMonthlyNetUsd >= 0);
                 walletMonthlyUsdEl.classList.toggle('text-red-400', totalMonthlyNetUsd < 0);
             }

             // Mise √† jour du r√©sum√© de sc√©nario
             if (walletScenarioSummary) {
                 if (totalMonthlyNetUsd > 0) {
                     walletScenarioSummary.textContent = `Sc√©nario actuel: Votre portefeuille (soit ${scannedWalletData.length} b√¢timents) g√©n√®re un rendement net de ${formatUSD(totalMonthlyNetUsd, 2)} par mois. Votre meilleur gain unitaire est pour le ${maxProfitBuilding} (si pr√©sent).`;
                 } else if (totalMonthlyNetUsd < 0) {
                     walletScenarioSummary.textContent = `Sc√©nario critique: Votre portefeuille a un d√©ficit net de ${formatUSD(totalMonthlyNetUsd, 2)} par mois. Vos co√ªts op√©rationnels d√©passent les revenus.`;
                 } else {
                     walletScenarioSummary.textContent = "Sc√©nario neutre: Votre portefeuille est √† l'√©quilibre (0 $ de gain net mensuel).";
                 }
             }

        };
        
        // Fonction de gestion du Sniper de March√© (Section 12)
        const handleMarketScan = async () => {
            if (!currentPriceDovX || !currentPriceCostToken || !currentPriceWaxUsd) {
                console.error("Veuillez d√©finir les prix WAX/USD, DOVX/WAX et TU/WAX (Section 1).");
                return;
            }

            if(btnScanMarket) {
                btnScanMarket.disabled = true;
                btnScanMarket.textContent = 'Scanning...';
                marketSniperSection.classList.add('scanning');
            }
            marketResultsContainer.classList.add('hidden');
            marketDealsBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-yellow-400">Recherche des meilleures offres en cours sur AtomicHub...</td></tr>`;

            const maxRoiDays = parseInt(marketRoiFilter.value) || 365;
            
            const limit = 100;
            let page = 1;
            let allSales = [];
            let fetchSuccessful = false;
            
            // Boucle pour essayer diff√©rents endpoints
            for (const endpoint of ATOMIC_MARKET_ENDPOINTS) {
                const baseMarketUrl = `${endpoint}?collection_name=${TARGET_COLLECTION_NAME}&schema_name=${TARGET_SCHEMA_NAME}&state=1&limit=${limit}&order=asc&sort=price`;
                page = 1; 
                allSales = [];
                
                while (true) {
                     const url = `${baseMarketUrl}&page=${page}`;
                     try {
                         const response = await fetch(url);
                         const data = await response.json();
                         
                         if (data.success && data.data && data.data.length > 0) {
                             allSales.push(...data.data);
                             fetchSuccessful = true;
                             
                             if (data.data.length < limit || page >= 5) break; 
                             page++;
                         } else {
                             fetchSuccessful = true; 
                             break;
                         }
                     } catch (error) {
                         console.error(`Erreur lors de la r√©cup√©ration des ventes AtomicMarket (Endpoint ${endpoint}):`, error);
                         break;
                     }
                }
                
                if (fetchSuccessful) break; 
            }
            
            // Traitement des donn√©es
            let dealHtml = '';
            let profitableDeals = 0;

            allSales.forEach(sale => {
                const waxPrice = parseFloat(sale.listing_price) / (10 ** parseInt(sale.listing_symbol.split(',')[0]));
                
                // Trouver les stats du b√¢timent correspondant
                // Nous devons parcourir les assets de la vente, mais on suppose un seul asset pour ce type de vente
                const asset = sale.assets[0];
                if (!asset || !asset.template || !asset.template.immutable_data) return;
                
                const assetName = asset.template.immutable_data.name;
                const buildingTemplate = BUILDING_DATA.find(b => assetName.includes(b.type)); 
                
                if (!buildingTemplate) return; 

                // Calcul de la rentabilit√© (identique √† Section 9)
                const dailyCostDovx = buildingTemplate.dovxCost * 24;
                const dailyCostWax = dailyCostDovx * currentPriceDovX;
                const dailyProdTu = buildingTemplate.prodPerHour * 24;
                const dailyRevenueWax = dailyProdTu * currentPriceCostToken;
                const dailyNetWax = dailyRevenueWax - dailyCostWax;

                // Calcul du ROI
                let roiDays = Infinity;
                if (dailyNetWax > 0 && waxPrice > 0) {
                    roiDays = waxPrice / dailyNetWax;
                }
                
                if (roiDays <= maxRoiDays && roiDays > 0) {
                    profitableDeals++;
                    
                    const priceClass = (waxPrice < (maxRoiDays * dailyNetWax)) ? 'text-green-300' : 'text-yellow-300';
                    const roiClass = (roiDays <= 180) ? 'bg-green-900/40 text-green-300' : 'bg-yellow-900/40 text-yellow-300';
                    const marketLink = `https://wax.atomichub.io/explorer/asset/${asset.asset_id}`;

                    dealHtml += `
                        <tr class="hover:bg-gray-800/60">
                            <td class="p-3 text-left font-semibold ${buildingTemplate.cssClass}">
                                ${buildingTemplate.name}
                            </td>
                            <td class="p-3 text-right ${priceClass} font-bold">${formatWAX(waxPrice, 2)}</td>
                            <td class="p-3 text-right text-green-400">${formatWAX(dailyNetWax, 4)}</td>
                            <td class="p-3 text-center">
                                <span class="py-1 px-2 rounded-lg text-xs font-bold ${roiClass}">${roiDays.toFixed(1)} Jours</span>
                            </td>
                            <td class="p-3 text-center">
                                <a href="${marketLink}" target="_blank" class="text-blue-400 hover:text-blue-300 transition-colors text-xs font-medium">Voir l'offre</a>
                            </td>
                        </tr>
                    `;
                }
            });

            // Affichage des r√©sultats
            if(marketDealsBody) {
                if (profitableDeals > 0) {
                    marketDealsBody.innerHTML = dealHtml;
                } else {
                    marketDealsBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">Aucune offre trouv√©e respectant un ROI maximum de ${maxRoiDays} jours.</td></tr>`;
                }
            }
            marketResultsContainer.classList.remove('hidden');

            // R√©tablir l'√©tat du bouton
            if(btnScanMarket) {
                btnScanMarket.disabled = false;
                btnScanMarket.textContent = 'üîç Scanner les Offres (ROI)';
                marketSniperSection.classList.remove('scanning');
            }
        };

        // Fonction d'initialisation du widget MoonPay (Section 14)
        const initializeMoonPayWidget = () => {
             // Cl√© API MoonPay de DEMO (Sandbox)
             const MOONPAY_API_KEY = 'pk_test_Yc1lYlG7E4yV7m5vH2N2J2F7b4Y2c3'; 
             const MOONPAY_BASE_URL = 'https://buy-staging.moonpay.com/'; // Staging URL

             const widgetContainer = document.getElementById('moonpayWidgetContainer');
             if (!widgetContainer) return;
             
             // Adresse de destination WAX. Ici on utilise une adresse fictive pour la d√©mo.
             const defaultWalletAddress = walletAddressInput.value.trim() || 'user.wam';
             
             // Note: En production, le signature HMAC est OBLIGATOIRE pour la s√©curit√©
             const moonpayUrl = `${MOONPAY_BASE_URL}?apiKey=${MOONPAY_API_KEY}` +
                                `&currencyCode=wax` +
                                `&walletAddress=${defaultWalletAddress}` +
                                `&theme=dark` +
                                `&colorCode=%2300C3A0` + // Teal-like color
                                `&currencyCode=wax` + 
                                `&paymentMethod=credit_card`; // Forcing credit card first
                                
             const iframe = document.createElement('iframe');
             iframe.src = moonpayUrl;
             iframe.width = '100%';
             iframe.height = '100%';
             iframe.frameBorder = '0';
             iframe.allow = 'payment';
             
             // Vider et injecter
             widgetContainer.innerHTML = '';
             widgetContainer.appendChild(iframe);
             
             // Afficher la section 14
             const moonpaySection = document.getElementById('moonpaySection');
             if (moonpaySection) moonpaySection.classList.remove('hidden');
        };

        // --- Listeners et Initialisation ---
        
        // Listeners pour les inputs manuels de la Section 1
        const inputsToWatch = [
            zoneSelector, packDesignZoneSelector, priceWaxUsdInput, 
            numberOfAccountsInput, divisionsPerAccountInput, numberOfPacksInput, 
            divisionsPerPackInput, pricePerPackWaxInput, dovxPriceManualInput, 
            packDesignPriceUsdInput, packBuildingSelect, packBuildingQtyInput,
            packToolMultiplierInput, packBuildingPriceInput,
            lpDovxWaxAmountInput, lpTuWaxAmountInput, lpDovxTuAmountInput // LP Inputs
        ];

        inputsToWatch.forEach(input => {
            input.addEventListener('input', calculate);
        });
        
        // Listener pour la r√©glette DOVX (pour que l'input et la r√©glette restent synchronis√©s)
        if (dovxPriceSlider) {
             dovxPriceSlider.addEventListener('input', (e) => {
                 const sliderValue = parseFloat(e.target.value);
                 if (dovxPriceManualInput) {
                     dovxPriceManualInput.value = sliderValue.toLocaleString('fr-FR', { minimumFractionDigits: 8, maximumFractionDigits: 8 });
                 }
                 calculate(); // D√©clenche le recalcul
             });
        }
        
        // Listener pour le bouton Live Price
        if (btnFetchPrice) {
            btnFetchPrice.addEventListener('click', fetchLiveWaxPrice);
        }
        
        // Listener pour le bouton IA Lore
        if (btnAiLore) {
            btnAiLore.addEventListener('click', handleAiLoreGeneration);
        }

        // Listener pour le bouton Scan Wallet
        if (btnScanWallet) {
            btnScanWallet.addEventListener('click', handleWalletScan);
        }

        // Listener pour le bouton Market Sniper
        if (btnScanMarket) {
            btnScanMarket.addEventListener('click', handleMarketScan);
        }
        
        // Listener pour le bouton Arbitrage Scan
        const handleArbitrageScan = () => {
            const tokenPrices = { 
                newPriceDovX: currentPriceDovX, 
                newPriceCostToken: currentPriceCostToken, 
                priceWaxUsd: currentPriceWaxUsd 
            };
            calculateSwapAnalysis(tokenPrices);
        };
        if (btnArbitrageScan) {
            btnArbitrageScan.addEventListener('click', handleArbitrageScan);
        }

        // Initialisation du DOM au chargement
        window.onload = function() {
            console.log("D√©marrage de l'initialisation du simulateur...");
            
            // 1. Initialisation des donn√©es statiques du DOM
            initializeSelectors();
            initializeBuildingTable();
            
            // 2. Configuration initiale des prix
            const initialDovxValue = REFERENCE_DOVX;
            currentPriceDovX = initialDovxValue; 
            currentPriceCostToken = REFERENCE_TU; 
            
            // Setup DOVX input initial state (DOM updates for initial state)
            if (dovxPriceManualInput) dovxPriceManualInput.value = initialDovxValue.toLocaleString('fr-FR', { minimumFractionDigits: 8, maximumFractionDigits: 8 });
            if (dovxPriceSlider) dovxPriceSlider.value = initialDovxValue.toFixed(8);
            if(priceCostTokenCalculated) priceCostTokenCalculated.value = currentPriceCostToken.toLocaleString('fr-FR', { minimumFractionDigits: 8, maximumFractionDigits: 8 });
            
            // Tente de r√©cup√©rer le prix WAX/USD, sinon utilise le d√©faut
            fetchLiveWaxPrice(); 
            
            // Lancer la r√©cup√©ration des paires Alcor au d√©marrage (Section 13.3)
            fetchAllAlcorPairs(); 

            // Initialiser l'analyse de swap au chargement √©galement (similaire aux autres sections)
            // handleArbitrageScan(); // L'arbitrage est co√ªteux en appels API. Mieux vaut le laisser se faire via le bouton apr√®s le calcul initial.
            
            // Initialisation du widget MoonPay
            initializeMoonPayWidget();

            console.log("Simulateur charg√© et d√©verrouill√©.");

        };

    </script>
</body>
</html>
