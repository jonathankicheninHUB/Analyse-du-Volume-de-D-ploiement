<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur √âconomique Dawn of Victory</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuration de la police Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fond sombre pour un th√®me financier/gaming */
        }
        .card {
            background-color: #161b22;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.5);
            border: 1px solid #30363d;
        }
        .input-style {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #ffffff;
        }
        .result-label {
            color: #9e9e9e;
        }
        .result-value {
            font-weight: 700;
            color: #c9d1d9;
        }
        /* Animation pour le chargement AI */
        @keyframes pulse-purple {
            0%, 100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); }
        }
        .ai-loading {
            animation: pulse-purple 2s infinite;
        }
        /* Styles pour le tableau des b√¢timents */
        .rarity-commun { color: #9ca3af; }
        .rarity-rare { color: #3b82f6; }
        .rarity-epic { color: #a855f7; }
        .rarity-legendary { color: #eab308; }
        .rarity-supreme { color: #ef4444; text-shadow: 0 0 5px rgba(239, 68, 68, 0.5); }
    </style>
</head>
<body class="text-white p-4 sm:p-8 min-h-screen flex justify-center items-start">

    <div id="app" class="w-full max-w-5xl space-y-8 mt-10">

        <h1 class="text-3xl font-bold text-center text-teal-400 mb-6">
            Analyse du Volume de D√©ploiement Multi-Comptes <span class="text-yellow-400">(Live WAX)</span>
        </h1>

        <!-- Section des Param√®tres d'Entr√©e -->
        <div class="card p-6 rounded-xl space-y-6">
            <h2 class="text-xl font-semibold border-b border-gray-700 pb-3 text-blue-300">
                1. Param√®tres d'Entr√©e (Prix & Configuration)
            </h2>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                
                <!-- Nombre de Comptes -->
                <div>
                    <label for="numberOfAccounts" class="block text-sm font-medium result-label">Nombre de Comptes</label>
                    <input type="number" id="numberOfAccounts" value="1" min="1" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" inputmode="numeric">
                </div>

                <!-- Divisions par Compte (D√©ploy√©es) -->
                <div>
                    <label for="divisionsPerAccount" class="block text-sm font-medium result-label">Divisions par Compte (D√©ploy√©es)</label>
                    <input type="number" id="divisionsPerAccount" value="3" min="1" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" inputmode="numeric">
                </div>
                
                <!-- S√©lecteur de Zone (pour le Volume) -->
                <div>
                    <label for="zoneSelector" class="block text-sm font-medium result-label">S√©lectionner la Zone de D√©ploiement (Volume)</label>
                    <select id="zoneSelector" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-teal-500 focus:border-teal-500 appearance-none">
                        <!-- Options seront remplies par JS -->
                    </select>
                </div>
                
                <!-- Prix WAX/USD -->
                <div>
                    <label for="priceWaxUsd" class="block text-sm font-medium result-label">Prix d'un WAX en USD ($)</label>
                    <input type="text" id="priceWaxUsd" value="0,05" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-pink-500 focus:border-pink-500" inputmode="decimal">
                </div>
            </div>

            <!-- Investment Packs and Price (VOLUME) -->
            <div class="border-t border-gray-800 pt-4">
                <h3 class="text-sm font-medium result-label mb-3 text-lime-300">
                    Volume de Packs Achet√©s (Base pour Sections 2-7)
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Nombre de Packs -->
                    <div>
                        <label for="numberOfPacks" class="block text-sm font-medium result-label">Nombre de Packs Achet√©s (Volume)</label>
                        <input type="number" id="numberOfPacks" value="1" min="0" max="100" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-lime-500 focus:border-lime-500" inputmode="numeric">
                    </div>

                    <!-- Divisions par Pack (Utilis√© pour le volume et le design du Pack) -->
                    <div>
                        <label for="divisionsPerPack" class="block text-sm font-medium result-label">Divisions par Pack Design√©/Achet√©</label>
                        <input type="number" id="divisionsPerPack" value="10" min="0" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-lime-500 focus:border-lime-500" inputmode="numeric">
                    </div>

                    <!-- Prix par Pack (USD) - CHAMP D'ENTR√âE -->
                    <div>
                        <label for="pricePerPackUsd" class="block text-sm font-medium result-label">Prix par Pack (en USD $) [Volume]</label>
                        <input type="text" id="pricePerPackUsd" value="50,00" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-lime-500 focus:border-lime-500" inputmode="decimal">
                    </div>
                    <!-- Prix par Pack (WAX) - AUTOMATIQUE -->
                    <div>
                        <label for="pricePerPackWax" class="block text-sm font-medium result-label">Prix par Pack (en WAX) [Volume Auto]</label>
                        <input type="text" id="pricePerPackWax" value="--,-" readonly class="input-style mt-1 block w-full p-2.5 rounded-lg text-lime-400" title="Calcul√©: Prix USD / WAX/USD" inputmode="decimal">
                    </div>
                </div>
                
                 <!-- Total Divisions Achet√©es (NOUVEL AFFICHAGE) -->
                <div class="mt-4 p-3 bg-indigo-900/30 rounded-lg border border-indigo-700">
                     <p class="text-sm result-label">Total Divisions Achet√©es (Capacit√©)</p>
                     <p id="resultTotalDivisionsPurchased" class="text-xl mt-1 text-indigo-300 font-bold">--</p>
                </div>
            </div>
            
            <!-- Contr√¥le du prix des tokens via slider (R√©glette DOVX) -->
            <div class="border-t border-gray-800 pt-4">
                <label class="block text-sm font-medium result-label mb-2 text-teal-300">
                    Ajuster le Prix du $DOVX$ (Le co√ªt $TU$ suit le m√™me ratio)
                </label>
                <div class="relative pt-2">
                    <!-- Slider: 200 √† 200000 pour une plage de 0.00200000 √† 2.00000000 WAX -->
                    <input type="range" id="dovxPriceSlider" min="200" max="200000" value="529" step="1" 
                           class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer transition duration-150 ease-in-out" 
                           oninput="document.getElementById('sliderValueDisplay').textContent=formatPriceDisplay(this.value)">
                    <p class="mt-2 text-sm text-gray-400 flex justify-between">
                        <span>Min WAX: <span id="minWaxDisplay" class="text-white">--</span></span>
                        <span class="text-yellow-400 font-bold">Prix actuel du $DOVX$: <span id="sliderValueDisplay">--</span> WAX</span>
                        <span>Max WAX: <span id="maxWaxDisplay" class="text-white">--</span></span>
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 border-t border-gray-800 pt-4">
                <!-- Prix du Jeton de R√©compense (Affichage) -->
                <div>
                    <label for="priceDovX" class="block text-sm font-medium result-label">Prix WAX du Jeton de R√©compense (DOVX) [Automatique]</label>
                    <input type="text" id="priceDovX" value="0,00528552" readonly class="input-style mt-1 block w-full p-2.5 rounded-lg text-green-400" title="Contr√¥l√© par la r√©glette" inputmode="decimal">
                </div>
                <!-- Prix des Jetons de Co√ªt (Affichage) -->
                <div>
                    <label for="priceCostToken" class="block text-sm font-medium result-label">Prix WAX des Jetons de Co√ªt (TU) [Automatique]</label>
                    <input type="text" id="priceCostToken" value="0,00045262" readonly class="input-style mt-1 block w-full p-2.5 rounded-lg text-red-400" title="Ajust√© automatiquement par ratio" inputmode="decimal">
                </div>
            </div>

        </div>

        <!-- Section des R√©sultats en WAX -->
        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-semibold border-b border-gray-700 pb-3 text-purple-300 mb-6">
                2. Volume de 24h en WAX (Total pour toutes les divisions)
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

                <!-- Co√ªt Total WAX (Demande) - MISE √Ä JOUR POUR LE CO√õT UNITAIRE WAX TU -->
                <div class="p-3 bg-red-900/30 rounded-lg">
                    <p class="text-sm result-label">Co√ªt Total (Demande)</p>
                    <p id="resultCost" class="text-2xl mt-1 text-red-400 result-value flex flex-col items-start">
                        <span id="totalWaxCostValue">--</span>
                        <span id="unitCostWaxValue" class="text-sm font-normal text-gray-400 mt-1">"Unitaire TU: --"</span>
                    </p>
                </div>

                <!-- R√©compense Totale WAX (Offre) -->
                <div class="p-3 bg-green-900/30 rounded-lg">
                    <p class="text-sm result-label">R√©compense Totale (Offre DOVX)</p>
                    <p id="resultReward" class="text-2xl mt-1 text-green-400 result-value">--</p>
                </div>

                <!-- Marge Nette WAX -->
                <div class="p-3 bg-gray-800 rounded-lg">
                    <p class="text-sm result-label">Marge/D√©ficit Nette (WAX)</p>
                    <p id="resultNet" class="text-2xl mt-1 result-value">--</p>
                </div>

                <!-- Volume Transactionnel Total WAX -->
                <div class="p-3 bg-blue-900/30 rounded-lg">
                    <p class="text-sm result-label">Volume Transactionnel Total (24h)</p>
                    <p id="resultVolume" class="text-2xl mt-1 text-blue-400 result-value">--</p>
                </div>
            </div>
        </div>

        <!-- Section des R√©sultats en USD (Journalier) -->
        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-semibold border-b border-gray-700 pb-3 text-pink-300 mb-6">
                3. Volume de 24h en USD (Total pour toutes les divisions)
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <!-- Co√ªt Total USD -->
                <div class="p-3 bg-red-900/30 rounded-lg">
                    <p class="text-sm result-label">Co√ªt Total (Demande)</p>
                    <p id="resultUsdCost" class="text-2xl mt-1 text-red-400 result-value">--</p>
                </div>

                <!-- R√©compense Totale USD -->
                <div class="p-3 bg-green-900/30 rounded-lg">
                    <p class="text-sm result-label">R√©compense Totale (Offre DOVX)</p>
                    <p id="resultUsdReward" class="text-2xl mt-1 text-green-400 result-value">--</p>
                </div>

                <!-- Volume Transactionnel Total USD (24h) -->
                <div class="p-3 bg-blue-900/30 rounded-lg">
                    <p class="text-sm result-label">Volume Transactionnel Total</p>
                    <p id="resultUsdVolume" class="text-2xl mt-1 text-blue-400 result-value">--</p>
                </div>
            </div>
            
             <!-- Marge Nette USD (Affiche seule pour bien la mettre en √©vidence) -->
            <div class="mt-6 pt-4 border-t border-gray-700">
                <p class="text-sm result-label">Marge/D√©ficit Nette (USD $)</p>
                <p id="resultNetUsd" class="text-3xl mt-1 result-value">--</p>
            </div>
        </div>

        <!-- AI ADVISOR SECTION -->
        <div class="card p-6 rounded-xl border border-purple-500/30 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                <svg class="w-32 h-32 text-purple-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/><path d="M12 6a1 1 0 0 0-1 1v4.59L8.29 14.3a1 1 0 0 0 1.42 1.4l3-3A1 1 0 0 0 13 12V7a1 1 0 0 0-1-1z"/></svg>
            </div>
            
            <h2 class="text-xl font-semibold border-b border-purple-500/50 pb-3 text-purple-300 mb-4 flex items-center">
                <span class="text-2xl mr-2">‚ú®</span> Conseiller Strat√©gique IA
            </h2>
            
            <p class="text-sm text-gray-400 mb-4">
                Demandez √† l'IA d'analyser vos donn√©es financi√®res actuelles et de vous fournir un rapport tactique d'investissement.
            </p>

            <button id="btnAiAdvisor" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-6 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span>G√©n√©rer Rapport Strat√©gique ‚ú®</span>
            </button>

            <div id="aiAdvisorOutput" class="hidden mt-4 p-4 bg-purple-900/20 border border-purple-500/30 rounded-lg text-gray-200 text-sm italic leading-relaxed">
                <!-- Le contenu de l'IA appara√Ætra ici -->
            </div>
        </div>

        <!-- Section des Projections (Mensuel & Annuel) -->
        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-semibold border-b border-gray-700 pb-3 text-fuchsia-300 mb-6">
                4. Projections en USD (Mois & Ann√©e)
            </h2>

            <!-- LIGNE 1: Marge Nette -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Marge Nette Mensuelle USD -->
                <div class="p-4 bg-gray-900 rounded-lg border border-teal-700">
                    <p class="text-sm result-label">Marge Nette Mensuelle (USD $)</p>
                    <p id="resultNetUsdMonthly" class="text-3xl mt-1 result-value text-teal-400">--</p>
                </div>
                <!-- Marge Nette Annuelle USD -->
                <div class="p-4 bg-gray-900 rounded-lg border border-teal-700">
                    <p class="text-sm result-label">Marge Nette Annuelle (USD $)</p>
                    <p id="resultNetUsdAnnual" class="text-3xl mt-1 result-value text-teal-400">--</p>
                </div>
            </div>

            <!-- LIGNE 2: Volume Total -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-gray-800 pt-6">
                <!-- Volume Mensuel USD -->
                <div class="p-4 bg-gray-900 rounded-lg border border-fuchsia-700">
                    <p class="text-sm result-label">Volume Transactionnel Mensuel (USD $)</p>
                    <p id="resultUsdVolumeMonthly" class="text-3xl mt-1 text-fuchsia-400 result-value">--</p>
                </div>

                <!-- Volume Annuel USD -->
                <div class="p-4 bg-gray-900 rounded-lg border border-fuchsia-700">
                    <p class="text-sm result-label">Volume Transactionnel Annuel (USD $)</p>
                    <p id="resultUsdVolumeAnnual" class="text-3xl mt-1 text-fuchsia-400 result-value">--</p>
                </div>
            </div>
        </div>
        
        <!-- Section ROI et Break-Even (Volume) -->
        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-semibold border-b border-gray-700 pb-3 text-lime-300 mb-6">
                5. Analyse de l'Investissement & ROI du Volume
            </h2>

            <!-- ROI EN POURCENTAGE -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- ROI Journalier (%) -->
                <div class="p-4 bg-gray-900 rounded-lg border border-yellow-700">
                    <p class="text-sm result-label">Rendement Journalier (ROI %) sur Investissement Total</p>
                    <p id="resultRoiDailyPercent" class="text-3xl mt-1 result-value text-yellow-400">--</p>
                </div>
                <!-- ROI Mensuel (%) -->
                <div class="p-4 bg-gray-900 rounded-lg border border-yellow-700">
                    <p class="text-sm result-label">Rendement Mensuel (ROI %) sur Investissement Total</p>
                    <p id="resultRoiMonthlyPercent" class="text-3xl mt-1 result-value text-yellow-400">--</p>
                </div>
            </div>

            <!-- Jours pour Break-Even & Statut -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-t border-gray-800 pt-6">

                <!-- Investissement Initial Total WAX -->
                <div class="p-3 bg-gray-900/50 rounded-lg border border-gray-600">
                    <p class="text-sm result-label">Investissement Initial Total (WAX)</p>
                    <p id="resultTotalInvestment" class="text-2xl mt-1 text-lime-400 result-value">--</p>
                </div>

                <!-- Jours pour atteindre le ROI (Break-Even) -->
                <div class="p-3 bg-gray-900/50 rounded-lg border border-gray-600">
                    <p class="text-sm result-label">Jours pour atteindre le ROI (Break-Even)</p>
                    <p id="resultRoiDays" class="text-2xl mt-1 text-lime-400 result-value">--</p>
                </div>
                
                <!-- Statut du ROI -->
                <div class="p-3 bg-gray-900/50 rounded-lg border border-gray-600">
                    <p class="text-sm result-label">Statut du ROI</p>
                    <p id="resultRoiStatus" class="text-2xl mt-1 result-value">--</p>
                </div>

            </div>
        </div>


        <!-- SECTION Consommation Nominale des Jetons de Co√ªt -->
        <div class="card p-6 rounded-xl">
             <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-indigo-300">
                6. Consommation D√©taill√©e des Jetons de Co√ªt (TU)
            </h3>
            
            <p class="text-sm text-gray-400 mt-2 mb-4">
                D√©tail de la consommation unitaire (par division) et projection totale journali√®re (pour **toutes** les divisions).
            </p>

            <div class="overflow-x-auto mb-6">
                <table class="min-w-full divide-y divide-gray-700 text-sm">
                    <thead>
                        <tr class="text-left text-gray-400 bg-gray-800/50">
                            <th class="p-3 font-medium">Jeton de Co√ªt</th>
                            <th class="p-3 font-medium text-right">Unit√©s TU (par 1 Division)</th>
                            <th class="p-3 font-medium text-right text-red-300">Total TU (Journalier)</th>
                            <th class="p-3 font-medium text-right">Co√ªt WAX (par 1 Division)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800" id="consumptionTableBody">
                        <!-- Les lignes de donn√©es seront ins√©r√©es ici par JS -->
                    </tbody>
                    <tfoot>
                        <tr class="border-t border-yellow-500/50 bg-gray-800 font-bold">
                            <td class="p-3 text-yellow-300">TOTAL (Toutes Divisions/24h)</td>
                            <td class="p-3 text-right text-yellow-300" id="totalUnitsConsumedBase">--</td>
                            <td class="p-3 text-right text-yellow-300" id="totalUnitsConsumedDailySum">--</td>
                            <td class="p-3 text-right text-yellow-300" id="totalWaxCostBase">--</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Totaux Consommation Journali√®re -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-700 pt-4">
                
                <div class="p-4 bg-red-900/40 rounded-lg">
                    <p class="text-sm font-bold text-gray-300">Consommation Totale TU (Journali√®re)</p>
                    <p id="totalUnitsConsumedDaily" class="text-2xl mt-1 text-red-300 font-extrabold">--</p>
                    <p class="text-xs text-gray-400 mt-1">Total TU requis pour tous les d√©ploiements.</p>
                </div>

                 <div class="p-4 bg-red-900/40 rounded-lg">
                    <p class="text-sm font-bold text-gray-300">Co√ªt Total WAX (Journalier)</p>
                    <p id="totalWaxCostDaily" class="text-2xl mt-1 text-red-300 font-extrabold">--</p>
                    <p class="text-xs text-gray-400 mt-1">Co√ªt WAX √©quivalent du besoin en TU.</p>
                </div>
            </div>

            <!-- Indicateurs pour une seule division (Non multipli√©s) -->
            <div class="mt-6 pt-4 border-t border-gray-800">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                    <div class="text-sm">
                        <span class="font-bold text-gray-400">Unit√©s DOVX g√©n√©r√©es (par Division):</span>
                        <span id="unitsDovXGenerated" class="text-white ml-2">--</span>
                    </div>
                    <div class="text-sm">
                        <span class="font-bold text-gray-400">Ratio d'Hyper-Amplification ($DOVX$ / Co√ªt Unitaire TU):</span>
                        <span id="ratioAmplification" class="text-lg text-green-500 font-extrabold ml-2">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 7: R√âPARTITION DES REVENUS DES PACKS (Volume) -->
        <div class="card p-6 rounded-xl">
             <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-yellow-300">
                7. R√©partition des Revenus de Vente des Packs (Volume)
            </h3>
            
            <p class="text-sm text-gray-400 mt-2 mb-4">
                Distribution de l'Investissement Total du **Volume** ($30\% Cash Back$, $30\% Team$, $30\% Market Token$, $10\% Pub$).
            </p>

            <!-- LIGNE 1: Totaux de l'Investissement -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 pt-4 border-t border-gray-800">
                <div class="p-3 bg-gray-900/50 rounded-lg border border-gray-600">
                    <p class="text-sm result-label">Investissement Total USD</p>
                    <p id="totalInvestmentUsdDisplay" class="text-2xl mt-1 text-lime-300 font-bold">--</p>
                </div>
                <div class="p-3 bg-gray-900/50 rounded-lg border border-gray-600">
                    <p class="text-sm result-label">Investissement Total WAX</p>
                    <p id="totalInvestmentWaxDisplay" class="text-2xl mt-1 text-lime-300 font-bold">--</p>
                </div>
            </div>

            <!-- LIGNE 2: R√©partition D√©taill√©e -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                
                <!-- Cash Back (30%) -->
                <div class="p-3 bg-blue-900/30 rounded-lg">
                    <p class="text-sm font-bold text-blue-300">Cash Back (30%)</p>
                    <p id="cashBackUsd" class="text-xl mt-1 text-white">--</p>
                    <p id="cashBackWax" class="text-xs text-blue-200">--</p>
                </div>

                <!-- Team (30%) -->
                <div class="p-3 bg-purple-900/30 rounded-lg">
                    <p class="text-sm font-bold text-purple-300">Team (30%)</p>
                    <p id="teamUsd" class="text-xl mt-1 text-white">--</p>
                    <p id="teamWax" class="text-xs text-purple-200">--</p>
                </div>

                <!-- Market Token (30%) -->
                <div class="p-3 bg-pink-900/30 rounded-lg">
                    <p class="text-sm font-bold text-pink-300">Market Token (30%)</p>
                    <p id="marketTokenUsd" class="text-xl mt-1 text-white">--</p>
                    <p id="marketTokenWax" class="text-xs text-pink-200">--</p>
                </div>

                <!-- Pub (10%) -->
                <div class="p-3 bg-amber-900/30 rounded-lg">
                    <p class="text-sm font-bold text-amber-300">Pub (10%)</p>
                    <p id="pubUsd" class="text-xl mt-1 text-white">--</p>
                    <p id="pubWax" class="text-xs text-amber-200">--</p>
                </div>
            </div>
        </div>

        <!-- Section 8: OUTIL DE CR√âATION ET ROI DES PACKS -->
        <div class="card p-6 rounded-xl border-4 border-dashed border-teal-500/50">
             <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-teal-400 flex items-center justify-between">
                <span>8. Outil de Cr√©ation et ROI d'un Pack Design√©</span>
                <button id="btnAiLore" class="text-sm bg-teal-600/20 hover:bg-teal-600/40 text-teal-300 py-1 px-3 rounded border border-teal-500/50 transition-colors flex items-center space-x-1">
                    <span>‚ú® IA: G√©n√©rer Lore</span>
                </button>
            </h3>
            
            <p class="text-sm text-gray-400 mt-2 mb-4">
                Calcule le ROI et la r√©partition d'un **seul pack** bas√© sur sa composition (Divisions) et sa zone de Staking.
            </p>
            
            <div id="aiLoreOutput" class="hidden mb-4 p-3 bg-teal-900/20 border-l-2 border-teal-500 text-gray-300 text-sm italic">
                <!-- Lore IA ici -->
            </div>

            <!-- ENTR√âES DU PACK DESIGN√â -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t border-gray-800 pt-4">
                
                <div>
                    <label for="packName" class="block text-sm font-medium text-teal-300">Nom du Pack</label>
                    <input type="text" id="packName" value="Pack Alpha" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-teal-500 focus:border-teal-500">
                </div>
                
                <div>
                    <label for="packDesignPriceUsd" class="block text-sm font-medium text-teal-300">Prix du Pack (USD $)</label>
                    <input type="text" id="packDesignPriceUsd" value="50,00" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-teal-500 focus:border-teal-500" inputmode="decimal">
                </div>

                <div>
                    <label for="packDesignZoneSelector" class="block text-sm font-medium text-teal-300">Zone de Staking (ROI)</label>
                    <select id="packDesignZoneSelector" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-teal-500 focus:border-teal-500 appearance-none">
                        <!-- Options seront remplies par JS (identiques au s√©lecteur de volume) -->
                    </select>
                </div>
            </div>

            <div class="mt-4">
                <label for="packComposition" class="block text-sm font-medium text-teal-300">Composition (Cartes NFT)</label>
                <textarea id="packComposition" rows="2" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-teal-500 focus:border-teal-500">1x Commander Lvl 1, 10x Division Tokens, 5x Rations</textarea>
            </div>


            <!-- R√âSULTATS ROI ET CASH BACK DU PACK DESIGN√â -->
            <div class="mt-8">
                <h4 class="text-lg font-semibold text-pink-300 border-b border-gray-700 pb-2 mb-4">
                    ROI et Marge d'un Pack (Unitaire)
                </h4>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    
                    <!-- Marge Nette USD Journali√®re -->
                    <div class="p-3 bg-gray-800 rounded-lg border border-pink-700">
                        <p class="text-sm result-label">Marge Nette Journali√®re (USD $)</p>
                        <p id="designPackNetUsd" class="text-xl mt-1 result-value text-pink-400">--</p>
                    </div>

                    <!-- ROI Journalier (%) -->
                    <div class="p-3 bg-gray-800 rounded-lg border border-pink-700">
                        <p class="text-sm result-label">ROI Journalier (%)</p>
                        <p id="designPackRoiDaily" class="text-xl mt-1 result-value text-pink-400">--</p>
                    </div>
                    
                     <!-- Jours pour Break-Even -->
                    <div class="p-3 bg-gray-800 rounded-lg border border-pink-700">
                        <p class="text-sm result-label">Jours pour Break-Even</p>
                        <p id="designPackRoiDays" class="text-xl mt-1 result-value text-pink-400">--</p>
                    </div>

                </div>
            </div>

            <!-- R√âPARTITION DU CASH BACK (30%) -->
            <div class="mt-8">
                <h4 class="text-lg font-semibold text-blue-300 border-b border-gray-700 pb-2 mb-4">
                    R√©partition du Cash Back (30% de la Vente du Pack)
                </h4>
                 <div class="grid grid-cols-2 gap-4 lg:grid-cols-4">
                    
                    <!-- Cash Back (USD) -->
                    <div class="p-3 bg-blue-900/30 rounded-lg">
                        <p class="text-sm font-bold text-blue-300">Cash Back (USD $)</p>
                        <p id="designPackCashBackUsd" class="text-xl mt-1 text-white">--</p>
                    </div>

                    <!-- Cash Back (WAX) -->
                    <div class="p-3 bg-blue-900/30 rounded-lg">
                        <p class="text-sm font-bold text-blue-300">Cash Back (WAX)</p>
                        <p id="designPackCashBackWax" class="text-xl mt-1 text-white">--</p>
                    </div>
                    
                    <!-- Prix Pack (WAX) -->
                    <div class="p-3 bg-gray-900/50 rounded-lg">
                        <p class="text-sm font-bold text-gray-400">Prix Pack (WAX)</p>
                        <p id="designPackPriceWax" class="text-xl mt-1 text-lime-400">--</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- SECTION 9: SIMULATEUR PRODUCTION BATIMENTS -->
        <div class="card p-6 rounded-xl border border-orange-500/30">
            <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-orange-400 flex items-center justify-between">
                <div class="flex flex-col sm:flex-row sm:items-center">
                    <span class="flex items-center"><span class="mr-2">üè≠</span> 9. Simulateur de Production des B√¢timents (TU)</span>
                    <!-- RAPPEL DES TAUX UTILIS√âS -->
                    <span id="section9RatesDisplay" class="ml-0 sm:ml-4 mt-1 sm:mt-0 text-xs font-normal text-orange-200/60 bg-orange-900/20 px-2 py-0.5 rounded border border-orange-500/20">
                        (Taux: --)
                    </span>
                </div>
                <!-- FILTRE AJOUT√â -->
                <div class="relative ml-4">
                    <select id="buildingTypeFilter" class="bg-gray-800 border border-gray-600 text-xs rounded p-1 text-orange-200 focus:outline-none focus:border-orange-500">
                        <option value="ALL">Tous les B√¢timents</option>
                        <option value="DOV-F">Fuel Refinery (DOV-F)</option>
                        <option value="DOV-H">Health Factory (DOV-H)</option>
                        <option value="DOV-R">Repair Factory (DOV-R)</option>
                        <option value="DOV-S">Supply Factory (DOV-S)</option>
                    </select>
                </div>
            </h3>
            
            <p class="text-sm text-gray-400 mt-2 mb-4">
                Calculez le rendement (ROI) de vos b√¢timents de production de TU (Fuel, Health, Repair, Supply).
                <br><span class="text-xs text-orange-300/70">Donn√©es bas√©es sur les co√ªts standards (Communs √† Supr√™mes).</span>
            </p>

            <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-700 text-sm relative">
                    <thead class="sticky top-0 z-10">
                        <tr class="text-left bg-gray-800 text-gray-300 shadow-sm">
                            <th class="p-3">B√¢timent (Raret√©/Niveau)</th>
                            <th class="p-3 text-right">Co√ªt DOVX/h (Fixe)</th>
                            <th class="p-3 text-right text-blue-300">Co√ªt WAX/24h (Dyn)</th>
                            <th class="p-3 text-right">Prod TU/24h</th>
                            <th class="p-3 text-right text-green-300">Revenu WAX/24h</th>
                            <th class="p-3 text-right text-green-400">Marge WAX/24h</th>
                            <th class="p-3 text-right text-green-400">Gain Net $ Mois</th>
                            <th class="p-3 text-center">Qt√©</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800" id="buildingsTableBody">
                        <!-- Rempli par JS -->
                    </tbody>
                    <tfoot class="bg-gray-900/90 font-bold border-t border-orange-500/30 sticky bottom-0 z-10">
                        <tr>
                            <td class="p-3 text-orange-300" colspan="3">TOTAL PROD UTILISATEUR (Qt√© > 0)</td>
                            <td class="p-3 text-right text-orange-300" id="userTotalTuDaily">0</td>
                            <td class="p-3 text-right text-green-400" id="userTotalRevenueWax">0 WAX</td>
                            <td class="p-3 text-right text-green-400" id="userTotalMarginWax">0 WAX</td>
                            <td class="p-3 text-right text-green-400" id="userTotalRevenueUsdMonthly">0 $</td>
                            <td class="p-3"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- SECTION 10: CONNEXION WALLET & AUDIT -->
        <div class="card p-6 rounded-xl border border-cyan-500/30 mt-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-cyan-500/50"></div>
            <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-cyan-400 flex items-center mb-4">
                <span class="mr-2">üíº</span> 10. Connexion Wallet & Audit d'Actifs (Mode R√©el)
            </h3>
            
            <p class="text-sm text-gray-400 mb-6">
                Connectez votre WAX Cloud Wallet pour lister automatiquement vos cartes de b√¢timents (NFTs) et calculer vos gains mensuels r√©els bas√©s sur les prix actuels du march√©.
                <br><span class="text-xs text-cyan-300/60 italic">*Ceci est une connexion API r√©elle via AtomicAssets pour la collection <strong>dovdivisions</strong>.*</span>
            </p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="md:col-span-2">
                    <label for="walletAddressInput" class="block text-sm font-medium text-cyan-300 mb-1">Adresse Wallet WAX</label>
                    <div class="flex space-x-2">
                        <input type="text" id="walletAddressInput" placeholder="ex: user.wam" class="input-style block w-full p-2.5 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                        <button id="btnScanWallet" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg transition-all duration-200 whitespace-nowrap">
                            Scanner le Portefeuille
                        </button>
                    </div>
                </div>
            </div>

            <!-- RESULTATS DU SCAN -->
            <div id="walletResultsContainer" class="hidden animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- R√©sum√© Actifs -->
                    <div class="p-4 bg-gray-900/80 rounded-lg border border-cyan-700/50">
                        <p class="text-sm text-gray-400">Total B√¢timents D√©tect√©s</p>
                        <p id="walletTotalBuildings" class="text-2xl mt-1 text-cyan-300 font-bold">--</p>
                    </div>
                    <!-- Revenu Mensuel WAX -->
                    <div class="p-4 bg-gray-900/80 rounded-lg border border-cyan-700/50">
                        <p class="text-sm text-gray-400">Revenu Net Mensuel (WAX)</p>
                        <p id="walletMonthlyWax" class="text-2xl mt-1 text-green-400 font-bold">--</p>
                    </div>
                    <!-- Revenu Mensuel USD -->
                    <div class="p-4 bg-gray-900/80 rounded-lg border border-green-700/50 relative overflow-hidden">
                        <div class="absolute -right-6 -top-6 w-16 h-16 bg-green-500/20 rounded-full blur-xl"></div>
                        <p class="text-sm text-gray-400">Revenu Net Mensuel ($ USD)</p>
                        <p id="walletMonthlyUsd" class="text-3xl mt-1 text-green-400 font-extrabold">--</p>
                    </div>
                </div>

                <!-- Liste d√©taill√©e -->
                <h4 class="text-md font-semibold text-gray-300 mb-3 border-b border-gray-800 pb-2">D√©tail des Actifs D√©tenus</h4>
                <div class="overflow-x-auto max-h-[300px] overflow-y-auto bg-gray-900/50 rounded-lg border border-gray-700">
                    <table class="min-w-full divide-y divide-gray-800 text-sm">
                        <thead class="bg-gray-800 text-gray-400 sticky top-0">
                            <tr>
                                <th class="p-3 text-left">Nom du B√¢timent (NFT)</th>
                                <th class="p-3 text-center">Quantit√©</th>
                                <th class="p-3 text-right text-green-300">Gain/Mois ($)</th>
                            </tr>
                        </thead>
                        <tbody id="walletAssetsBody" class="divide-y divide-gray-800/50 text-gray-300">
                            <!-- Rempli par JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NOUVELLE SECTION 11: CR√âATEUR DE PACK B√ÇTIMENTS -->
        <div class="card p-6 rounded-xl border border-emerald-500/30 mt-8 relative overflow-hidden">
             <div class="absolute top-0 right-0 w-1 h-full bg-emerald-500/50"></div>
            <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 text-emerald-400 flex items-center mb-4">
                <span class="mr-2">üèóÔ∏è</span> 11. Cr√©ateur de Pack B√¢timent & Outil (Simulator)
            </h3>
            
            <p class="text-sm text-gray-400 mb-6">
                Concevez un pack personnalis√© contenant des b√¢timents et un outil d'am√©lioration de la production (Multiplicateur).
                Analysez imm√©diatement la rentabilit√© pour un investisseur potentiel.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Choix du B√¢timent -->
                <div>
                    <label for="packBuildingSelect" class="block text-sm font-medium result-label">Type de B√¢timent</label>
                    <select id="packBuildingSelect" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 appearance-none text-sm">
                        <!-- Rempli par JS -->
                    </select>
                </div>
                <!-- Quantit√© -->
                <div>
                    <label for="packBuildingQty" class="block text-sm font-medium result-label">Quantit√© de B√¢timents</label>
                    <input type="number" id="packBuildingQty" value="1" min="1" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" inputmode="numeric">
                </div>
                <!-- Multiplicateur -->
                <div>
                    <label for="packToolMultiplier" class="block text-sm font-medium result-label">Multiplicateur Outil (ex: 1.1 = +10%)</label>
                    <input type="number" id="packToolMultiplier" value="1.00" step="0.01" min="1.00" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" inputmode="decimal">
                </div>
                <!-- Prix du Pack -->
                <div>
                    <label for="packBuildingPrice" class="block text-sm font-medium result-label">Prix Vente du Pack ($ USD)</label>
                    <input type="number" id="packBuildingPrice" value="50.00" step="0.01" min="0" class="input-style mt-1 block w-full p-2.5 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" inputmode="decimal">
                </div>
            </div>

            <!-- R√âSULTATS DU PACK -->
            <div class="bg-emerald-900/10 rounded-xl p-4 border border-emerald-500/20">
                <h4 class="text-emerald-300 font-semibold mb-4 border-b border-emerald-500/20 pb-2">Analyse de Rentabilit√© du Pack</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Production Boost√©e -->
                    <div>
                        <p class="text-xs text-gray-400">Production Totale Journali√®re (Boost√©e)</p>
                        <p id="packBuildingProd" class="text-xl font-bold text-white mt-1">--</p>
                        <p class="text-xs text-gray-500" id="packBuildingProdBase">Base: --</p>
                    </div>

                     <!-- Co√ªt Op√©rationnel -->
                     <div>
                        <p class="text-xs text-gray-400">Co√ªt Fonctionnement Journalier</p>
                        <p id="packBuildingOpEx" class="text-xl font-bold text-red-300 mt-1">--</p>
                    </div>

                    <!-- Marge Mensuelle -->
                    <div>
                        <p class="text-xs text-gray-400">Rendement Mensuel Net ($)</p>
                        <p id="packBuildingMonthlyNet" class="text-2xl font-bold text-emerald-400 mt-1">--</p>
                    </div>

                    <!-- ROI -->
                    <div>
                        <p class="text-xs text-gray-400">ROI (Retour sur Investissement)</p>
                        <p id="packBuildingRoi" class="text-xl font-bold text-yellow-400 mt-1">--</p>
                         <p id="packBuildingRoiDays" class="text-xs text-gray-500">-- Jours</p>
                    </div>
                </div>
            </div>
        </div>


        <div class="text-xs text-gray-500 text-center pt-4 pb-8">
            *Les co√ªts de combat sont bas√©s sur la colonne 'Combat Cost' et sont divis√©s par 4 pour les quatre jetons de co√ªt distincts (DOV-H, R, S, F).
        </div>
    </div>

    <script>
        // --- API GEMINI ---
        const apiKey = ""; // API Key inject√©e par l'environnement
        
        // --- CONFIGURATION WAX ---
        const TARGET_COLLECTION_NAME = "dovdivisions";
        const TARGET_SCHEMA_NAME = "warbuildings"; 
        // MODIFICATION: Utilisation d'une liste de endpoints pour plus de robustesse
        const ATOMIC_ENDPOINTS = [
            "https://wax.api.atomicassets.io/atomicassets/v1/assets",
            "https://aa.wax.blacklizard.io/atomicassets/v1/assets",
            "https://atomic.wax.eosrio.io/atomicassets/v1/assets",
            "https://api.wax-aa.bountyblok.io/atomicassets/v1/assets"
        ];

        // --- Globals for Ratio Calculation ---
        const BASE_PRICE_DOVX = 0.00528552;
        const BASE_PRICE_COST_TOKEN = 0.00045262;
        const COST_DOVX_RATIO = BASE_PRICE_COST_TOKEN / BASE_PRICE_DOVX;
        const DOVX_SLIDER_SCALER = 100000.0; 
        
        // Constantes de temps et de distribution
        const DAYS_IN_MONTH = 30;
        const DAYS_IN_YEAR = 365;
        const CASH_BACK_PERCENT = 0.30;
        const TEAM_PERCENT = 0.30;
        const MARKET_TOKEN_PERCENT = 0.30;
        const PUB_PERCENT = 0.10;
        
        const COST_TOKENS = ["DOV-H", "DOV-R", "DOV-S", "DOV-F"];

        // --- DONN√âES BATIMENTS (BUILDINGS) - G√âN√âRATION AUTOMATIQUE ---
        
        // 1. D√©finition des stats de base (Raret√©/Niveau) qui s'appliquent √† tous les types
        const TIER_STATS = [
            // Commun
            { level: "L1", rarity: "Commun", rarityCode: "C", prod: 5.40, cost: 0.4590, css: "rarity-commun" },
            { level: "L2", rarity: "Commun", rarityCode: "C", prod: 12.15, cost: 1.0328, css: "rarity-commun" },
            { level: "L3", rarity: "Commun", rarityCode: "C", prod: 30.38, cost: 2.58, css: "rarity-commun" },
            { level: "L4", rarity: "Commun", rarityCode: "C", prod: 83.53, cost: 7.10, css: "rarity-commun" },
            // Rare
            { level: "L1", rarity: "Rare", rarityCode: "R", prod: 16.20, cost: 1.38, css: "rarity-rare" },
            { level: "L2", rarity: "Rare", rarityCode: "R", prod: 36.45, cost: 3.10, css: "rarity-rare" },
            { level: "L3", rarity: "Rare", rarityCode: "R", prod: 91.13, cost: 7.75, css: "rarity-rare" },
            { level: "L4", rarity: "Rare", rarityCode: "R", prod: 250.59, cost: 21.30, css: "rarity-rare" },
            // Epic
            { level: "L1", rarity: "Epic", rarityCode: "E", prod: 48.60, cost: 4.13, css: "rarity-epic" },
            { level: "L2", rarity: "Epic", rarityCode: "E", prod: 109.35, cost: 9.29, css: "rarity-epic" },
            { level: "L3", rarity: "Epic", rarityCode: "E", prod: 273.38, cost: 23.24, css: "rarity-epic" },
            { level: "L4", rarity: "Epic", rarityCode: "E", prod: 751.78, cost: 63.90, css: "rarity-epic" },
            // Legendary
            { level: "L1", rarity: "Legendary", rarityCode: "L", prod: 145.80, cost: 12.39, css: "rarity-legendary" },
            { level: "L2", rarity: "Legendary", rarityCode: "L", prod: 328.05, cost: 27.88, css: "rarity-legendary" },
            { level: "L3", rarity: "Legendary", rarityCode: "L", prod: 820.13, cost: 69.71, css: "rarity-legendary" },
            { level: "L4", rarity: "Legendary", rarityCode: "L", prod: 2255.34, cost: 191.70, css: "rarity-legendary" },
            // Supreme
            { level: "L1", rarity: "Supreme", rarityCode: "S", prod: 2255.34, cost: 191.70, css: "rarity-supreme" }
        ];

        // 2. D√©finition des types de b√¢timents et leurs suffixes techniques
        const BUILDING_TYPES = [
            { name: "Fuel Refinery", type: "DOV-F", suffix: "FUEL" },
            { name: "Health Factory", type: "DOV-H", suffix: "HEALTH" },
            { name: "Repair Factory", type: "DOV-R", suffix: "REPAIR" },
            { name: "Supply Factory", type: "DOV-S", suffix: "SUPPLY" }
        ];

        // 3. G√©n√©ration de la liste compl√®te (17 tiers * 4 types = 68 items)
        let BUILDING_DATA = [];
        BUILDING_TYPES.forEach(typeObj => {
            TIER_STATS.forEach(tier => {
                // Construction du nom technique: {RarityLetter}_F{Level}_PRODUCER_{TypeSuffix}
                // Ex: Common Supply L1 -> C_F1_PRODUCER_SUPPLY
                const levelNum = tier.level.replace('L', ''); // L1 -> 1
                const technicalName = `${tier.rarityCode}_F${levelNum}_PRODUCER_${typeObj.suffix}`;
                
                BUILDING_DATA.push({
                    name: `${tier.level} ${typeObj.name}`, // Nom d'affichage
                    technicalName: technicalName, // Nom de la carte sur la blockchain
                    type: typeObj.type,
                    rarity: tier.rarity,
                    prodPerHour: tier.prod,
                    dovxCost: tier.cost,
                    cssClass: tier.css
                });
            });
        });


        /**
         * Formate une valeur num√©rique en cha√Æne WAX avec un nombre d√©fini de d√©cimales.
         */
        const formatWAX = (value, decimales = 6) => {
            if (isNaN(value) || !isFinite(value)) return '--';
            return value.toLocaleString('fr-FR', {
                minimumFractionDigits: decimales,
                maximumFractionDigits: decimales
            }) + ' WAX';
        };

        /**
         * Formate une valeur num√©rique en USD ($) avec un nombre d√©fini de d√©cimales.
         */
        const formatUSD = (value, decimales = 4) => {
            if (isNaN(value) || !isFinite(value)) return '--';
            return value.toLocaleString('fr-FR', {
                minimumFractionDigits: decimales,
                maximumFractionDigits: decimales,
                style: 'currency',
                currency: 'USD',
            });
        };

        /**
         * Formate une valeur num√©rique en unit√©s (nombre entier avec s√©parateur).
         */
        const formatUnits = (value) => {
            if (isNaN(value) || !isFinite(value)) return '--';
            const maxDigits = (value % 1 !== 0) ? 2 : 0;
            return value.toLocaleString('fr-FR', { maximumFractionDigits: maxDigits });
        };
        
        /**
         * Formate une valeur en pourcentage.
         */
        const formatPercent = (value, decimales = 2) => {
            if (isNaN(value) || !isFinite(value)) return '--';
            return (value * 100).toLocaleString('fr-FR', {
                minimumFractionDigits: decimales,
                maximumFractionDigits: decimales
            }) + ' %';
        };
        
        /**
         * Convertit une cha√Æne de caract√®res fran√ßaise (avec virgule) en nombre flottant standard (avec point).
         */
        const parseFrenchFloat = (str) => {
            if (!str) return NaN;
            const standardStr = str.toString().replace(',', '.');
            return parseFloat(standardStr);
        };
        
        /**
         * Formate la valeur enti√®re du slider en prix WAX pour l'affichage.
         */
        const formatPriceDisplay = (sliderValue) => {
            const price = parseInt(sliderValue) / DOVX_SLIDER_SCALER;
            return price.toLocaleString('fr-FR', { minimumFractionDigits: 8, maximumFractionDigits: 8 });
        };

        // --------------------------------------------------------------------------

        // D√©finition des donn√©es de base de l'√©conomie (totalTuCost est le co√ªt COMBIN√â des 4 jetons)
        // Les valeurs ici repr√©sentent le co√ªt/r√©compense pour UNE SEULE DIVISION/D√âPLOIEMENT.
        const ZONE_DATA = [
            { name: "beach1", totalTuCost: 4640, dovxReward: 400 }, 
            { name: "beach2", totalTuCost: 27872, dovxReward: 2405 }, 
            { name: "beach3", totalTuCost: 35200, dovxReward: 3037 }, 
            { name: "bunker", totalTuCost: 44480, dovxReward: 3838 }, 
            { name: "forest1", totalTuCost: 56096, dovxReward: 4840 }, 
            { name: "forest2", totalTuCost: 70816, dovxReward: 6110 }, 
            { name: "forest3", totalTuCost: 89408, dovxReward: 7714 }, 
            { name: "camp", totalTuCost: 112880, dovxReward: 9739 }, 
            { name: "hill1", totalTuCost: 148208, dovxReward: 12788 }, 
            { name: "hill2", totalTuCost: 194608, dovxReward: 16791 }, 
            { name: "hill3", totalTuCost: 258064, dovxReward: 22266 }, 
            { name: "radar", totalTuCost: 338848, dovxReward: 29236 }, 
            { name: "plain1", totalTuCost: 397536, dovxReward: 34300 }, 
            { name: "plain2", totalTuCost: 502832, dovxReward: 43385 }, 
            { name: "plain3", totalTuCost: 604656, dovxReward: 52171 }, 
            { name: "HQ", totalTuCost: 752000, dovxReward: 64884 }, 
            { name: "STAKING", totalTuCost: 650000, dovxReward: 50000 },
        ];

        // √âl√©ments DOM
        const zoneSelector = document.getElementById('zoneSelector');
        const priceWaxUsdInput = document.getElementById('priceWaxUsd');
        const numberOfAccountsInput = document.getElementById('numberOfAccounts');
        const divisionsPerAccountInput = document.getElementById('divisionsPerAccount');
        const dovxPriceSlider = document.getElementById('dovxPriceSlider');
        const numberOfPacksInput = document.getElementById('numberOfPacks');
        const divisionsPerPackInput = document.getElementById('divisionsPerPack');
        const pricePerPackUsdInput = document.getElementById('pricePerPackUsd'); 
        
        // NOUVEAUX √âL√âMENTS DU PACK DESIGN√â
        const packDesignZoneSelector = document.getElementById('packDesignZoneSelector');
        const packDesignPriceUsdInput = document.getElementById('packDesignPriceUsd');
        const designPackNetUsdElement = document.getElementById('designPackNetUsd');
        const designPackRoiDailyElement = document.getElementById('designPackRoiDaily');
        const designPackRoiDaysElement = document.getElementById('designPackRoiDays');
        const designPackCashBackUsdElement = document.getElementById('designPackCashBackUsd');
        const designPackCashBackWaxElement = document.getElementById('designPackCashBackWax');
        const designPackPriceWaxElement = document.getElementById('designPackPriceWax');
        
        // Elements du slider √† corriger
        const sliderValueDisplay = document.getElementById('sliderValueDisplay');
        const minWaxDisplay = document.getElementById('minWaxDisplay');
        const maxWaxDisplay = document.getElementById('maxWaxDisplay');

        // Elements IA
        const btnAiAdvisor = document.getElementById('btnAiAdvisor');
        const aiAdvisorOutput = document.getElementById('aiAdvisorOutput');
        const btnAiLore = document.getElementById('btnAiLore');
        const aiLoreOutput = document.getElementById('aiLoreOutput');
        const packNameInput = document.getElementById('packName');
        const packCompositionInput = document.getElementById('packComposition');

        // Elements Section Batiments
        const buildingsTableBody = document.getElementById('buildingsTableBody');
        const userTotalTuDailyEl = document.getElementById('userTotalTuDaily');
        const userTotalRevenueWaxEl = document.getElementById('userTotalRevenueWax');
        const userTotalMarginWaxEl = document.getElementById('userTotalMarginWax'); // NEW
        const userTotalRevenueUsdMonthlyEl = document.getElementById('userTotalRevenueUsdMonthly'); 
        const buildingTypeFilter = document.getElementById('buildingTypeFilter');
        const section9RatesDisplay = document.getElementById('section9RatesDisplay');

        // Elements Section 10 (Wallet)
        const btnScanWallet = document.getElementById('btnScanWallet');
        const walletAddressInput = document.getElementById('walletAddressInput');
        const walletResultsContainer = document.getElementById('walletResultsContainer');
        const walletTotalBuildingsEl = document.getElementById('walletTotalBuildings');
        const walletMonthlyWaxEl = document.getElementById('walletMonthlyWax');
        const walletMonthlyUsdEl = document.getElementById('walletMonthlyUsd');
        const walletAssetsBody = document.getElementById('walletAssetsBody');
        
        // Elements Section 11 (Pack B√¢timents)
        const packBuildingSelect = document.getElementById('packBuildingSelect');
        const packBuildingQtyInput = document.getElementById('packBuildingQty');
        const packToolMultiplierInput = document.getElementById('packToolMultiplier');
        const packBuildingPriceInput = document.getElementById('packBuildingPrice');
        const packBuildingProdEl = document.getElementById('packBuildingProd');
        const packBuildingProdBaseEl = document.getElementById('packBuildingProdBase');
        const packBuildingOpExEl = document.getElementById('packBuildingOpEx');
        const packBuildingMonthlyNetEl = document.getElementById('packBuildingMonthlyNet');
        const packBuildingRoiEl = document.getElementById('packBuildingRoi');
        const packBuildingRoiDaysEl = document.getElementById('packBuildingRoiDays');

        
        let scannedWalletData = []; // Stocke les donn√©es simul√©es du wallet


        // Initialisation des s√©lecteurs de zone
        ZONE_DATA.forEach((zone, index) => {
            const unitsCostPerTokenBase = zone.totalTuCost / 4; 
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${zone.name.toUpperCase()} (Co√ªt Total: ${formatUnits(zone.totalTuCost)} TU - "Unitaire: ${formatUnits(unitsCostPerTokenBase)}" TU)`;
            
            // Clone l'option pour le s√©lecteur de Volume
            zoneSelector.appendChild(option.cloneNode(true));
            // Clone l'option pour le s√©lecteur de Pack Design
            packDesignZoneSelector.appendChild(option.cloneNode(true));
        });
        
        // Initialisation du tableau des b√¢timents
        const initializeBuildingTable = () => {
            buildingsTableBody.innerHTML = '';
            // On vide le selecteur du pack batiment aussi
            if(packBuildingSelect) packBuildingSelect.innerHTML = '';
            
            // On r√©cup√®re la valeur du filtre
            const filterValue = buildingTypeFilter.value;

            BUILDING_DATA.forEach((building, index) => {
                // Logique de filtrage (visual hide)
                const isHidden = (filterValue !== 'ALL' && building.type !== filterValue) ? 'hidden' : '';

                const tr = document.createElement('tr');
                tr.className = `hover:bg-gray-800/40 building-row ${isHidden}`;
                tr.setAttribute('data-type', building.type); // Pour le filtrage CSS si besoin
                
                tr.innerHTML = `
                    <td class="p-3 font-semibold ${building.cssClass}">
                        ${building.name} 
                        <span class="text-xs opacity-70 block">${building.technicalName}</span>
                    </td>
                    <td class="p-3 text-right">${formatUnits(building.dovxCost)}</td>
                    <td class="p-3 text-right text-blue-300 building-cost-wax" data-index="${index}">--</td>
                    <td class="p-3 text-right text-gray-300 font-medium">${formatUnits(building.prodPerHour * 24)}</td>
                    <td class="p-3 text-right text-green-400 building-revenue-wax" data-index="${index}">--</td>
                    <td class="p-3 text-right text-green-400 building-margin-wax" data-index="${index}">--</td>
                    <td class="p-3 text-right text-green-400 building-revenue-usd-monthly" data-index="${index}">--</td>
                    <td class="p-3 text-center">
                        <input type="number" min="0" value="0" class="building-qty bg-gray-900 border border-gray-700 rounded w-16 text-center text-sm p-1 focus:ring-orange-500 focus:border-orange-500" data-index="${index}">
                    </td>
                `;
                buildingsTableBody.appendChild(tr);

                // Populate Pack Building Selector (Section 11)
                if(packBuildingSelect) {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.textContent = `${building.name} (${building.rarity})`;
                    packBuildingSelect.appendChild(opt);
                }
            });
            
            // Ajout des listeners pour les quantit√©s
            document.querySelectorAll('.building-qty').forEach(input => {
                input.addEventListener('input', updateBuildingTotals);
            });
        };
        
        // Listener sur le filtre
        if(buildingTypeFilter) {
            buildingTypeFilter.addEventListener('change', () => {
                const filterValue = buildingTypeFilter.value;
                const rows = document.querySelectorAll('.building-row');
                rows.forEach(row => {
                    const rowType = row.getAttribute('data-type');
                    if (filterValue === 'ALL' || rowType === filterValue) {
                        row.classList.remove('hidden');
                    } else {
                        row.classList.add('hidden');
                    }
                });
            });
        }

        // --------------------------------------------------------------------------

        /**
         * Met √† jour l'affichage de la valeur du slider et des valeurs min/max.
         */
        const initializeSliderDisplay = () => {
            if (minWaxDisplay) minWaxDisplay.textContent = formatPriceDisplay(dovxPriceSlider.min);
            if (maxWaxDisplay) maxWaxDisplay.textContent = formatPriceDisplay(dovxPriceSlider.max);
            if (sliderValueDisplay) sliderValueDisplay.textContent = formatPriceDisplay(dovxPriceSlider.value);
        };


        // --------------------------------------------------------------------------
        // --- LOGIQUE DE CALCUL DU PACK DESIGN ---
        // --------------------------------------------------------------------------
        const calculatePackDesign = (tokenPrices) => {
            const { newPriceDovX, newPriceCostToken, priceWaxUsd } = tokenPrices;
            
            const selectedDesignIndex = parseInt(packDesignZoneSelector.value);
            const selectedDesignZone = ZONE_DATA[selectedDesignIndex];
            
            // Divisions contenues dans le pack design√© (r√©utilise l'input existant)
            const divisionsPerPack = Math.max(0, parseInt(divisionsPerPackInput.value) || 0); 
            const pricePackUsd = parseFrenchFloat(packDesignPriceUsdInput.value);

            // 1. Validation
            if (!selectedDesignZone || isNaN(newPriceDovX) || isNaN(newPriceCostToken) || isNaN(priceWaxUsd) || isNaN(divisionsPerPack) || isNaN(pricePackUsd) || divisionsPerPack === 0) {
                 if(designPackNetUsdElement) designPackNetUsdElement.textContent = '--';
                 if(designPackRoiDailyElement) designPackRoiDailyElement.textContent = '--';
                 if(designPackRoiDaysElement) designPackRoiDaysElement.textContent = '--';
                 if(designPackCashBackUsdElement) designPackCashBackUsdElement.textContent = '--';
                 if(designPackCashBackWaxElement) designPackCashBackWaxElement.textContent = '--';
                 if(designPackPriceWaxElement) designPackPriceWaxElement.textContent = '--';
                 return;
            }
            
            // 2. Calcul du Prix du Pack en WAX
            const pricePackWax = (priceWaxUsd > 0) ? pricePackUsd / priceWaxUsd : Infinity;
            
            // 3. Calcul du ROI du Pack (bas√© sur toutes les divisions contenues dans le pack)
            const unitsCostPerTokenBase = selectedDesignZone.totalTuCost / 4;
            const unitsDovX = selectedDesignZone.dovxReward;

            const singleDivisionWaxCost = selectedDesignZone.totalTuCost * newPriceCostToken; 
            const singleDivisionWaxReward = unitsDovX * newPriceDovX; 
            
            // Co√ªt et R√©compense TOTAUX du pack par jour
            const packDailyWaxCost = singleDivisionWaxCost * divisionsPerPack;
            const packDailyWaxReward = singleDivisionWaxReward * divisionsPerPack;
            
            const packNetProfitLossWax = packDailyWaxReward - packDailyWaxCost;
            const packNetProfitLossUsd = packNetProfitLossWax * priceWaxUsd;
            
            // 4. Calcul du ROI
            let packRoiDays = Infinity;
            let packRoiDailyPercent = 0;
            
            if (pricePackWax > 0) {
                packRoiDailyPercent = packNetProfitLossWax / pricePackWax;

                if (packNetProfitLossWax > 0) {
                    packRoiDays = pricePackWax / packNetProfitLossWax;
                }
            }
            
            // 5. R√©partition du Cash Back (30% du prix du pack)
            const cbUsd = pricePackUsd * CASH_BACK_PERCENT;
            const cbWax = pricePackWax * CASH_BACK_PERCENT;
            
            // 6. Mise √† jour de l'affichage
            if(designPackNetUsdElement) {
                designPackNetUsdElement.textContent = formatUSD(packNetProfitLossUsd, 4);
                designPackNetUsdElement.classList.remove('text-green-400', 'text-red-400', 'text-pink-400');
                designPackNetUsdElement.classList.add(packNetProfitLossUsd >= 0 ? 'text-green-400' : 'text-red-400');
            }

            if(designPackRoiDailyElement) {
                designPackRoiDailyElement.textContent = formatPercent(packRoiDailyPercent, 4);
                designPackRoiDailyElement.classList.remove('text-green-400', 'text-red-400', 'text-pink-400');
                designPackRoiDailyElement.classList.add(packRoiDailyPercent >= 0 ? 'text-green-400' : 'text-red-400');
            }

            if(designPackRoiDaysElement) designPackRoiDaysElement.textContent = (packRoiDays === Infinity) ? '--' : formatUnits(packRoiDays);
            
            if(designPackCashBackUsdElement) designPackCashBackUsdElement.textContent = formatUSD(cbUsd, 2);
            if(designPackCashBackWaxElement) designPackCashBackWaxElement.textContent = formatWAX(cbWax, 0);
            if(designPackPriceWaxElement) designPackPriceWaxElement.textContent = formatWAX(pricePackWax, 0);

        };

        // --------------------------------------------------------------------------
        // --- LOGIQUE BATIMENTS ---
        // --------------------------------------------------------------------------
        const updateBuildingTable = (tokenPrices) => {
             const { newPriceDovX, newPriceCostToken, priceWaxUsd } = tokenPrices;
             
             // MAJ du Header avec les taux
             if(section9RatesDisplay) {
                 section9RatesDisplay.textContent = `(Taux: 1 DOVX = ${formatWAX(newPriceDovX, 6)} | 1 WAX = ${formatUSD(priceWaxUsd, 2)})`;
             }

             // Mise √† jour de chaque ligne du tableau
             BUILDING_DATA.forEach((building, index) => {
                 // 1. Co√ªt Horaire DOVX * 24 * Prix DOVX = Co√ªt Journalier WAX (OpEx)
                 const hourlyCostDovx = building.dovxCost;
                 const dailyCostWax = hourlyCostDovx * 24 * newPriceDovX;

                 // 2. Revenu Journalier WAX (Vente Prod)
                 const dailyProdTu = building.prodPerHour * 24;
                 const dailyRevenueWax = dailyProdTu * newPriceCostToken;

                 // 3. Marge Nette WAX (Revenu - Co√ªt)
                 const dailyMarginWax = dailyRevenueWax - dailyCostWax;

                 // 4. Projection Mensuelle USD
                 const dailyMarginUsd = dailyMarginWax * priceWaxUsd;
                 const monthlyMarginUsd = dailyMarginUsd * 30;
                 
                 
                 // MAJ DOM
                 const costEl = document.querySelector(`.building-cost-wax[data-index="${index}"]`);
                 const revEl = document.querySelector(`.building-revenue-wax[data-index="${index}"]`);
                 const marginWaxEl = document.querySelector(`.building-margin-wax[data-index="${index}"]`);
                 const revUsdMonthlyEl = document.querySelector(`.building-revenue-usd-monthly[data-index="${index}"]`);
                 
                 if(costEl) costEl.textContent = formatWAX(dailyCostWax, 4);
                 if(revEl) revEl.textContent = formatWAX(dailyRevenueWax, 4);
                 if(marginWaxEl) {
                     marginWaxEl.textContent = formatWAX(dailyMarginWax, 4);
                     marginWaxEl.classList.remove('text-green-400', 'text-red-400');
                     marginWaxEl.classList.add(dailyMarginWax >= 0 ? 'text-green-400' : 'text-red-400');
                 }
                 if(revUsdMonthlyEl) {
                     revUsdMonthlyEl.textContent = formatUSD(monthlyMarginUsd, 2);
                     revUsdMonthlyEl.classList.remove('text-green-400', 'text-red-400');
                     revUsdMonthlyEl.classList.add(monthlyMarginUsd >= 0 ? 'text-green-400' : 'text-red-400');
                 }
             });
             
             updateBuildingTotals();
             
             // IMPORTANT : Mettre √† jour la section Wallet si des donn√©es sont pr√©sentes
             if(scannedWalletData.length > 0) {
                calculateWalletEarnings(tokenPrices);
             }

             // IMPORTANT : Calculer le Pack B√¢timent (Section 11)
             calculateBuildingPackResults(tokenPrices);
        };
        
        const updateBuildingTotals = () => {
             // R√©cup√®re les prix actuels (hacky mais √©vite de repasser tout en param√®tre ici)
             const sliderValue = parseInt(dovxPriceSlider.value);
             const newPriceDovX = sliderValue / DOVX_SLIDER_SCALER;
             const newPriceCostToken = newPriceDovX * COST_DOVX_RATIO;
             const priceWaxUsd = parseFrenchFloat(priceWaxUsdInput.value);
             
             let totalDailyTu = 0;
             let totalDailyRevWax = 0;
             let totalDailyMarginWax = 0;
             let totalMonthlyMarginUsd = 0;
             
             document.querySelectorAll('.building-qty').forEach((input, index) => {
                 const qty = parseInt(input.value) || 0;
                 if (qty > 0) {
                     const building = BUILDING_DATA[index];
                     
                     // Recalcul local pour le total (identique √† updateBuildingTable)
                     const hourlyCostDovx = building.dovxCost;
                     const dailyCostWax = hourlyCostDovx * 24 * newPriceDovX;
                     
                     const dailyProdTu = building.prodPerHour * 24;
                     const dailyRevenueWax = dailyProdTu * newPriceCostToken;
                     
                     const dailyMarginWax = dailyRevenueWax - dailyCostWax;
                     const monthlyMarginUsd = dailyMarginWax * priceWaxUsd * 30;
                     
                     totalDailyTu += dailyProdTu * qty;
                     totalDailyRevWax += dailyRevenueWax * qty;
                     totalDailyMarginWax += dailyMarginWax * qty;
                     totalMonthlyMarginUsd += monthlyMarginUsd * qty;
                 }
             });
             
             if(userTotalTuDailyEl) userTotalTuDailyEl.textContent = formatUnits(totalDailyTu);
             if(userTotalRevenueWaxEl) userTotalRevenueWaxEl.textContent = formatWAX(totalDailyRevWax, 4);
             
             if(userTotalMarginWaxEl) {
                 userTotalMarginWaxEl.textContent = formatWAX(totalDailyMarginWax, 4);
                 userTotalMarginWaxEl.classList.remove('text-green-400', 'text-red-400');
                 userTotalMarginWaxEl.classList.add(totalDailyMarginWax >= 0 ? 'text-green-400' : 'text-red-400');
             }

             if(userTotalRevenueUsdMonthlyEl) {
                 userTotalRevenueUsdMonthlyEl.textContent = formatUSD(totalMonthlyMarginUsd, 2);
                 userTotalRevenueUsdMonthlyEl.classList.remove('text-green-400', 'text-red-400');
                 userTotalRevenueUsdMonthlyEl.classList.add(totalMonthlyMarginUsd >= 0 ? 'text-green-400' : 'text-red-400');
             }
        };

        // --------------------------------------------------------------------------
        // --- LOGIQUE SECTION 10: WALLET SCANNER (REAL API) ---
        // --------------------------------------------------------------------------
        
        // Fonction r√©elle API AtomicAssets
        const fetchWalletAssets = async (walletName) => {
            // Liste de endpoints pour la redondance
            const endpoints = ATOMIC_ENDPOINTS;

            // Param√®tres communs
            let queryParams = `?owner=${walletName}&page=1&limit=1000`;
             // Filtre par collection si d√©fini
            if (TARGET_COLLECTION_NAME && TARGET_COLLECTION_NAME.trim() !== "") {
                queryParams += `&collection_name=${TARGET_COLLECTION_NAME}`;
            }
             // Filtre par schema si d√©fini (cat√©gorie)
            if (TARGET_SCHEMA_NAME && TARGET_SCHEMA_NAME.trim() !== "") {
                queryParams += `&schema_name=${TARGET_SCHEMA_NAME}`;
            }

            // Boucle de tentative sur les diff√©rents n≈ìuds
            for (let i = 0; i < endpoints.length; i++) {
                const endpoint = endpoints[i];
                const url = `${endpoint}${queryParams}`;

                try {
                    console.log(`Tentative de connexion au n≈ìud ${i + 1}/${endpoints.length}: ${endpoint}`);
                    const response = await fetch(url, { method: 'GET', mode: 'cors' });

                    if (!response.ok) {
                         // Si c'est une 429 ou 500, on continue, sinon on arr√™te peut-√™tre ?
                         // Dans le doute, on log et on essaie le suivant
                        console.warn(`Erreur n≈ìud ${endpoint}: ${response.status} ${response.statusText}`);
                        continue;
                    }

                    const data = await response.json();
                    
                    if (!data.success) {
                        console.warn(`API Error sur ${endpoint}:`, data.message);
                        continue;
                    }

                    // Si on arrive ici, c'est que √ßa a march√© !
                    console.log("Succ√®s de r√©cup√©ration des donn√©es !");
                    
                    // Traitement des donn√©es
                    const assets = data.data;
                    const inventory = {}; 

                    assets.forEach(asset => {
                        let name = asset.data?.name;
                        if (!name && asset.template && asset.template.immutable_data) {
                            name = asset.template.immutable_data.name;
                        }
                        if (!name) {
                            name = asset.name;
                        }
                        if (name) {
                            name = name.trim();
                            inventory[name] = (inventory[name] || 0) + 1;
                        }
                    });

                    const result = Object.keys(inventory).map(key => ({
                        name: key,
                        qty: inventory[key]
                    }));

                    console.log("Inventaire consolid√©:", result);
                    return result;

                } catch (error) {
                    console.warn(`√âchec de connexion au n≈ìud ${endpoint}:`, error);
                    // On continue √† la prochaine it√©ration de la boucle
                }
            }
            
            // Si on sort de la boucle sans avoir retourn√©, c'est que tout a √©chou√©
            alert("Impossible de contacter l'API WAX. Tous les n≈ìuds publics semblent inaccessibles ou bloqu√©s par votre r√©seau. \nEssayez de d√©sactiver votre VPN ou AdBlock.");
            return [];
        };

        const calculateWalletEarnings = (tokenPrices) => {
            if (!scannedWalletData || scannedWalletData.length === 0) return;

            const { newPriceDovX, newPriceCostToken, priceWaxUsd } = tokenPrices;
            let totalBuildings = 0;
            let totalMonthlyWax = 0;
            let totalMonthlyUsd = 0;
            let rowsHtml = '';
            
            console.log("--- D√©but du calcul des gains Wallet ---");

            scannedWalletData.forEach(asset => {
                // Trouver les stats du batiment dans notre base de donn√©es
                const buildingStats = BUILDING_DATA.find(b => b.technicalName === asset.name || b.name === asset.name);

                if (buildingStats) {
                    console.log(`Correspondance trouv√©e: ${asset.name} -> ${buildingStats.name}`);
                    
                    // Calculs (identiques au tableau Section 9)
                    const hourlyCostDovx = buildingStats.dovxCost;
                    const dailyCostWax = hourlyCostDovx * 24 * newPriceDovX;
                    const dailyProdTu = buildingStats.prodPerHour * 24;
                    const dailyRevenueWax = dailyProdTu * newPriceCostToken;
                    const dailyMarginWax = dailyRevenueWax - dailyCostWax;
                    const monthlyMarginWax = dailyMarginWax * 30;
                    const monthlyMarginUsd = monthlyMarginWax * priceWaxUsd;
                    
                    // Totaux du portefeuille
                    const assetTotalMonthlyUsd = monthlyMarginUsd * asset.qty;
                    const assetTotalMonthlyWax = monthlyMarginWax * asset.qty;

                    totalBuildings += asset.qty;
                    totalMonthlyWax += assetTotalMonthlyWax;
                    totalMonthlyUsd += assetTotalMonthlyUsd;

                    rowsHtml += `
                        <tr class="hover:bg-gray-800/30 transition-colors">
                            <td class="p-3">
                                <span class="font-medium text-cyan-200">${buildingStats.name}</span>
                                <span class="text-xs text-gray-500 block">ID: ${asset.name}</span>
                                <span class="text-xs text-gray-400 block">ROI: ${formatUSD(monthlyMarginUsd, 2)}/mois</span>
                            </td>
                            <td class="p-3 text-center font-bold text-gray-300">${asset.qty}</td>
                            <td class="p-3 text-right text-green-400 font-bold text-lg">${formatUSD(assetTotalMonthlyUsd, 2)}</td>
                        </tr>
                    `;
                } else {
                     // Optionnel: Afficher les items non reconnus pour debug
                     console.log("Item non reconnu dans le simulateur (ignor√©):", asset.name);
                }
            });
            
            if (rowsHtml === '') {
                rowsHtml = `<tr><td colspan="3" class="p-4 text-center text-gray-500 italic">Aucun b√¢timent compatible trouv√©.<br>Le scanner cherche des cartes nomm√©es comme "C_F1_PRODUCER_SUPPLY".<br>(V√©rifiez la console F12 pour voir les noms trouv√©s).</td></tr>`;
            }

            // Mise √† jour du DOM
            walletAssetsBody.innerHTML = rowsHtml;
            walletTotalBuildingsEl.textContent = totalBuildings;
            walletMonthlyWaxEl.textContent = formatWAX(totalMonthlyWax, 2);
            walletMonthlyUsdEl.textContent = formatUSD(totalMonthlyUsd, 2);
            walletResultsContainer.classList.remove('hidden');
        };

        btnScanWallet.addEventListener('click', async () => {
            const wallet = walletAddressInput.value.trim();
            if (!wallet) return alert("Veuillez entrer une adresse WAX.");

            // UI Loading state
            btnScanWallet.textContent = "Scan en cours...";
            btnScanWallet.classList.add('opacity-75', 'cursor-wait');
            
            // Appel API REEL
            scannedWalletData = await fetchWalletAssets(wallet);
            
            // R√©cup√©ration des prix actuels pour le calcul
            const sliderValue = parseInt(dovxPriceSlider.value);
            const newPriceDovX = sliderValue / DOVX_SLIDER_SCALER;
            const newPriceCostToken = newPriceDovX * COST_DOVX_RATIO;
            const priceWaxUsd = parseFrenchFloat(priceWaxUsdInput.value);

            calculateWalletEarnings({ newPriceDovX, newPriceCostToken, priceWaxUsd });

            // Reset UI
            btnScanWallet.textContent = "Scanner le Portefeuille";
            btnScanWallet.classList.remove('opacity-75', 'cursor-wait');
        });

        // --------------------------------------------------------------------------
        // --- LOGIQUE SECTION 11: CALCULATEUR DE PACK BATIMENT (NEW) ---
        // --------------------------------------------------------------------------
        const calculateBuildingPackResults = (tokenPrices) => {
            const { newPriceDovX, newPriceCostToken, priceWaxUsd } = tokenPrices;

            const selectedIndex = parseInt(packBuildingSelect.value);
            const building = BUILDING_DATA[selectedIndex];
            const qty = Math.max(1, parseInt(packBuildingQtyInput.value) || 1);
            const multiplier = Math.max(0, parseFloat(packToolMultiplierInput.value) || 1);
            const pricePackUsd = parseFloat(packBuildingPriceInput.value) || 0;

            if (!building) return;

            // 1. Prod
            const baseDailyProd = building.prodPerHour * 24 * qty;
            const totalDailyProd = baseDailyProd * multiplier;

            // 2. Revenue (Production vendue au prix TU)
            const dailyRevenueWax = totalDailyProd * newPriceCostToken;
            
            // 3. OpEx (Co√ªt Op√©rationnel en DOVX)
            // Le co√ªt ne change pas avec le multiplicateur, il d√©pend du nombre de batiments
            const hourlyCostDovx = building.dovxCost;
            const dailyCostDovx = hourlyCostDovx * 24 * qty;
            const dailyOpExWax = dailyCostDovx * newPriceDovX;

            // 4. Marge Nette
            const dailyNetWax = dailyRevenueWax - dailyOpExWax;
            const dailyNetUsd = dailyNetWax * priceWaxUsd;
            const monthlyNetUsd = dailyNetUsd * 30;

            // 5. ROI
            let roiDays = Infinity;
            if (dailyNetUsd > 0 && pricePackUsd > 0) {
                roiDays = pricePackUsd / dailyNetUsd;
            } else if (pricePackUsd === 0 && dailyNetUsd > 0) {
                roiDays = 0; // Gratuit et rentable
            }

            const roiPercentMonthly = (pricePackUsd > 0) ? (monthlyNetUsd / pricePackUsd) : 0;

            // --- UI Update ---
            if(packBuildingProdEl) packBuildingProdEl.textContent = formatUnits(totalDailyProd) + ' TU';
            if(packBuildingProdBaseEl) packBuildingProdBaseEl.textContent = `Base: ${formatUnits(baseDailyProd)} TU (x${multiplier})`;
            
            if(packBuildingOpExEl) packBuildingOpExEl.textContent = formatWAX(dailyOpExWax, 4);
            
            if(packBuildingMonthlyNetEl) {
                packBuildingMonthlyNetEl.textContent = formatUSD(monthlyNetUsd, 2);
                packBuildingMonthlyNetEl.classList.remove('text-emerald-400', 'text-red-400');
                packBuildingMonthlyNetEl.classList.add(monthlyNetUsd >= 0 ? 'text-emerald-400' : 'text-red-400');
            }

            if(packBuildingRoiEl) {
                 if (roiDays === Infinity && dailyNetUsd <= 0) {
                     packBuildingRoiEl.textContent = "Non Rentable";
                     packBuildingRoiEl.classList.add('text-red-400');
                 } else {
                     packBuildingRoiEl.textContent = formatPercent(roiPercentMonthly, 2) + " / mois";
                     packBuildingRoiEl.classList.remove('text-red-400');
                     packBuildingRoiEl.classList.add('text-yellow-400');
                 }
            }

            if(packBuildingRoiDaysEl) {
                if(roiDays === Infinity) packBuildingRoiDaysEl.textContent = "-- Jours";
                else packBuildingRoiDaysEl.textContent = formatUnits(roiDays) + " Jours pour ROI";
            }
        };


        // --------------------------------------------------------------------------
        // --- LOGIQUE DE CALCUL DU VOLUME (Sections 1 √† 7) ---
        // --------------------------------------------------------------------------
        const calculate = () => {
            const selectedIndex = parseInt(zoneSelector.value);
            const selectedZone = ZONE_DATA[selectedIndex];

            // 1. Lecture des param√®tres de base
            const priceWaxUsd = parseFrenchFloat(priceWaxUsdInput.value);
            const numberOfAccounts = Math.max(1, parseInt(numberOfAccountsInput.value) || 1); 
            const divisionsPerAccount = Math.max(1, parseInt(divisionsPerAccountInput.value) || 1);
            
            // Param√®tres Packs/ROI (Volume)
            const numberOfPacks = Math.max(0, parseInt(numberOfPacksInput.value) || 0); 
            const divisionsPerPack = Math.max(0, parseInt(divisionsPerPackInput.value) || 0); // R√©utilis√© pour le pack design
            
            const totalDivisionsPurchased = numberOfPacks * divisionsPerPack;
            if(document.getElementById('resultTotalDivisionsPurchased')) document.getElementById('resultTotalDivisionsPurchased').textContent = formatUnits(totalDivisionsPurchased);
            
            const pricePerPackUsdInputVal = parseFrenchFloat(pricePerPackUsdInput.value);
            
            let pricePerPackWax = 0;
            if (priceWaxUsd > 0 && !isNaN(pricePerPackUsdInputVal)) {
                pricePerPackWax = pricePerPackUsdInputVal / priceWaxUsd;
            }

            if(document.getElementById('pricePerPackWax')) document.getElementById('pricePerPackWax').value = pricePerPackWax.toLocaleString('fr-FR', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            }); 
            
            const totalInvestmentWAX = numberOfPacks * pricePerPackWax;
            const totalInvestmentUSD = numberOfPacks * pricePerPackUsdInputVal;


            // 2. D√©termination des prix des jetons
            const sliderValue = parseInt(dovxPriceSlider.value);
            const newPriceDovX = sliderValue / DOVX_SLIDER_SCALER; 
            const newPriceCostToken = newPriceDovX * COST_DOVX_RATIO; 

            // Mise √† jour de l'affichage des prix des tokens
            if(document.getElementById('priceDovX')) document.getElementById('priceDovX').value = newPriceDovX.toLocaleString('fr-FR', { minimumFractionDigits: 8, maximumFractionDigits: 8 });
            if(document.getElementById('priceCostToken')) document.getElementById('priceCostToken').value = newPriceCostToken.toLocaleString('fr-FR', { minimumFractionDigits: 8, maximumFractionDigits: 8 });
            if(sliderValueDisplay) sliderValueDisplay.textContent = formatPriceDisplay(sliderValue);

            const tokenPrices = { newPriceDovX, newPriceCostToken, priceWaxUsd };

            // APPEL √Ä LA LOGIQUE DU PACK DESIGN (Section 8)
            calculatePackDesign(tokenPrices);
            
            // APPEL √Ä LA LOGIQUE DES BATIMENTS (Section 9) + WALLET (10) + PACK BATIMENT (11)
            updateBuildingTable(tokenPrices);
            
            // --- Calculs du Volume (Sections 2-7) ---
            
            // Si l'une des valeurs n√©cessaires au calcul du VOLUME est invalide, on sort
            if (!selectedZone || isNaN(newPriceDovX) || isNaN(newPriceCostToken) || isNaN(priceWaxUsd)) {
                document.querySelectorAll('.result-value').forEach(el => el.textContent = '--');
                if(document.getElementById('consumptionTableBody')) document.getElementById('consumptionTableBody').innerHTML = '';
                // R√©initialisation des totaux du volume
                if(document.getElementById('totalInvestmentUsdDisplay')) document.getElementById('totalInvestmentUsdDisplay').textContent = '--';
                if(document.getElementById('totalInvestmentWaxDisplay')) document.getElementById('totalInvestmentWaxDisplay').textContent = '--';
                if(document.getElementById('cashBackUsd')) document.getElementById('cashBackUsd').textContent = '--';
                if(document.getElementById('cashBackWax')) document.getElementById('cashBackWax').textContent = '--';
                if(document.getElementById('teamUsd')) document.getElementById('teamUsd').textContent = '--';
                if(document.getElementById('teamWax')) document.getElementById('teamWax').textContent = '--';
                if(document.getElementById('marketTokenUsd')) document.getElementById('marketTokenUsd').textContent = '--';
                if(document.getElementById('marketTokenWax')) document.getElementById('marketTokenWax').textContent = '--';
                if(document.getElementById('pubUsd')) document.getElementById('pubUsd').textContent = '--';
                if(document.getElementById('pubWax')) document.getElementById('pubWax').textContent = '--';
                return;
            }

            const totalMultiplier = numberOfAccounts * divisionsPerAccount;
            
            // Calculs pour UNE SEULE division (base)
            const unitsCostPerTokenBase = selectedZone.totalTuCost / 4;
            const unitsDovX = selectedZone.dovxReward;

            const singleDivisionWaxCost = selectedZone.totalTuCost * newPriceCostToken; 
            const singleDivisionWaxReward = unitsDovX * newPriceDovX; 
            
            // Application au Volume Total (WAX)
            const totalWaxCost = singleDivisionWaxCost * totalMultiplier;
            const totalWaxReward = singleDivisionWaxReward * totalMultiplier;
            
            const netProfitLoss = totalWaxReward - totalWaxCost; 
            const totalVolume = totalWaxCost + totalWaxReward; 

            // Conversion USD
            const totalUsdCost = totalWaxCost * priceWaxUsd;
            const totalUsdReward = totalWaxReward * priceWaxUsd;
            const netUsdProfitLoss = netProfitLoss * priceWaxUsd; 
            const totalUsdVolume = totalVolume * priceWaxUsd; 

            // Calculs Mensuels & Annuels
            const monthlyUsdVolume = totalUsdVolume * DAYS_IN_MONTH;
            const annualUsdVolume = totalUsdVolume * DAYS_IN_YEAR;
            const monthlyNetUsdProfitLoss = netUsdProfitLoss * DAYS_IN_MONTH;
            const annualNetUsdProfitLoss = netUsdProfitLoss * DAYS_IN_YEAR;
            
            // Calculs de l'Investissement et ROI
            let roiDays = Infinity;
            let roiStatus = 'Non Applicable (Pas d\'investissement)';
            let roiDailyPercent = 0;
            
            if (totalInvestmentWAX > 0) {
                roiDailyPercent = netProfitLoss / totalInvestmentWAX;
                
                if (netProfitLoss > 0) {
                    roiDays = totalInvestmentWAX / netProfitLoss;
                    roiStatus = `ROI estim√© en ${formatUnits(roiDays)} jours`;
                } else if (netProfitLoss < 0) {
                    roiStatus = 'D√©ficit : ROI impossible';
                } else {
                    roiStatus = 'Marge Nulle : ROI impossible';
                }
            } else {
                roiStatus = 'Non Applicable (Pas d\'investissement)';
            }
            
            const roiMonthlyPercent = roiDailyPercent * DAYS_IN_MONTH;

            // Indicateurs Strat√©giques
            const ratioAmplification = unitsDovX / unitsCostPerTokenBase;
            
            // NOUVEAUX CALCULS TU TOTAUX
            const totalTuUnitsConsumedDaily = selectedZone.totalTuCost * totalMultiplier;
            const totalWaxCostDailyCalculated = totalTuUnitsConsumedDaily * newPriceCostToken;

            // CALCULS DE LA SECTION 7 (R√©partition des Ventes du Volume)
            const cbUsd = totalInvestmentUSD * CASH_BACK_PERCENT;
            const cbWax = totalInvestmentWAX * CASH_BACK_PERCENT;
            const tmUsd = totalInvestmentUSD * TEAM_PERCENT;
            const tmWax = totalInvestmentWAX * TEAM_PERCENT;
            const mtUsd = totalInvestmentUSD * MARKET_TOKEN_PERCENT;
            const mtWax = totalInvestmentWAX * MARKET_TOKEN_PERCENT;
            const pbUsd = totalInvestmentUSD * PUB_PERCENT;
            const pbWax = totalInvestmentWAX * PUB_PERCENT;


            // --- Affichage des R√©sultats WAX (24h) ---
            if(document.getElementById('totalWaxCostValue')) document.getElementById('totalWaxCostValue').textContent = formatWAX(totalWaxCost, 4);
            if(document.getElementById('unitCostWaxValue')) document.getElementById('unitCostWaxValue').textContent = `"Unitaire TU: ${formatWAX(newPriceCostToken, 8)}"`; 
            if(document.getElementById('resultReward')) document.getElementById('resultReward').textContent = formatWAX(totalWaxReward, 4);
            if(document.getElementById('resultVolume')) document.getElementById('resultVolume').textContent = formatWAX(totalVolume, 4);
            
            const netElement = document.getElementById('resultNet');
            if(netElement) {
                netElement.textContent = formatWAX(netProfitLoss, 4);
                netElement.classList.remove('text-green-400', 'text-red-400');
                netElement.classList.add(netProfitLoss >= 0 ? 'text-green-400' : 'text-red-400');
            }

            // --- Affichage des R√©sultats USD (24h) ---
            if(document.getElementById('resultUsdCost')) document.getElementById('resultUsdCost').textContent = formatUSD(totalUsdCost, 4);
            if(document.getElementById('resultUsdReward')) document.getElementById('resultUsdReward').textContent = formatUSD(totalUsdReward, 4);
            if(document.getElementById('resultUsdVolume')) document.getElementById('resultUsdVolume').textContent = formatUSD(totalUsdVolume, 4);

            const netUsdElement = document.getElementById('resultNetUsd');
            if(netUsdElement) {
                netUsdElement.textContent = formatUSD(netUsdProfitLoss, 4);
                netUsdElement.classList.remove('text-green-400', 'text-red-400');
                netUsdElement.classList.add(netUsdProfitLoss >= 0 ? 'text-green-400' : 'text-red-400');
            }
            
            // --- Affichage des R√©sultats USD (Mensuel & Annuel) ---
            if(document.getElementById('resultUsdVolumeMonthly')) document.getElementById('resultUsdVolumeMonthly').textContent = formatUSD(monthlyUsdVolume, 2);
            if(document.getElementById('resultUsdVolumeAnnual')) document.getElementById('resultUsdVolumeAnnual').textContent = formatUSD(annualUsdVolume, 2);
            
            const netUsdMonthlyElement = document.getElementById('resultNetUsdMonthly');
            if(netUsdMonthlyElement) {
                netUsdMonthlyElement.textContent = formatUSD(monthlyNetUsdProfitLoss, 2);
                netUsdMonthlyElement.classList.remove('text-green-400', 'text-red-400');
                netUsdMonthlyElement.classList.add(monthlyNetUsdProfitLoss >= 0 ? 'text-green-400' : 'text-red-400');
            }
            
            const netUsdAnnualElement = document.getElementById('resultNetUsdAnnual');
            if(netUsdAnnualElement) {
                netUsdAnnualElement.textContent = formatUSD(annualNetUsdProfitLoss, 2);
                netUsdAnnualElement.classList.remove('text-green-400', 'text-red-400');
                netUsdAnnualElement.classList.add(annualNetUsdProfitLoss >= 0 ? 'text-green-400' : 'text-red-400');
            }
            
            // --- Affichage des R√©sultats ROI (Volume) ---
            if(document.getElementById('resultTotalInvestment')) document.getElementById('resultTotalInvestment').textContent = formatWAX(totalInvestmentWAX, 0);

            const roiDailyPercentElement = document.getElementById('resultRoiDailyPercent');
            if(roiDailyPercentElement) {
                roiDailyPercentElement.textContent = formatPercent(roiDailyPercent, 4);
                roiDailyPercentElement.classList.remove('text-green-400', 'text-red-400');
                roiDailyPercentElement.classList.add(roiDailyPercent >= 0 ? 'text-green-400' : 'text-red-400');
            }
            
            const roiMonthlyPercentElement = document.getElementById('resultRoiMonthlyPercent');
            if(roiMonthlyPercentElement) {
                roiMonthlyPercentElement.textContent = formatPercent(roiMonthlyPercent, 2);
                roiMonthlyPercentElement.classList.remove('text-green-400', 'text-red-400');
                roiMonthlyPercentElement.classList.add(roiMonthlyPercent >= 0 ? 'text-green-400' : 'text-red-400');
            }

            if(document.getElementById('resultRoiDays')) document.getElementById('resultRoiDays').textContent = (roiDays === Infinity) ? '--' : formatUnits(roiDays);
            
            const roiStatusElement = document.getElementById('resultRoiStatus');
            if(roiStatusElement) {
                roiStatusElement.textContent = roiStatus;
                roiStatusElement.classList.remove('text-green-400', 'text-red-400', 'text-lime-400', 'text-gray-400');
                if (roiDays !== Infinity && netProfitLoss > 0) {
                    roiStatusElement.classList.add('text-green-400');
                } else if (netProfitLoss < 0) {
                    roiStatusElement.classList.add('text-red-400');
                } else if (totalInvestmentWAX > 0) {
                     roiStatusElement.classList.add('text-lime-400'); 
                } else {
                     roiStatusElement.classList.add('text-gray-400'); 
                }
            }

            // --- Mise √† jour de la Section 6: Consommation Nominale des Jetons de Co√ªt ---
            let html = '';
            let totalWaxCostBase = 0;
            let totalUnitsConsumedDailySum = 0;

            for (const token of COST_TOKENS) {
                const waxCostPerToken = unitsCostPerTokenBase * newPriceCostToken;
                const totalDailyUnits = unitsCostPerTokenBase * totalMultiplier; 

                totalWaxCostBase += waxCostPerToken;
                totalUnitsConsumedDailySum += totalDailyUnits;

                html += `
                    <tr class="hover:bg-gray-800/60">
                        <td class="p-3 font-semibold text-red-300">${token}</td>
                        <td class="p-3 text-right">${formatUnits(unitsCostPerTokenBase)} unit√©s</td>
                        <td class="p-3 text-right text-red-300 font-bold">${formatUnits(totalDailyUnits)} unit√©s</td>
                        <td class="p-3 text-right text-red-400">${formatWAX(waxCostPerToken, 6)}</td>
                    </tr>
                `;
            }

            if(document.getElementById('consumptionTableBody')) document.getElementById('consumptionTableBody').innerHTML = html;
            if(document.getElementById('totalUnitsConsumedBase')) document.getElementById('totalUnitsConsumedBase').textContent = formatUnits(selectedZone.totalTuCost) + ' unit√©s';
            if(document.getElementById('totalUnitsConsumedDailySum')) document.getElementById('totalUnitsConsumedDailySum').textContent = formatUnits(totalUnitsConsumedDailySum) + ' unit√©s'; 
            if(document.getElementById('totalWaxCostBase')) document.getElementById('totalWaxCostBase').textContent = formatWAX(totalWaxCostBase, 6);
            if(document.getElementById('totalUnitsConsumedDaily')) document.getElementById('totalUnitsConsumedDaily').textContent = formatUnits(totalTuUnitsConsumedDaily) + ' unit√©s';
            if(document.getElementById('totalWaxCostDaily')) document.getElementById('totalWaxCostDaily').textContent = formatWAX(totalWaxCostDailyCalculated, 4);

            if(document.getElementById('unitsDovXGenerated')) document.getElementById('unitsDovXGenerated').textContent = formatUnits(unitsDovX) + ' unit√©s';
            if(document.getElementById('ratioAmplification')) document.getElementById('ratioAmplification').textContent = ratioAmplification.toFixed(4) + 'x';
            
            // --- Affichage de la Section 7: R√©partition des Ventes du Volume ---
            if(document.getElementById('totalInvestmentUsdDisplay')) document.getElementById('totalInvestmentUsdDisplay').textContent = formatUSD(totalInvestmentUSD, 2);
            if(document.getElementById('totalInvestmentWaxDisplay')) document.getElementById('totalInvestmentWaxDisplay').textContent = formatWAX(totalInvestmentWAX, 0);
            
            if(document.getElementById('cashBackUsd')) document.getElementById('cashBackUsd').textContent = formatUSD(cbUsd, 2);
            if(document.getElementById('cashBackWax')) document.getElementById('cashBackWax').textContent = formatWAX(cbWax, 0);

            if(document.getElementById('teamUsd')) document.getElementById('teamUsd').textContent = formatUSD(tmUsd, 2);
            if(document.getElementById('teamWax')) document.getElementById('teamWax').textContent = formatWAX(tmWax, 0);

            if(document.getElementById('marketTokenUsd')) document.getElementById('marketTokenUsd').textContent = formatUSD(mtUsd, 2);
            if(document.getElementById('marketTokenWax')) document.getElementById('marketTokenWax').textContent = formatWAX(mtWax, 0);

            if(document.getElementById('pubUsd')) document.getElementById('pubUsd').textContent = formatUSD(pbUsd, 2);
            if(document.getElementById('pubWax')) document.getElementById('pubWax').textContent = formatWAX(pbWax, 0);
        };

        // --- FONCTIONS IA ---
        
        // Fonction g√©n√©rique pour appeler Gemini
        async function callGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Erreur Gemini:", error);
                return "Erreur de communication avec l'IA. V√©rifiez votre connexion.";
            }
        }

        // Handler pour le Conseiller Strat√©gique
        btnAiAdvisor.addEventListener('click', async () => {
            const outputDiv = document.getElementById('aiAdvisorOutput');
            const btn = document.getElementById('btnAiAdvisor');
            
            // UI Loading
            outputDiv.classList.remove('hidden');
            outputDiv.innerHTML = "Analyse des flux financiers en cours...";
            btn.classList.add('ai-loading');
            btn.disabled = true;

            // R√©cup√©ration des donn√©es du contexte
            const netMonthly = document.getElementById('resultNetUsdMonthly').textContent;
            const roiDays = document.getElementById('resultRoiDays').textContent;
            const investment = document.getElementById('resultTotalInvestment').textContent;
            const zone = document.getElementById('zoneSelector').options[document.getElementById('zoneSelector').selectedIndex].text;
            
            const prompt = `Tu es un conseiller √©conomique militaire impitoyable et sarcastique dans un univers de science-fiction (style Dawn of Victory). 
            Analyse ces donn√©es financi√®res d'un commandant :
            - Investissement Total : ${investment}
            - Marge Nette Mensuelle : ${netMonthly}
            - ROI estim√© en jours : ${roiDays}
            - Zone d'op√©ration : ${zone}
            
            Donne un avis tactique court (max 3 phrases). Si le ROI est bon, f√©licite-le. Si c'est mauvais (ROI > 300 jours ou d√©ficit), sois critique.`;

            const text = await callGemini(prompt);
            
            // UI Result
            outputDiv.innerHTML = text;
            btn.classList.remove('ai-loading');
            btn.disabled = false;
        });

        // Handler pour le Lore de Pack
        btnAiLore.addEventListener('click', async () => {
            const outputDiv = document.getElementById('aiLoreOutput');
            const btn = document.getElementById('btnAiLore');
            
            outputDiv.classList.remove('hidden');
            outputDiv.innerHTML = "G√©n√©ration de la description...";
            btn.disabled = true;

            const packName = packNameInput.value;
            const composition = packCompositionInput.value;

            const prompt = `Tu es un officier de l'intendance de Dawn of Victory. √âcris une courte description (max 40 mots) pour un pack de ravitaillement nomm√© "${packName}".
            Contenu : ${composition}. 
            Le ton doit √™tre militaire, sci-fi et √©pique.`;

            const text = await callGemini(prompt);
            
            outputDiv.innerHTML = `"${text}"`;
            btn.disabled = false;
        });

        // √âv√©nements (√©coute de tous les changements d'entr√©e pour recalculer)
        const inputsToWatch = [
            zoneSelector, packDesignZoneSelector, dovxPriceSlider, priceWaxUsdInput, 
            numberOfAccountsInput, divisionsPerAccountInput, numberOfPacksInput, 
            divisionsPerPackInput, pricePerPackUsdInput, packDesignPriceUsdInput,
            packBuildingSelect, packBuildingQtyInput, packToolMultiplierInput, packBuildingPriceInput // New inputs
        ];

        inputsToWatch.forEach(input => {
            if(input) input.addEventListener('input', calculate); // Check if input exists (Section 11 elements)
        });

        // Lancement initial au chargement
        window.onload = function() {
            initializeSliderDisplay();
            initializeBuildingTable(); // Init du tableau de batiments
            calculate();
        };

    </script>
</body>
</html>
